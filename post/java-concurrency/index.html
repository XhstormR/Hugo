<!doctype html><html lang=zh-cn manifest=https://blog.xhstormr.tk/offline.appcache><head><meta charset=utf-8><meta name=renderer content="webkit"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>Java Concurrency &#183; XhstormR</title><link rel=alternate type=application/rss+xml title=XhstormR href><link rel=icon type=image/x-icon href=https://blog.xhstormr.tk/favicon.ico><link rel=stylesheet href=https://blog.xhstormr.tk/css/uno.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/styles/monokai-sublime.min.css><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js></script><script src=https://blog.xhstormr.tk/js/main.min.js async defer></script></head><body><div id=scriptHeader><span class="mobile btn-mobile-menu"><i class="fa fa-bars btn-mobile-menu__icon"></i>
<i class="fa fa-times btn-mobile-close__icon hidden"></i></span><header class="panel-cover panel-cover--collapsed"><div class=panel-main><div class="panel-main__inner panel-inverted"><div class=panel-main__content><h1 class="panel-cover__title panel-title"><a href=https://blog.xhstormr.tk/ title="link to homepage for XhstormR">XhstormR</a></h1><hr class=panel-cover__divider><p class=panel-cover__description>On a dark desert highway, cool wind in my hair.</p><hr class="panel-cover__divider panel-cover__divider--secondary"><div class=navigation-wrapper><nav class="cover-navigation cover-navigation--primary"><ul class=navigation><li class=navigation__item><a href=https://blog.xhstormr.tk#blog title="link to XhstormR blog" class=blog-button>Blog</a></li></ul></nav></div></div></div><div class=panel-cover--overlay></div></div></header></div><div class=bodytop><div class=content-wrapper><div class=content-wrapper__inner><div class=post><h1>Java Concurrency</h1><span class=post-date>2017-07-16</span><p>Updated on 2017-07-29</p><blockquote><p style=text-align:center><img data-src=/uploads/java-concurrency1.svg alt title=Executor data-action=zoom width></p><script>[].forEach.call(document.querySelectorAll("img[data-src]"),function(a){a.setAttribute("src",a.getAttribute("data-src")),a.onload=function(){a.removeAttribute("data-src")}})</script><ul><li></li></ul><p style=text-align:center><img data-src=/uploads/java-concurrency2.svg alt title=Future data-action=zoom width></p><script>[].forEach.call(document.querySelectorAll("img[data-src]"),function(a){a.setAttribute("src",a.getAttribute("data-src")),a.onload=function(){a.removeAttribute("data-src")}})</script><ul><li></li></ul><p style=text-align:center><img data-src=/uploads/java-concurrency3.svg alt title=Queue data-action=zoom width></p><script>[].forEach.call(document.querySelectorAll("img[data-src]"),function(a){a.setAttribute("src",a.getAttribute("data-src")),a.onload=function(){a.removeAttribute("data-src")}})</script><ul><li></li></ul><p style=text-align:center><img data-src=/uploads/java-concurrency4.svg alt title data-action=zoom width></p><script>[].forEach.call(document.querySelectorAll("img[data-src]"),function(a){a.setAttribute("src",a.getAttribute("data-src")),a.onload=function(){a.removeAttribute("data-src")}})</script><ul><li></li></ul><p><a href=https://docs.oracle.com/javase/10/docs/api/java/util/concurrent/package-summary.html>https://docs.oracle.com/javase/10/docs/api/java/util/concurrent</a>
|
<a href=http://download.java.net/jdk/jdk-api-localizations/jdk-api-zh-cn/publish/1.6.0/html/zh_CN/api/java/util/concurrent/package-summary.html>中文</a></p></blockquote><h2 id=concept>Concept</h2><ul><li>串行：多个线程 <strong>按照顺序</strong> 使用同一个核心。（单核心）（Serial）</li><li>并发：多个线程 <strong>共同轮流</strong> 使用同一个核心。（单核心）（线程 <strong>同时存在</strong>）（Concurrent）</li><li>并行：多个线程 <strong>各自分别</strong> 使用　一个核心。（多核心）（线程 <strong>同时执行</strong>）（Parallel）<ul><li>并行是并发的一个 <strong>子集</strong>，区别在于 CPU 是否为多核心。</li></ul></li></ul><hr><ul><li><code>Blocking　</code>：　阻塞并发，内部使用 <strong>锁</strong>。</li><li><code>Concurrent</code>：非阻塞并发，内部使用 <strong>CAS 操作</strong>。</li></ul><h2 id=code>Code</h2><h3 id=线程体>线程体</h3><h4 id=无返回值runnable>无返回值：Runnable</h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>import</span> java.util.concurrent.TimeUnit<span style=color:#f92672>;</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Action</span> <span style=color:#66d9ef>implements</span> Runnable <span style=color:#f92672>{</span>
    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>     方法签名无返回值<span style=color:#960050;background-color:#1e0010>，</span>无检查异常
        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
            TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>SECONDS</span><span style=color:#f92672>.</span><span style=color:#a6e22e>sleep</span><span style=color:#f92672>(</span>1<span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InterruptedException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
        <span style=color:#f92672>}</span>
        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Action Done&#34;</span><span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><h4 id=有返回值callable>有返回值：Callable</h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>import</span> java.util.concurrent.Callable<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.TimeUnit<span style=color:#f92672>;</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Task</span> <span style=color:#66d9ef>implements</span> Callable<span style=color:#f92672>&lt;</span>Integer<span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>
    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> Integer <span style=color:#a6e22e>call</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> Exception <span style=color:#f92672>{</span>     方法签名有返回值<span style=color:#960050;background-color:#1e0010>，</span>有检查异常
        TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>SECONDS</span><span style=color:#f92672>.</span><span style=color:#a6e22e>sleep</span><span style=color:#f92672>(</span>1<span style=color:#f92672>);</span>
        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Task Done&#34;</span><span style=color:#f92672>);</span>
        <span style=color:#66d9ef>return</span> 9527<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><h3 id=线程池>线程池</h3><h4 id=threadpoolexecutor>ThreadPoolExecutor</h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>import</span> java.util.concurrent.ExecutionException<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.ExecutorService<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.Executors<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.Future<span style=color:#f92672>;</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Main</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> ExecutionException<span style=color:#f92672>,</span> InterruptedException <span style=color:#f92672>{</span>
        ExecutorService executorService <span style=color:#f92672>=</span> Executors<span style=color:#f92672>.</span><span style=color:#a6e22e>newCachedThreadPool</span><span style=color:#f92672>();</span>     创建线程池

                                 executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Action<span style=color:#f92672>());</span>    执行 Runnable 对象<span style=color:#960050;background-color:#1e0010>，</span>无返回值
        Future<span style=color:#f92672>&lt;</span>Integer<span style=color:#f92672>&gt;</span> future <span style=color:#f92672>=</span> executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>submit</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Task<span style=color:#f92672>());</span>      执行 Callable 对象<span style=color:#960050;background-color:#1e0010>，</span>有返回值

        executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>shutdown</span><span style=color:#f92672>();</span>     停止接收线程体<span style=color:#960050;background-color:#1e0010>，</span>并等待执行中的线程结束<span style=color:#960050;background-color:#1e0010>（</span>不阻塞当前线程<span style=color:#960050;background-color:#1e0010>）</span>

        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>future<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>());</span>     获得异步执行的结果<span style=color:#960050;background-color:#1e0010>（</span>若运算未完成<span style=color:#960050;background-color:#1e0010>，</span>则阻塞当前线程<span style=color:#960050;background-color:#1e0010>）</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>

Note<span style=color:#960050;background-color:#1e0010>：</span>
<span style=color:#66d9ef>int</span>        corePoolSize<span style=color:#960050;background-color:#1e0010>：</span>线程池的最小线程数
<span style=color:#66d9ef>int</span>     maximumPoolSize<span style=color:#960050;background-color:#1e0010>：</span>线程池的最大线程数
<span style=color:#66d9ef>long</span>      keepAliveTime<span style=color:#960050;background-color:#1e0010>：</span>空闲线程的生存时间
TimeUnit       timeUnit<span style=color:#960050;background-color:#1e0010>：</span>指示时间参数的单位
BlockingQueue workQueue<span style=color:#960050;background-color:#1e0010>：</span>存储等待执行的任务

变种<span style=color:#960050;background-color:#1e0010>：</span>
newSingleThreadExecutor<span style=color:#960050;background-color:#1e0010>：</span>所有线程串行执行
     newFixedThreadPool<span style=color:#960050;background-color:#1e0010>：</span>最多 n 个线程并发执行
    newCachedThreadPool<span style=color:#960050;background-color:#1e0010>：</span>所有线程并发执行
</code></pre></div><h4 id=scheduledthreadpoolexecutor>ScheduledThreadPoolExecutor</h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>import</span> java.time.Instant<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.Date<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.Executors<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.ScheduledExecutorService<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.ScheduledFuture<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.TimeUnit<span style=color:#f92672>;</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Main</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        ScheduledExecutorService scheduledExecutorService <span style=color:#f92672>=</span> Executors<span style=color:#f92672>.</span><span style=color:#a6e22e>newScheduledThreadPool</span><span style=color:#f92672>(</span>2<span style=color:#f92672>);</span>

        ScheduledFuture<span style=color:#f92672>&lt;?&gt;</span> scheduledFuture <span style=color:#f92672>=</span> scheduledExecutorService<span style=color:#f92672>.</span><span style=color:#a6e22e>scheduleAtFixedRate</span><span style=color:#f92672>(()</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
            System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>Date<span style=color:#f92672>.</span><span style=color:#a6e22e>from</span><span style=color:#f92672>(</span>Instant<span style=color:#f92672>.</span><span style=color:#a6e22e>now</span><span style=color:#f92672>()));</span>
        <span style=color:#f92672>},</span> 1<span style=color:#f92672>,</span> 1<span style=color:#f92672>,</span> TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>SECONDS</span><span style=color:#f92672>);</span>     重复执行<span style=color:#960050;background-color:#1e0010>：</span>每隔 1 秒执行

        scheduledExecutorService<span style=color:#f92672>.</span><span style=color:#a6e22e>schedule</span><span style=color:#f92672>(()</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
            scheduledFuture<span style=color:#f92672>.</span><span style=color:#a6e22e>cancel</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>     取消任务
            scheduledExecutorService<span style=color:#f92672>.</span><span style=color:#a6e22e>shutdown</span><span style=color:#f92672>();</span>     关闭线程池
        <span style=color:#f92672>},</span> 5<span style=color:#f92672>,</span> TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>SECONDS</span><span style=color:#f92672>);</span>     延期执行<span style=color:#960050;background-color:#1e0010>：</span>5 秒后执行
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
<span style=color:#f92672>----</span>
输出<span style=color:#960050;background-color:#1e0010>：</span>
Fri Jul 21 15<span style=color:#f92672>:</span>55<span style=color:#f92672>:</span>53 CST 2017
Fri Jul 21 15<span style=color:#f92672>:</span>55<span style=color:#f92672>:</span>54 CST 2017
Fri Jul 21 15<span style=color:#f92672>:</span>55<span style=color:#f92672>:</span>55 CST 2017
Fri Jul 21 15<span style=color:#f92672>:</span>55<span style=color:#f92672>:</span>56 CST 2017
Fri Jul 21 15<span style=color:#f92672>:</span>55<span style=color:#f92672>:</span>57 CST 2017

重复执行<span style=color:#960050;background-color:#1e0010>：</span>
scheduleAtFixedRate       任务开始时计时
scheduleWithFixedDelay    任务结束时计时

TimeUnit<span style=color:#960050;background-color:#1e0010>：</span>
 NANOSECONDS<span style=color:#960050;background-color:#1e0010>：</span>纳秒<span style=color:#960050;background-color:#1e0010>：</span>1000
MICROSECONDS<span style=color:#960050;background-color:#1e0010>：</span>微秒<span style=color:#960050;background-color:#1e0010>：</span>1000
MILLISECONDS<span style=color:#960050;background-color:#1e0010>：</span>毫秒<span style=color:#960050;background-color:#1e0010>：</span>1000
     SECONDS<span style=color:#960050;background-color:#1e0010>：</span>一秒<span style=color:#960050;background-color:#1e0010>：</span>60
     MINUTES<span style=color:#960050;background-color:#1e0010>：</span>一分<span style=color:#960050;background-color:#1e0010>：</span>60
       HOURS<span style=color:#960050;background-color:#1e0010>：</span>一时<span style=color:#960050;background-color:#1e0010>：</span>24
        DAYS<span style=color:#960050;background-color:#1e0010>：</span>一天
</code></pre></div><h4 id=executorcompletionservice>ExecutorCompletionService</h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>import</span> java.util.concurrent.*<span style=color:#f92672>;</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Main</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> ExecutionException<span style=color:#f92672>,</span> InterruptedException <span style=color:#f92672>{</span>
        ExecutorService executorService <span style=color:#f92672>=</span> Executors<span style=color:#f92672>.</span><span style=color:#a6e22e>newCachedThreadPool</span><span style=color:#f92672>();</span>
        CompletionService<span style=color:#f92672>&lt;</span>Integer<span style=color:#f92672>&gt;</span> completionService <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ExecutorCompletionService<span style=color:#f92672>&lt;&gt;(</span>executorService<span style=color:#f92672>);</span>     按照完成任务的先后顺序<span style=color:#960050;background-color:#1e0010>，</span>依次将结果存入内部队列

        <span style=color:#a6e22e>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> n <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> n <span style=color:#f92672>&lt;</span> 3<span style=color:#f92672>;</span> n<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
            completionService<span style=color:#f92672>.</span><span style=color:#a6e22e>submit</span><span style=color:#f92672>(()</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> ThreadLocalRandom<span style=color:#f92672>.</span><span style=color:#a6e22e>current</span><span style=color:#f92672>().</span><span style=color:#a6e22e>nextInt</span><span style=color:#f92672>(</span>5<span style=color:#f92672>);</span>     随机数生成器<span style=color:#960050;background-color:#1e0010>（</span>本地线程<span style=color:#960050;background-color:#1e0010>）</span>
                TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>SECONDS</span><span style=color:#f92672>.</span><span style=color:#a6e22e>sleep</span><span style=color:#f92672>(</span>i<span style=color:#f92672>);</span>
                <span style=color:#66d9ef>return</span> i<span style=color:#f92672>;</span>
            <span style=color:#f92672>});</span>
        <span style=color:#f92672>}</span>

        executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>shutdown</span><span style=color:#f92672>();</span>

        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> n <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> n <span style=color:#f92672>&lt;</span> 3<span style=color:#f92672>;</span> n<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
            Future<span style=color:#f92672>&lt;</span>Integer<span style=color:#f92672>&gt;</span> future <span style=color:#f92672>=</span> completionService<span style=color:#f92672>.</span><span style=color:#a6e22e>take</span><span style=color:#f92672>();</span>     从内部队列中依次取出结果并移除<span style=color:#960050;background-color:#1e0010>（</span>若没有结果<span style=color:#960050;background-color:#1e0010>，</span>则阻塞当前线程<span style=color:#960050;background-color:#1e0010>）</span>
            System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>future<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>());</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
<span style=color:#f92672>----</span>
输出<span style=color:#960050;background-color:#1e0010>：</span>
0
1
4
</code></pre></div><h4 id=forkjoinpool并行框架>ForkJoinPool（并行框架）</h4><ul><li>主要用于 <strong>计算密集型</strong> 的任务，适合 <strong>任务分而治之</strong> 且 <strong>函数递归调用</strong> 的算法。</li></ul><h5 id=无返回值recursiveaction>无返回值：RecursiveAction</h5><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>import</span> java.util.concurrent.ForkJoinTask<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.RecursiveAction<span style=color:#f92672>;</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ComputeAction</span> <span style=color:#66d9ef>extends</span> RecursiveAction <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> THRESHOLD <span style=color:#f92672>=</span> 200<span style=color:#f92672>;</span>     影响任务个数
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>double</span><span style=color:#f92672>[]</span> array<span style=color:#f92672>;</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> from<span style=color:#f92672>,</span> to<span style=color:#f92672>;</span>

    ComputeAction<span style=color:#f92672>(</span><span style=color:#66d9ef>double</span><span style=color:#f92672>[]</span> array<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> from<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> to<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>array</span> <span style=color:#f92672>=</span> array<span style=color:#f92672>;</span>
        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>from</span> <span style=color:#f92672>=</span> from<span style=color:#f92672>;</span>
        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>to</span> <span style=color:#f92672>=</span> to<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>compute</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>to <span style=color:#f92672>-</span> from <span style=color:#f92672>&lt;</span> THRESHOLD<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>     当需要计算的资源小于阈值时<span style=color:#960050;background-color:#1e0010>，</span>进行计算
            <span style=color:#a6e22e>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> from<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> to<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
                array<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> Math<span style=color:#f92672>.</span><span style=color:#a6e22e>sin</span><span style=color:#f92672>(</span>array<span style=color:#f92672>[</span>i<span style=color:#f92672>])</span> <span style=color:#f92672>+</span> Math<span style=color:#f92672>.</span><span style=color:#a6e22e>cos</span><span style=color:#f92672>(</span>array<span style=color:#f92672>[</span>i<span style=color:#f92672>])</span> <span style=color:#f92672>+</span> Math<span style=color:#f92672>.</span><span style=color:#a6e22e>tan</span><span style=color:#f92672>(</span>array<span style=color:#f92672>[</span>i<span style=color:#f92672>]);</span>
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>     否则<span style=color:#960050;background-color:#1e0010>，</span>把任务一分为二<span style=color:#960050;background-color:#1e0010>，</span>进行递归
            <span style=color:#66d9ef>int</span> mid <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>from <span style=color:#f92672>+</span> to<span style=color:#f92672>)</span> <span style=color:#f92672>&gt;&gt;&gt;</span> 1<span style=color:#f92672>;</span>
            ComputeAction l <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ComputeAction<span style=color:#f92672>(</span>array<span style=color:#f92672>,</span> from<span style=color:#f92672>,</span> mid<span style=color:#f92672>);</span>
            ComputeAction r <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ComputeAction<span style=color:#f92672>(</span>array<span style=color:#f92672>,</span> mid<span style=color:#f92672>,</span> to<span style=color:#f92672>);</span>
            ForkJoinTask<span style=color:#f92672>.</span><span style=color:#a6e22e>invokeAll</span><span style=color:#f92672>(</span>l<span style=color:#f92672>,</span> r<span style=color:#f92672>);</span>     阻塞
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><h5 id=有返回值recursivetask>有返回值：RecursiveTask</h5><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>import</span> java.util.concurrent.ForkJoinTask<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.RecursiveTask<span style=color:#f92672>;</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FindTask</span> <span style=color:#66d9ef>extends</span> RecursiveTask<span style=color:#f92672>&lt;</span>Double<span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> THRESHOLD <span style=color:#f92672>=</span> 200<span style=color:#f92672>;</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>double</span><span style=color:#f92672>[]</span> array<span style=color:#f92672>;</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> from<span style=color:#f92672>,</span> to<span style=color:#f92672>;</span>

    FindTask<span style=color:#f92672>(</span><span style=color:#66d9ef>double</span><span style=color:#f92672>[]</span> array<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> from<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> to<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>array</span> <span style=color:#f92672>=</span> array<span style=color:#f92672>;</span>
        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>from</span> <span style=color:#f92672>=</span> from<span style=color:#f92672>;</span>
        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>to</span> <span style=color:#f92672>=</span> to<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>protected</span> Double <span style=color:#a6e22e>compute</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>to <span style=color:#f92672>-</span> from <span style=color:#f92672>&lt;</span> THRESHOLD<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>double</span> max <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
            <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> from<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> to<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
                max <span style=color:#f92672>=</span> Math<span style=color:#f92672>.</span><span style=color:#a6e22e>max</span><span style=color:#f92672>(</span>max<span style=color:#f92672>,</span> array<span style=color:#f92672>[</span>i<span style=color:#f92672>]);</span>
            <span style=color:#f92672>}</span>
            <span style=color:#66d9ef>return</span> max<span style=color:#f92672>;</span>
        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>int</span> mid <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>from <span style=color:#f92672>+</span> to<span style=color:#f92672>)</span> <span style=color:#f92672>&gt;&gt;&gt;</span> 1<span style=color:#f92672>;</span>
            FindTask l <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> FindTask<span style=color:#f92672>(</span>array<span style=color:#f92672>,</span> from<span style=color:#f92672>,</span> mid<span style=color:#f92672>);</span>
            FindTask r <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> FindTask<span style=color:#f92672>(</span>array<span style=color:#f92672>,</span> mid<span style=color:#f92672>,</span> to<span style=color:#f92672>);</span>
            ForkJoinTask<span style=color:#f92672>.</span><span style=color:#a6e22e>invokeAll</span><span style=color:#f92672>(</span>l<span style=color:#f92672>,</span> r<span style=color:#f92672>);</span>
            <span style=color:#66d9ef>return</span> Math<span style=color:#f92672>.</span><span style=color:#a6e22e>max</span><span style=color:#f92672>(</span>l<span style=color:#f92672>.</span><span style=color:#a6e22e>join</span><span style=color:#f92672>(),</span> r<span style=color:#f92672>.</span><span style=color:#a6e22e>join</span><span style=color:#f92672>());</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><h5 id=main>Main</h5><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>import</span> java.util.concurrent.ForkJoinPool<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.ThreadLocalRandom<span style=color:#f92672>;</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Main</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>double</span><span style=color:#f92672>[]</span> array <span style=color:#f92672>=</span> ThreadLocalRandom<span style=color:#f92672>.</span><span style=color:#a6e22e>current</span><span style=color:#f92672>().</span><span style=color:#a6e22e>doubles</span><span style=color:#f92672>(</span>1000000<span style=color:#f92672>).</span><span style=color:#a6e22e>toArray</span><span style=color:#f92672>();</span>     生成随机数组

        ForkJoinPool forkJoinPool <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ForkJoinPool<span style=color:#f92672>();</span>

                        forkJoinPool<span style=color:#f92672>.</span><span style=color:#a6e22e>invoke</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> ComputeAction<span style=color:#f92672>(</span>array<span style=color:#f92672>,</span> 0<span style=color:#f92672>,</span> array<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>));</span>  执行 RecursiveAction 对象<span style=color:#960050;background-color:#1e0010>，</span>无返回值<span style=color:#960050;background-color:#1e0010>（</span>阻塞<span style=color:#960050;background-color:#1e0010>）</span>
        Double result <span style=color:#f92672>=</span> forkJoinPool<span style=color:#f92672>.</span><span style=color:#a6e22e>invoke</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> FindTask<span style=color:#f92672>(</span>array<span style=color:#f92672>,</span> 0<span style=color:#f92672>,</span> array<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>));</span>       执行 RecursiveTask   对象<span style=color:#960050;background-color:#1e0010>，</span>有返回值<span style=color:#960050;background-color:#1e0010>（</span>阻塞<span style=color:#960050;background-color:#1e0010>）</span>

        forkJoinPool<span style=color:#f92672>.</span><span style=color:#a6e22e>shutdown</span><span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>

ForkJoinPool<span style=color:#f92672>.</span><span style=color:#a6e22e>commonPool</span><span style=color:#f92672>()</span> 的并行度默认减 1
</code></pre></div><h3 id=并发队列>并发队列</h3><h4 id=arrayblockingqueue>ArrayBlockingQueue</h4><ul><li><strong>先入先出</strong> 队列，内部实现为数组，支持 <strong>公平访问策略</strong>。</li></ul><h4 id=linkedblockingqueue>LinkedBlockingQueue</h4><ul><li><strong>先入先出</strong> 队列，内部实现为链表。</li><li>生产者-消费者实现：<ul><li>生产者向队列 <strong>添加元素</strong>：当队列 <strong>已满</strong> 时，生产者会被阻塞；</li><li>消费者从队列 <strong>移除元素</strong>：当队列 <strong>为空</strong> 时，消费者会被阻塞。</li></ul></li></ul><h5 id=producer>Producer</h5><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>import</span> java.util.concurrent.BlockingQueue<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.TimeUnit<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.atomic.AtomicInteger<span style=color:#f92672>;</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Producer</span> <span style=color:#66d9ef>implements</span> Runnable <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>static</span> AtomicInteger productID <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> AtomicInteger<span style=color:#f92672>();</span>     原子 <span style=color:#66d9ef>int</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> BlockingQueue<span style=color:#f92672>&lt;</span>Integer<span style=color:#f92672>&gt;</span> queue<span style=color:#f92672>;</span>

    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Producer</span><span style=color:#f92672>(</span>BlockingQueue<span style=color:#f92672>&lt;</span>Integer<span style=color:#f92672>&gt;</span> queue<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>queue</span> <span style=color:#f92672>=</span> queue<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> 10<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
                TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>MILLISECONDS</span><span style=color:#f92672>.</span><span style=color:#a6e22e>sleep</span><span style=color:#f92672>(</span>25<span style=color:#f92672>);</span>
                <span style=color:#66d9ef>int</span> id <span style=color:#f92672>=</span> productID<span style=color:#f92672>.</span><span style=color:#a6e22e>getAndIncrement</span><span style=color:#f92672>();</span>
                queue<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>id<span style=color:#f92672>);</span>     队列满时阻塞
                System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;生产:&#34;</span> <span style=color:#f92672>+</span> id<span style=color:#f92672>);</span>
            <span style=color:#f92672>}</span>
            queue<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(-</span>1<span style=color:#f92672>);</span>     队列满时阻塞
            System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;生产结束&#34;</span><span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InterruptedException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><h5 id=consumer>Consumer</h5><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>import</span> java.util.concurrent.BlockingQueue<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.TimeUnit<span style=color:#f92672>;</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Consumer</span> <span style=color:#66d9ef>implements</span> Runnable <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> BlockingQueue<span style=color:#f92672>&lt;</span>Integer<span style=color:#f92672>&gt;</span> queue<span style=color:#f92672>;</span>

    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Consumer</span><span style=color:#f92672>(</span>BlockingQueue<span style=color:#f92672>&lt;</span>Integer<span style=color:#f92672>&gt;</span> queue<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>queue</span> <span style=color:#f92672>=</span> queue<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>int</span> i<span style=color:#f92672>;</span>
            <span style=color:#66d9ef>while</span> <span style=color:#f92672>((</span>i <span style=color:#f92672>=</span> queue<span style=color:#f92672>.</span><span style=color:#a6e22e>take</span><span style=color:#f92672>())</span> <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>     队列空时阻塞
                TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>MILLISECONDS</span><span style=color:#f92672>.</span><span style=color:#a6e22e>sleep</span><span style=color:#f92672>(</span>50<span style=color:#f92672>);</span>
                System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;消费:&#34;</span> <span style=color:#f92672>+</span> i<span style=color:#f92672>);</span>
            <span style=color:#f92672>}</span>
            System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;消费结束&#34;</span><span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InterruptedException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><h5 id=main-1>Main</h5><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>import</span> java.util.concurrent.BlockingQueue<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.ExecutorService<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.Executors<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.LinkedBlockingQueue<span style=color:#f92672>;</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Main</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        BlockingQueue<span style=color:#f92672>&lt;</span>Integer<span style=color:#f92672>&gt;</span> queue <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LinkedBlockingQueue<span style=color:#f92672>&lt;&gt;(</span>10<span style=color:#f92672>);</span>     指定队列容量为 10
        ExecutorService executorService <span style=color:#f92672>=</span> Executors<span style=color:#f92672>.</span><span style=color:#a6e22e>newCachedThreadPool</span><span style=color:#f92672>();</span>
        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> 5<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
            executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Producer<span style=color:#f92672>(</span>queue<span style=color:#f92672>));</span>
            executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Consumer<span style=color:#f92672>(</span>queue<span style=color:#f92672>));</span>
        <span style=color:#f92672>}</span>
        executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>shutdown</span><span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><h4 id=priorityblockingqueue>PriorityBlockingQueue</h4><ul><li>队列中的元素会 <strong>根据给定规则进行排序</strong>。</li></ul><h4 id=delayqueue>DelayQueue</h4><ul><li>队列内部持有一个 PriorityBlockingQueue，用于存储元素并 <strong>根据延迟时间进行排序</strong>。</li><li>队列中的元素需要 <strong>实现 Delayed 接口</strong>。<ul><li><code>getDelay</code> 方法用于获取剩余延迟。</li><li><code>compareTo</code> 方法对元素进行比较。</li></ul></li></ul><h5 id=delayobject>DelayObject</h5><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>import</span> java.util.concurrent.Delayed<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.TimeUnit<span style=color:#f92672>;</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DelayObject</span> <span style=color:#66d9ef>implements</span> Delayed <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>static</span> TimeUnit TIME_UNIT <span style=color:#f92672>=</span> TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>MILLISECONDS</span><span style=color:#f92672>;</span>     内部计时单位
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>long</span> delay<span style=color:#f92672>;</span>      延迟时间
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>long</span> submit<span style=color:#f92672>;</span>     提交时间
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>long</span> expired<span style=color:#f92672>;</span>    到期时间

    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>DelayObject</span><span style=color:#f92672>(</span><span style=color:#66d9ef>long</span> delay<span style=color:#f92672>,</span> TimeUnit unit<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>delay</span> <span style=color:#f92672>=</span> TIME_UNIT<span style=color:#f92672>.</span><span style=color:#a6e22e>convert</span><span style=color:#f92672>(</span>delay<span style=color:#f92672>,</span> unit<span style=color:#f92672>);</span>
        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>submit</span> <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>();</span>
        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>expired</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>submit</span> <span style=color:#f92672>+</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>delay</span><span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>long</span> <span style=color:#a6e22e>getDelay</span><span style=color:#f92672>(</span>TimeUnit unit<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> unit<span style=color:#f92672>.</span><span style=color:#a6e22e>convert</span><span style=color:#f92672>(</span>expired <span style=color:#f92672>-</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>(),</span> TIME_UNIT<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>compareTo</span><span style=color:#f92672>(</span>Delayed o<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>long</span> l1 <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getDelay</span><span style=color:#f92672>(</span>TIME_UNIT<span style=color:#f92672>);</span>
        <span style=color:#66d9ef>long</span> l2 <span style=color:#f92672>=</span> o<span style=color:#f92672>.</span><span style=color:#a6e22e>getDelay</span><span style=color:#f92672>(</span>TIME_UNIT<span style=color:#f92672>);</span>
        <span style=color:#66d9ef>return</span> Long<span style=color:#f92672>.</span><span style=color:#a6e22e>compare</span><span style=color:#f92672>(</span>l1<span style=color:#f92672>,</span> l2<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>toString</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;DelayObject{&#34;</span> <span style=color:#f92672>+</span>
                <span style=color:#e6db74>&#34;submit=&#34;</span> <span style=color:#f92672>+</span> submit <span style=color:#f92672>+</span>
                <span style=color:#e6db74>&#34;, expired=&#34;</span> <span style=color:#f92672>+</span> expired <span style=color:#f92672>+</span>
                <span style=color:#e6db74>&#34;, delay=&#34;</span> <span style=color:#f92672>+</span> delay <span style=color:#f92672>+</span>
                <span style=color:#e6db74>&#39;}&#39;</span><span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><h5 id=main-2>Main</h5><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>import</span> java.util.concurrent.DelayQueue<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.TimeUnit<span style=color:#f92672>;</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Main</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> InterruptedException <span style=color:#f92672>{</span>
        DelayQueue<span style=color:#f92672>&lt;</span>DelayObject<span style=color:#f92672>&gt;</span> queue <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> DelayQueue<span style=color:#f92672>&lt;&gt;();</span>
        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> 5<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
            queue<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> DelayObject<span style=color:#f92672>(</span>i<span style=color:#f92672>,</span> TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>SECONDS</span><span style=color:#f92672>));</span>
        <span style=color:#f92672>}</span>
        <span style=color:#66d9ef>while</span> <span style=color:#f92672>(!</span>queue<span style=color:#f92672>.</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
            System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>queue<span style=color:#f92672>.</span><span style=color:#a6e22e>take</span><span style=color:#f92672>());</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
<span style=color:#f92672>----</span>
输出<span style=color:#960050;background-color:#1e0010>：</span>
DelayObject<span style=color:#f92672>{</span>submit<span style=color:#f92672>=</span>1501135689170<span style=color:#f92672>,</span> expired<span style=color:#f92672>=</span>1501135689170<span style=color:#f92672>,</span> delay<span style=color:#f92672>=</span>0<span style=color:#f92672>}</span>
DelayObject<span style=color:#f92672>{</span>submit<span style=color:#f92672>=</span>1501135689170<span style=color:#f92672>,</span> expired<span style=color:#f92672>=</span>1501135690170<span style=color:#f92672>,</span> delay<span style=color:#f92672>=</span>1000<span style=color:#f92672>}</span>
DelayObject<span style=color:#f92672>{</span>submit<span style=color:#f92672>=</span>1501135689170<span style=color:#f92672>,</span> expired<span style=color:#f92672>=</span>1501135691170<span style=color:#f92672>,</span> delay<span style=color:#f92672>=</span>2000<span style=color:#f92672>}</span>
DelayObject<span style=color:#f92672>{</span>submit<span style=color:#f92672>=</span>1501135689170<span style=color:#f92672>,</span> expired<span style=color:#f92672>=</span>1501135692170<span style=color:#f92672>,</span> delay<span style=color:#f92672>=</span>3000<span style=color:#f92672>}</span>
DelayObject<span style=color:#f92672>{</span>submit<span style=color:#f92672>=</span>1501135689170<span style=color:#f92672>,</span> expired<span style=color:#f92672>=</span>1501135693170<span style=color:#f92672>,</span> delay<span style=color:#f92672>=</span>4000<span style=color:#f92672>}</span>
</code></pre></div><h4 id=synchronousqueue>SynchronousQueue</h4><ul><li>提供线程间进行 <strong>数据传递的场所</strong>，支持 <strong>公平访问策略</strong>。</li><li>调用其插入方法时，必须 <strong>等待另一个线程调用其移除方法</strong>，队列本身 <strong>不存储任何元素</strong>。</li></ul><h4 id=linkedtransferqueue推荐>LinkedTransferQueue（推荐）</h4><ul><li>SynchronousQueue、ConcurrentLinkedQueue、LinkedBlockingQueue 的超集。</li></ul><h5 id=producer-1>Producer</h5><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>import</span> java.util.concurrent.TransferQueue<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.atomic.AtomicInteger<span style=color:#f92672>;</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Producer</span> <span style=color:#66d9ef>implements</span> Runnable <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>static</span> AtomicInteger productID <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> AtomicInteger<span style=color:#f92672>();</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> TransferQueue<span style=color:#f92672>&lt;</span>Integer<span style=color:#f92672>&gt;</span> queue<span style=color:#f92672>;</span>

    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Producer</span><span style=color:#f92672>(</span>TransferQueue<span style=color:#f92672>&lt;</span>Integer<span style=color:#f92672>&gt;</span> queue<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>queue</span> <span style=color:#f92672>=</span> queue<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> 10<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>int</span> id <span style=color:#f92672>=</span> productID<span style=color:#f92672>.</span><span style=color:#a6e22e>getAndIncrement</span><span style=color:#f92672>();</span>
                queue<span style=color:#f92672>.</span><span style=color:#a6e22e>transfer</span><span style=color:#f92672>(</span>id<span style=color:#f92672>);</span>     等待另一个线程调用其移除方法
                System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;生产:&#34;</span> <span style=color:#f92672>+</span> id<span style=color:#f92672>);</span>
            <span style=color:#f92672>}</span>
            queue<span style=color:#f92672>.</span><span style=color:#a6e22e>transfer</span><span style=color:#f92672>(-</span>1<span style=color:#f92672>);</span>     等待另一个线程调用其移除方法
            System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;生产结束&#34;</span><span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InterruptedException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>

<span style=color:#66d9ef>void</span>       <span style=color:#a6e22e>transfer</span><span style=color:#f92672>(</span>E e<span style=color:#f92672>)</span>
<span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>tryTransfer</span><span style=color:#f92672>(</span>E e<span style=color:#f92672>)</span>
<span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>tryTransfer</span><span style=color:#f92672>(</span>E e<span style=color:#f92672>,</span> <span style=color:#66d9ef>long</span> timeout<span style=color:#f92672>,</span> TimeUnit unit<span style=color:#f92672>)</span>
<span style=color:#f92672>----</span>
若没有线程调用其移除方法<span style=color:#960050;background-color:#1e0010>，</span>则等待另一个线程调用其移除方法<span style=color:#960050;background-color:#1e0010>。</span>
若没有线程调用其移除方法<span style=color:#960050;background-color:#1e0010>，</span>一一一一一一一一一一一一一一则丢弃该元素<span style=color:#960050;background-color:#1e0010>，</span>并立即返回 <span style=color:#66d9ef>false</span><span style=color:#960050;background-color:#1e0010>。</span>
若没有线程调用其移除方法<span style=color:#960050;background-color:#1e0010>，</span>则在指定时间内等待<span style=color:#960050;background-color:#1e0010>；</span>若超时<span style=color:#960050;background-color:#1e0010>，</span>则丢弃该元素<span style=color:#960050;background-color:#1e0010>，</span>并立即返回 <span style=color:#66d9ef>false</span><span style=color:#960050;background-color:#1e0010>。</span>
</code></pre></div><h5 id=consumer-1>Consumer</h5><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>import</span> java.util.concurrent.TimeUnit<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.TransferQueue<span style=color:#f92672>;</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Consumer</span> <span style=color:#66d9ef>implements</span> Runnable <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> TransferQueue<span style=color:#f92672>&lt;</span>Integer<span style=color:#f92672>&gt;</span> queue<span style=color:#f92672>;</span>

    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Consumer</span><span style=color:#f92672>(</span>TransferQueue<span style=color:#f92672>&lt;</span>Integer<span style=color:#f92672>&gt;</span> queue<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>queue</span> <span style=color:#f92672>=</span> queue<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>int</span> i<span style=color:#f92672>;</span>
            <span style=color:#66d9ef>while</span> <span style=color:#f92672>((</span>i <span style=color:#f92672>=</span> queue<span style=color:#f92672>.</span><span style=color:#a6e22e>take</span><span style=color:#f92672>())</span> <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>SECONDS</span><span style=color:#f92672>.</span><span style=color:#a6e22e>sleep</span><span style=color:#f92672>(</span>1<span style=color:#f92672>);</span>
                System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;消费:&#34;</span> <span style=color:#f92672>+</span> i<span style=color:#f92672>);</span>
            <span style=color:#f92672>}</span>
            System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;消费结束&#34;</span><span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InterruptedException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><h5 id=main-3>Main</h5><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>import</span> java.util.concurrent.ExecutorService<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.Executors<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.LinkedTransferQueue<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.TransferQueue<span style=color:#f92672>;</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Main</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        TransferQueue<span style=color:#f92672>&lt;</span>Integer<span style=color:#f92672>&gt;</span> queue <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LinkedTransferQueue<span style=color:#f92672>&lt;&gt;();</span>
        ExecutorService executorService <span style=color:#f92672>=</span> Executors<span style=color:#f92672>.</span><span style=color:#a6e22e>newCachedThreadPool</span><span style=color:#f92672>();</span>
        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> 2<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
            executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Producer<span style=color:#f92672>(</span>queue<span style=color:#f92672>));</span>
            executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Consumer<span style=color:#f92672>(</span>queue<span style=color:#f92672>));</span>
        <span style=color:#f92672>}</span>
        executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>shutdown</span><span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
<span style=color:#f92672>----</span>
输出<span style=color:#960050;background-color:#1e0010>：</span>
生产:0
生产:1
消费:0
消费:1
生产:2
生产:3
消费:2
消费:3
生产:4
生产:5
消费:5
消费:4
<span style=color:#f92672>...</span>
生产:16
生产:17
消费:16
消费:17
生产:18
生产:19
消费:18
消费:19
消费结束
生产结束
生产结束
消费结束
</code></pre></div><h3 id=原子变量>原子变量</h3><ul><li>原子性 -> Unsafe 类 -> CAS 操作 -> cmpxchg 指令</li></ul><h4 id=基本数据类型atomicinteger>基本数据类型：AtomicInteger</h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>import</span> java.util.concurrent.ExecutorService<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.Executors<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.TimeUnit<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.atomic.AtomicInteger<span style=color:#f92672>;</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Main</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> InterruptedException <span style=color:#f92672>{</span>
        AtomicInteger i <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> AtomicInteger<span style=color:#f92672>();</span>

        ExecutorService executorService <span style=color:#f92672>=</span> Executors<span style=color:#f92672>.</span><span style=color:#a6e22e>newCachedThreadPool</span><span style=color:#f92672>();</span>
        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> n <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> n <span style=color:#f92672>&lt;</span> 5<span style=color:#f92672>;</span> n<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
            executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(()</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> j <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> j <span style=color:#f92672>&lt;</span> 1000<span style=color:#f92672>;</span> j<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
                    i<span style=color:#f92672>.</span><span style=color:#a6e22e>getAndIncrement</span><span style=color:#f92672>();</span>     原子操作
                <span style=color:#f92672>}</span>
            <span style=color:#f92672>});</span>
        <span style=color:#f92672>}</span>
        executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>shutdown</span><span style=color:#f92672>();</span>
        executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>awaitTermination</span><span style=color:#f92672>(</span>1<span style=color:#f92672>,</span> TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>DAYS</span><span style=color:#f92672>);</span>

        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>i<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>());</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
<span style=color:#f92672>----</span>
输出<span style=color:#960050;background-color:#1e0010>：</span>
5000
</code></pre></div><h4 id=引用数据类型atomicreference>引用数据类型：AtomicReference</h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>import</span> java.util.concurrent.ExecutorService<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.Executors<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.TimeUnit<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.atomic.AtomicReference<span style=color:#f92672>;</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Main</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> InterruptedException <span style=color:#f92672>{</span>
        AtomicReference<span style=color:#f92672>&lt;</span>Element<span style=color:#f92672>&gt;</span> reference <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> AtomicReference<span style=color:#f92672>&lt;&gt;(</span><span style=color:#66d9ef>new</span> Element<span style=color:#f92672>(</span>0<span style=color:#f92672>,</span> 0<span style=color:#f92672>));</span>

        ExecutorService executorService <span style=color:#f92672>=</span> Executors<span style=color:#f92672>.</span><span style=color:#a6e22e>newCachedThreadPool</span><span style=color:#f92672>();</span>
        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> n <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> n <span style=color:#f92672>&lt;</span> 5<span style=color:#f92672>;</span> n<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
            executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(()</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> j <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> j <span style=color:#f92672>&lt;</span> 1000<span style=color:#f92672>;</span> j<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
                    <span style=color:#66d9ef>boolean</span> flag <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
                    <span style=color:#66d9ef>while</span> <span style=color:#f92672>(!</span>flag<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>     自旋锁
                        Element oldElement <span style=color:#f92672>=</span> reference<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>();</span>
                        Element newElement <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Element<span style=color:#f92672>(</span>oldElement<span style=color:#f92672>.</span><span style=color:#a6e22e>x</span> <span style=color:#f92672>+</span> 1<span style=color:#f92672>,</span> oldElement<span style=color:#f92672>.</span><span style=color:#a6e22e>y</span> <span style=color:#f92672>+</span> 1<span style=color:#f92672>);</span>
                        flag <span style=color:#f92672>=</span> reference<span style=color:#f92672>.</span><span style=color:#a6e22e>compareAndSet</span><span style=color:#f92672>(</span>oldElement<span style=color:#f92672>,</span> newElement<span style=color:#f92672>);</span>     原子替换
                    <span style=color:#f92672>}</span>
                <span style=color:#f92672>}</span>
            <span style=color:#f92672>});</span>
        <span style=color:#f92672>}</span>
        executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>shutdown</span><span style=color:#f92672>();</span>
        executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>awaitTermination</span><span style=color:#f92672>(</span>1<span style=color:#f92672>,</span> TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>DAYS</span><span style=color:#f92672>);</span>

        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>reference<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>());</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
<span style=color:#f92672>----</span>
输出<span style=color:#960050;background-color:#1e0010>：</span>
Element<span style=color:#f92672>{</span>x<span style=color:#f92672>=</span>5000<span style=color:#f92672>,</span> y<span style=color:#f92672>=</span>5000<span style=color:#f92672>}</span>

<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Element</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> x<span style=color:#f92672>;</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> y<span style=color:#f92672>;</span>

    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Element</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> x<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> y<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>x</span> <span style=color:#f92672>=</span> x<span style=color:#f92672>;</span>
        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>y</span> <span style=color:#f92672>=</span> y<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>toString</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;Element{&#34;</span> <span style=color:#f92672>+</span>
                <span style=color:#e6db74>&#34;x=&#34;</span> <span style=color:#f92672>+</span> x <span style=color:#f92672>+</span>
                <span style=color:#e6db74>&#34;, y=&#34;</span> <span style=color:#f92672>+</span> y <span style=color:#f92672>+</span>
                <span style=color:#e6db74>&#39;}&#39;</span><span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><h4 id=属性原子更新atomicintegerfieldupdater>属性原子更新：AtomicIntegerFieldUpdater</h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>import</span> java.util.concurrent.ExecutorService<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.Executors<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.TimeUnit<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.atomic.AtomicIntegerFieldUpdater<span style=color:#f92672>;</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Main</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> InterruptedException <span style=color:#f92672>{</span>
        AtomicIntegerFieldUpdater<span style=color:#f92672>&lt;</span>Element<span style=color:#f92672>&gt;</span> fieldUpdater <span style=color:#f92672>=</span> AtomicIntegerFieldUpdater<span style=color:#f92672>.</span><span style=color:#a6e22e>newUpdater</span><span style=color:#f92672>(</span>Element<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;id&#34;</span><span style=color:#f92672>);</span>     内部使用反射
        Element element <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Element<span style=color:#f92672>(</span>0<span style=color:#f92672>);</span>

        ExecutorService executorService <span style=color:#f92672>=</span> Executors<span style=color:#f92672>.</span><span style=color:#a6e22e>newCachedThreadPool</span><span style=color:#f92672>();</span>
        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> n <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> n <span style=color:#f92672>&lt;</span> 5<span style=color:#f92672>;</span> n<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
            executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(()</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> j <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> j <span style=color:#f92672>&lt;</span> 1000<span style=color:#f92672>;</span> j<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
                    fieldUpdater<span style=color:#f92672>.</span><span style=color:#a6e22e>getAndIncrement</span><span style=color:#f92672>(</span>element<span style=color:#f92672>);</span>     原子更新属性
                <span style=color:#f92672>}</span>
            <span style=color:#f92672>});</span>
        <span style=color:#f92672>}</span>
        executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>shutdown</span><span style=color:#f92672>();</span>
        executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>awaitTermination</span><span style=color:#f92672>(</span>1<span style=color:#f92672>,</span> TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>DAYS</span><span style=color:#f92672>);</span>

        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>element<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
<span style=color:#f92672>----</span>
输出<span style=color:#960050;background-color:#1e0010>：</span>
Element<span style=color:#f92672>{</span>id<span style=color:#f92672>=</span>5000<span style=color:#f92672>}</span>

<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Element</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>volatile</span> <span style=color:#66d9ef>int</span> id<span style=color:#f92672>;</span>     应用原子更新的属性必须为 <span style=color:#66d9ef>volatile</span><span style=color:#960050;background-color:#1e0010>（</span>保证可见性<span style=color:#960050;background-color:#1e0010>）</span>

    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Element</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> id<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>id</span> <span style=color:#f92672>=</span> id<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>toString</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;Element{&#34;</span> <span style=color:#f92672>+</span>
                <span style=color:#e6db74>&#34;id=&#34;</span> <span style=color:#f92672>+</span> id <span style=color:#f92672>+</span>
                <span style=color:#e6db74>&#39;}&#39;</span><span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><h4 id=原子数组atomicintegerarray>　　原子数组：AtomicIntegerArray</h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>import</span> java.util.concurrent.ExecutorService<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.Executors<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.TimeUnit<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.atomic.AtomicIntegerArray<span style=color:#f92672>;</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Main</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> InterruptedException <span style=color:#f92672>{</span>
        AtomicIntegerArray ints <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> AtomicIntegerArray<span style=color:#f92672>(</span>5<span style=color:#f92672>);</span>
        ints<span style=color:#f92672>.</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span>0<span style=color:#f92672>,</span> 1<span style=color:#f92672>);</span>

        ExecutorService executorService <span style=color:#f92672>=</span> Executors<span style=color:#f92672>.</span><span style=color:#a6e22e>newCachedThreadPool</span><span style=color:#f92672>();</span>
        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> n <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> n <span style=color:#f92672>&lt;</span> 5<span style=color:#f92672>;</span> n<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
            executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(()</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> j <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> j <span style=color:#f92672>&lt;</span> 1000<span style=color:#f92672>;</span> j<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
                    ints<span style=color:#f92672>.</span><span style=color:#a6e22e>getAndIncrement</span><span style=color:#f92672>(</span>4<span style=color:#f92672>);</span>
                <span style=color:#f92672>}</span>
            <span style=color:#f92672>});</span>
        <span style=color:#f92672>}</span>
        executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>shutdown</span><span style=color:#f92672>();</span>
        executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>awaitTermination</span><span style=color:#f92672>(</span>1<span style=color:#f92672>,</span> TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>DAYS</span><span style=color:#f92672>);</span>

        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>ints<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
<span style=color:#f92672>----</span>
输出<span style=color:#960050;background-color:#1e0010>：</span>
<span style=color:#f92672>[</span>1<span style=color:#f92672>,</span> 0<span style=color:#f92672>,</span> 0<span style=color:#f92672>,</span> 0<span style=color:#f92672>,</span> 5000<span style=color:#f92672>]</span>
</code></pre></div><hr><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>import</span> java.util.concurrent.ExecutorService<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.Executors<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.TimeUnit<span style=color:#f92672>;</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Main</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> InterruptedException <span style=color:#f92672>{</span>
        ExecutorService executorService <span style=color:#f92672>=</span> Executors<span style=color:#f92672>.</span><span style=color:#a6e22e>newCachedThreadPool</span><span style=color:#f92672>();</span>

        executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(()</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
                TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>SECONDS</span><span style=color:#f92672>.</span><span style=color:#a6e22e>sleep</span><span style=color:#f92672>(</span>1<span style=color:#f92672>);</span>
            <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InterruptedException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
            <span style=color:#f92672>}</span>
            System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Action Done&#34;</span><span style=color:#f92672>);</span>
        <span style=color:#f92672>});</span>

        executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>shutdown</span><span style=color:#f92672>();</span>     停止接收线程体<span style=color:#960050;background-color:#1e0010>，</span>并等待执行中的线程结束<span style=color:#960050;background-color:#1e0010>（</span>不阻塞当前线程<span style=color:#960050;background-color:#1e0010>）</span>

        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>isShutdown</span><span style=color:#f92672>());</span>
        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>isTerminated</span><span style=color:#f92672>());</span>

        executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>awaitTermination</span><span style=color:#f92672>(</span>1<span style=color:#f92672>,</span> TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>DAYS</span><span style=color:#f92672>);</span>     阻塞当前线程<span style=color:#960050;background-color:#1e0010>，</span>等待执行中的线程结束

        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>isShutdown</span><span style=color:#f92672>());</span>
        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>isTerminated</span><span style=color:#f92672>());</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
<span style=color:#f92672>----</span>
输出<span style=color:#960050;background-color:#1e0010>：</span>
<span style=color:#66d9ef>true</span>
<span style=color:#66d9ef>false</span>
Action Done
<span style=color:#66d9ef>true</span>
<span style=color:#66d9ef>true</span>
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>import</span> java.util.Arrays<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.ForkJoinPool<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.ForkJoinTask<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.RecursiveAction<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.ThreadLocalRandom<span style=color:#f92672>;</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Main</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> arraySize <span style=color:#f92672>=</span> 100_000_000<span style=color:#f92672>;</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> arrayMin <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> arrayMax <span style=color:#f92672>=</span> 100_000_000<span style=color:#f92672>;</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span><span style=color:#f92672>[]</span> array <span style=color:#f92672>=</span> ThreadLocalRandom<span style=color:#f92672>.</span><span style=color:#a6e22e>current</span><span style=color:#f92672>().</span><span style=color:#a6e22e>ints</span><span style=color:#f92672>(</span>arraySize<span style=color:#f92672>,</span> arrayMin<span style=color:#f92672>,</span> arrayMax<span style=color:#f92672>).</span><span style=color:#a6e22e>toArray</span><span style=color:#f92672>();</span>

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> bucketCount <span style=color:#f92672>=</span> 1000<span style=color:#f92672>;</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> bucketSize <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>arraySize <span style=color:#f92672>/</span> bucketCount<span style=color:#f92672>)</span> <span style=color:#f92672>*</span> 10<span style=color:#f92672>;</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> bucketInterval <span style=color:#f92672>=</span> arrayMax <span style=color:#f92672>/</span> bucketCount<span style=color:#f92672>;</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span><span style=color:#f92672>[]</span> bucketIndex <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#66d9ef>int</span><span style=color:#f92672>[</span>bucketCount<span style=color:#f92672>];</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span><span style=color:#f92672>[][]</span> bucketArr <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#66d9ef>int</span><span style=color:#f92672>[</span>bucketCount<span style=color:#f92672>][</span>bucketSize<span style=color:#f92672>];</span>

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#75715e>//分桶(可以使用多线程，但效益不大)
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>long</span> l1 <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>();</span>
        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>:</span> array<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>int</span> j <span style=color:#f92672>=</span> i <span style=color:#f92672>/</span> bucketInterval<span style=color:#f92672>;</span>
            bucketArr<span style=color:#f92672>[</span>j<span style=color:#f92672>][</span>bucketIndex<span style=color:#f92672>[</span>j<span style=color:#f92672>]++]</span> <span style=color:#f92672>=</span> i<span style=color:#f92672>;</span>
        <span style=color:#f92672>}</span>

        <span style=color:#75715e>//排序
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>long</span> l2 <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>();</span>
        ForkJoinPool forkJoinPool <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ForkJoinPool<span style=color:#f92672>();</span>
        forkJoinPool<span style=color:#f92672>.</span><span style=color:#a6e22e>invoke</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> SortAction<span style=color:#f92672>(</span>0<span style=color:#f92672>,</span> bucketIndex<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>));</span>
        forkJoinPool<span style=color:#f92672>.</span><span style=color:#a6e22e>shutdown</span><span style=color:#f92672>();</span>

        <span style=color:#75715e>//合并
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>long</span> l3 <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>();</span>
        <span style=color:#66d9ef>int</span><span style=color:#f92672>[]</span> ints <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#66d9ef>int</span><span style=color:#f92672>[</span>array<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>];</span>
        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>,</span> n <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> bucketIndex<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
            System<span style=color:#f92672>.</span><span style=color:#a6e22e>arraycopy</span><span style=color:#f92672>(</span>bucketArr<span style=color:#f92672>[</span>i<span style=color:#f92672>],</span> 0<span style=color:#f92672>,</span> ints<span style=color:#f92672>,</span> n<span style=color:#f92672>,</span> bucketIndex<span style=color:#f92672>[</span>i<span style=color:#f92672>]);</span>
            n <span style=color:#f92672>+=</span> bucketIndex<span style=color:#f92672>[</span>i<span style=color:#f92672>];</span>
        <span style=color:#f92672>}</span>

        <span style=color:#75715e>//显示
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>long</span> l4 <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>();</span>
        String format1 <span style=color:#f92672>=</span> formatNum<span style=color:#f92672>(</span>arrayMax<span style=color:#f92672>)</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; - &#34;</span> <span style=color:#f92672>+</span> formatNum<span style=color:#f92672>(</span>arrayMax<span style=color:#f92672>);</span>
        String format2 <span style=color:#f92672>=</span> formatNum<span style=color:#f92672>(</span>bucketSize<span style=color:#f92672>)</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; 个：&#34;</span><span style=color:#f92672>;</span>
        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>,</span> n <span style=color:#f92672>=</span> arrayMin<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> bucketIndex<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
            System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>printf</span><span style=color:#f92672>(</span>format1<span style=color:#f92672>,</span> n<span style=color:#f92672>,</span> n <span style=color:#f92672>+=</span> bucketInterval<span style=color:#f92672>);</span>
            System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>printf</span><span style=color:#f92672>(</span>format2<span style=color:#f92672>,</span> bucketIndex<span style=color:#f92672>[</span>i<span style=color:#f92672>]);</span>
<span style=color:#75715e>//            for (int j = 0; j &lt; bucketIndex[i]; j++) {
</span><span style=color:#75715e>//                System.out.print(bucketArr[i][j] + &#34; &#34;);
</span><span style=color:#75715e>//            }
</span><span style=color:#75715e></span>            System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>();</span>
        <span style=color:#f92672>}</span>

        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;分桶:&#34;</span> <span style=color:#f92672>+</span> <span style=color:#f92672>(</span>l2 <span style=color:#f92672>-</span> l1<span style=color:#f92672>));</span>
        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;排序:&#34;</span> <span style=color:#f92672>+</span> <span style=color:#f92672>(</span>l3 <span style=color:#f92672>-</span> l2<span style=color:#f92672>));</span>
        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;合并:&#34;</span> <span style=color:#f92672>+</span> <span style=color:#f92672>(</span>l4 <span style=color:#f92672>-</span> l3<span style=color:#f92672>));</span>
        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;总共:&#34;</span> <span style=color:#f92672>+</span> <span style=color:#f92672>(</span>l4 <span style=color:#f92672>-</span> l1<span style=color:#f92672>));</span>

        check<span style=color:#f92672>(</span>ints<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>check</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span><span style=color:#f92672>[]</span> ints<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> ints<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span> <span style=color:#f92672>-</span> 1<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>ints<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span> <span style=color:#f92672>&gt;</span> ints<span style=color:#f92672>[</span>i <span style=color:#f92672>+</span> 1<span style=color:#f92672>])</span> <span style=color:#f92672>{</span>
                System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
                <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>}</span>
        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> String <span style=color:#a6e22e>formatNum</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;%&#34;</span> <span style=color:#f92672>+</span> countDigits<span style=color:#f92672>(</span>i<span style=color:#f92672>)</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;d&#34;</span><span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>countDigits</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>int</span> count <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(;</span> i <span style=color:#f92672>!=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>/=</span> 10<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            count<span style=color:#f92672>++;</span>
        <span style=color:#f92672>}</span>
        <span style=color:#66d9ef>return</span> count<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SortAction</span> <span style=color:#66d9ef>extends</span> RecursiveAction <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> THRESHOLD <span style=color:#f92672>=</span> 200<span style=color:#f92672>;</span>
        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> from<span style=color:#f92672>,</span> to<span style=color:#f92672>;</span>

        <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>SortAction</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> from<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> to<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>from</span> <span style=color:#f92672>=</span> from<span style=color:#f92672>;</span>
            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>to</span> <span style=color:#f92672>=</span> to<span style=color:#f92672>;</span>
        <span style=color:#f92672>}</span>

        <span style=color:#a6e22e>@Override</span>
        <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>compute</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>to <span style=color:#f92672>-</span> from <span style=color:#f92672>&lt;</span> THRESHOLD<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> from<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> to<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
                    Arrays<span style=color:#f92672>.</span><span style=color:#a6e22e>sort</span><span style=color:#f92672>(</span>bucketArr<span style=color:#f92672>[</span>i<span style=color:#f92672>],</span> 0<span style=color:#f92672>,</span> bucketIndex<span style=color:#f92672>[</span>i<span style=color:#f92672>]);</span>
                <span style=color:#f92672>}</span>
            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>int</span> mid <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>from <span style=color:#f92672>+</span> to<span style=color:#f92672>)</span> <span style=color:#f92672>&gt;&gt;&gt;</span> 1<span style=color:#f92672>;</span>
                SortAction l <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SortAction<span style=color:#f92672>(</span>from<span style=color:#f92672>,</span> mid<span style=color:#f92672>);</span>
                SortAction r <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SortAction<span style=color:#f92672>(</span>mid<span style=color:#f92672>,</span> to<span style=color:#f92672>);</span>
                ForkJoinTask<span style=color:#f92672>.</span><span style=color:#a6e22e>invokeAll</span><span style=color:#f92672>(</span>l<span style=color:#f92672>,</span> r<span style=color:#f92672>);</span>
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
<span style=color:#f92672>----</span>
输出<span style=color:#960050;background-color:#1e0010>：</span>
<span style=color:#f92672>...</span>
分桶:1571
排序:1697
合并:94
总共:3362
<span style=color:#66d9ef>true</span>
</code></pre></div></div><div class=sharing style=text-align:center><br><p>捐赠支持</p><p>如果我的文章对你有所帮助，欢迎通过支付宝的扫一扫，轻松的向我发起捐助。</p><p>对于你的支持，我会心怀感激且倍感荣幸地接受，并继续努力。</p><img src=https://ww4.sinaimg.cn/large/a15b4afegw1fbn096ql6dj20dw0dwwe9.jpg alt title data-action=zoom width=40%><p></p><br>&copy; 2015-2020 XhstormR</div></div></div></div><div id=backtop><a href=# title>TOP</a></div><nav id=TableOfContents><ul><li><a href=#concept>Concept</a></li><li><a href=#code>Code</a><ul><li><a href=#线程体>线程体</a></li><li><a href=#线程池>线程池</a></li><li><a href=#并发队列>并发队列</a></li><li><a href=#原子变量>原子变量</a></li></ul></li></ul></nav><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/languages/yaml.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/languages/kotlin.min.js></script><script>hljs.initHighlightingOnLoad()</script><script src=https://blog.xhstormr.tk/js/zoom.min.js></script><script>window.addEventListener("load",show),window.onscroll=show;function show(){document.documentElement.scrollTop+document.body.scrollTop>300?document.getElementById("backtop").style.display="block":document.getElementById("backtop").style.display="none"}</script><script type=text/javascript color=0,0,0 opacity=1 zindex=-2 count=49 src=https://cdnjs.cloudflare.com/ajax/libs/canvas-nest.js/2.0.4/canvas-nest.js></script></body></html>