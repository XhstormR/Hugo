<!doctype html><html lang=zh-cn manifest=https://blog.xhstormr.tk/offline.appcache><head><meta charset=utf-8><meta name=renderer content="webkit"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>JSP Listener &#183; XhstormR</title><link rel=alternate type=application/rss+xml title=XhstormR href><link rel=icon type=image/x-icon href=https://blog.xhstormr.tk/favicon.ico><link rel=stylesheet href=https://blog.xhstormr.tk/css/uno.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/styles/monokai-sublime.min.css><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js></script><script src=https://blog.xhstormr.tk/js/main.min.js async defer></script></head><body><div id=scriptHeader><span class="mobile btn-mobile-menu"><i class="fa fa-bars btn-mobile-menu__icon"></i>
<i class="fa fa-times btn-mobile-close__icon hidden"></i></span><header class="panel-cover panel-cover--collapsed"><div class=panel-main><div class="panel-main__inner panel-inverted"><div class=panel-main__content><h1 class="panel-cover__title panel-title"><a href=https://blog.xhstormr.tk/ title="link to homepage for XhstormR">XhstormR</a></h1><hr class=panel-cover__divider><p class=panel-cover__description>On a dark desert highway, cool wind in my hair.</p><hr class="panel-cover__divider panel-cover__divider--secondary"><div class=navigation-wrapper><nav class="cover-navigation cover-navigation--primary"><ul class=navigation><li class=navigation__item><a href=https://blog.xhstormr.tk#blog title="link to XhstormR blog" class=blog-button>Blog</a></li></ul></nav></div></div></div><div class=panel-cover--overlay></div></div></header></div><div class=bodytop><div class=content-wrapper><div class=content-wrapper__inner><div class=post><h1>JSP Listener</h1><span class=post-date>2017-05-02</span><p>Updated on 2017-05-02</p><blockquote></blockquote><h2 id=工作原理>工作原理</h2><p>用于监听 ServletContext、ServletRequest、HttpSession 等对象的创建、销毁以及属性增删事件。</p><ul><li>按监听对象划分<ul><li>ServletContext（application）<ul><li>Servlet<strong>Context</strong>Listener</li><li>Servlet<strong>Context</strong>AttributeListener</li></ul></li><li>ServletRequest（request）<ul><li>Servlet<strong>Request</strong>Listener</li><li>Servlet<strong>Request</strong>AttributeListener</li></ul></li><li>HttpSession（session）<ul><li>Http<strong>Session</strong>Listener</li><li>Http<strong>Session</strong>AttributeListener</li></ul></li><li>JavaBean<ul><li>Http<strong>Session</strong>BindingListener（绑定 - 解绑）</li><li>Http<strong>Session</strong>ActivationListener（钝化 - 活化）</li></ul></li></ul></li><li>按监听事件划分<ul><li>对象的创建与销毁<ul><li>Servlet<strong>Context</strong>Listener</li><li>Servlet<strong>Request</strong>Listener</li><li>Http<strong>Session</strong>Listener</li></ul></li><li>属性的增加、删除与替换<ul><li>Servlet<strong>Context</strong>AttributeListener</li><li>Servlet<strong>Request</strong>AttributeListener</li><li>Http<strong>Session</strong>AttributeListener</li></ul></li><li>绑定至 HttpSession 中属性状态的改变<ul><li>Http<strong>Session</strong>BindingListener（绑定 - 解绑）</li><li>Http<strong>Session</strong>ActivationListener（钝化 - 活化）</li></ul></li></ul></li></ul><h3 id=user>User</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>package</span> a

<span style=color:#66d9ef>import</span> java.io.Serializable
<span style=color:#66d9ef>import</span> javax.servlet.http.HttpSessionActivationListener
<span style=color:#66d9ef>import</span> javax.servlet.http.HttpSessionBindingEvent
<span style=color:#66d9ef>import</span> javax.servlet.http.HttpSessionBindingListener
<span style=color:#66d9ef>import</span> javax.servlet.http.HttpSessionEvent

<span style=color:#66d9ef>data</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>User</span>(<span style=color:#66d9ef>val</span> name: String = <span style=color:#e6db74>&#34;Tom&#34;</span>) : HttpSessionBindingListener, HttpSessionActivationListener, Serializable {
    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>valueBound</span>(event: HttpSessionBindingEvent) {
        println(<span style=color:#e6db74>&#34;实体绑定：</span><span style=color:#e6db74>${event.name}</span><span style=color:#e6db74> :: </span><span style=color:#e6db74>${event.value}</span><span style=color:#e6db74>&#34;</span>)
    }

    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>valueUnbound</span>(event: HttpSessionBindingEvent) {
        println(<span style=color:#e6db74>&#34;实体解绑：</span><span style=color:#e6db74>${event.name}</span><span style=color:#e6db74> :: </span><span style=color:#e6db74>${event.value}</span><span style=color:#e6db74>&#34;</span>)
    }

    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>sessionWillPassivate</span>(se: HttpSessionEvent) {
        println(<span style=color:#e6db74>&#34;会话序列化（钝化）：&#34;</span> + se.session)
    }

    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>sessionDidActivate</span>(se: HttpSessionEvent) {
        println(<span style=color:#e6db74>&#34;会话反序列化（活化）：&#34;</span> + se.session)
    }
}
</code></pre></div><h3 id=mylistener>MyListener</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>package</span> a

<span style=color:#66d9ef>import</span> javax.servlet.ServletContextEvent
<span style=color:#66d9ef>import</span> javax.servlet.ServletContextListener
<span style=color:#66d9ef>import</span> javax.servlet.ServletRequestEvent
<span style=color:#66d9ef>import</span> javax.servlet.ServletRequestListener
<span style=color:#66d9ef>import</span> javax.servlet.annotation.WebListener
<span style=color:#66d9ef>import</span> javax.servlet.http.HttpSessionAttributeListener
<span style=color:#66d9ef>import</span> javax.servlet.http.HttpSessionBindingEvent
<span style=color:#66d9ef>import</span> javax.servlet.http.HttpSessionEvent
<span style=color:#66d9ef>import</span> javax.servlet.http.HttpSessionListener

<span style=color:#a6e22e>@WebListener</span>     <span style=color:#75715e>//通过注解方式配置监听器
</span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyListener</span> : ServletContextListener, ServletRequestListener, HttpSessionListener, HttpSessionAttributeListener {
    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>contextInitialized</span>(sce: ServletContextEvent) {
        println(<span style=color:#e6db74>&#34;应用初始化：&#34;</span> + sce.servletContext)
    }

    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>contextDestroyed</span>(sce: ServletContextEvent) {
        println(<span style=color:#e6db74>&#34;应用销毁：&#34;</span> + sce.servletContext)
    }

    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>requestInitialized</span>(sre: ServletRequestEvent) {
        println(<span style=color:#e6db74>&#34;请求创建：&#34;</span> + sre.servletRequest)
    }

    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>requestDestroyed</span>(sre: ServletRequestEvent) {
        println(<span style=color:#e6db74>&#34;请求销毁：&#34;</span> + sre.servletRequest)
    }

    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>sessionCreated</span>(se: HttpSessionEvent) {
        println(<span style=color:#e6db74>&#34;会话创建：&#34;</span> + se.session)
    }

    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>sessionDestroyed</span>(se: HttpSessionEvent) {
        println(<span style=color:#e6db74>&#34;会话销毁：&#34;</span> + se.session)
    }

    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>attributeAdded</span>(sbe: HttpSessionBindingEvent) {
        println(<span style=color:#e6db74>&#34;会话添加属性：</span><span style=color:#e6db74>${sbe.name}</span><span style=color:#e6db74> :: </span><span style=color:#e6db74>${sbe.value}</span><span style=color:#e6db74>&#34;</span>)
    }

    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>attributeReplaced</span>(sbe: HttpSessionBindingEvent) {
        println(<span style=color:#e6db74>&#34;会话替换属性：</span><span style=color:#e6db74>${sbe.name}</span><span style=color:#e6db74> :: </span><span style=color:#e6db74>${sbe.value}</span><span style=color:#e6db74>&#34;</span>)
    }

    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>attributeRemoved</span>(sbe: HttpSessionBindingEvent) {
        println(<span style=color:#e6db74>&#34;会话移除属性：</span><span style=color:#e6db74>${sbe.name}</span><span style=color:#e6db74> :: </span><span style=color:#e6db74>${sbe.value}</span><span style=color:#e6db74>&#34;</span>)
    }
}
</code></pre></div><h3 id=webxml>web.xml</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#75715e>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span style=color:#f92672>&lt;web-app</span> <span style=color:#a6e22e>xmlns:xsi=</span><span style=color:#e6db74>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
         <span style=color:#a6e22e>xmlns=</span><span style=color:#e6db74>&#34;http://xmlns.jcp.org/xml/ns/javaee&#34;</span>
         <span style=color:#a6e22e>xsi:schemaLocation=</span><span style=color:#e6db74>&#34;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd&#34;</span>
         <span style=color:#a6e22e>version=</span><span style=color:#e6db74>&#34;3.1&#34;</span><span style=color:#f92672>&gt;</span>

    <span style=color:#f92672>&lt;listener&gt;</span>
        <span style=color:#f92672>&lt;listener-class&gt;</span>a.MyListener<span style=color:#f92672>&lt;/listener-class&gt;</span>
    <span style=color:#f92672>&lt;/listener&gt;</span>

<span style=color:#f92672>&lt;/web-app&gt;</span>

加载顺序：监听器 &gt; 过滤器 &gt; Servlet
</code></pre></div><h2 id=在线用户案例>在线用户案例</h2><h3 id=jsp>JSP</h3><pre><code>index.jsp
----
&lt;%@ page import=&quot;a.User&quot; %&gt;
&lt;%@ page import=&quot;java.util.List&quot; %&gt;
&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;A&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;%
    final List&lt;User&gt; users = (List&lt;User&gt;) application.getAttribute(&quot;users&quot;);
%&gt;
当前在线用户人数：&lt;%=users.size()%&gt;&lt;br&gt;
&lt;%
    for (User user : users) {
%&gt;
ID：&lt;%=user.getId()%&gt;，IP：&lt;%=user.getIp()%&gt;，FirstAccessTime：&lt;%=user.getFirstAccessTime()%&gt;&lt;br&gt;
&lt;%
    }
%&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre><h3 id=mylistener-1>MyListener</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>package</span> a

<span style=color:#66d9ef>import</span> java.text.SimpleDateFormat
<span style=color:#66d9ef>import</span> java.util.*
<span style=color:#66d9ef>import</span> javax.servlet.ServletContextEvent
<span style=color:#66d9ef>import</span> javax.servlet.ServletContextListener
<span style=color:#66d9ef>import</span> javax.servlet.ServletRequestEvent
<span style=color:#66d9ef>import</span> javax.servlet.ServletRequestListener
<span style=color:#66d9ef>import</span> javax.servlet.annotation.WebListener
<span style=color:#66d9ef>import</span> javax.servlet.http.HttpServletRequest
<span style=color:#66d9ef>import</span> javax.servlet.http.HttpSessionEvent
<span style=color:#66d9ef>import</span> javax.servlet.http.HttpSessionListener

<span style=color:#a6e22e>@WebListener</span>
<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyListener</span> : ServletContextListener, HttpSessionListener, ServletRequestListener {
    <span style=color:#66d9ef>val</span> users = arrayListOf&lt;User&gt;()
    <span style=color:#66d9ef>val</span> sdf = SimpleDateFormat(<span style=color:#e6db74>&#34;yyyy-MM-dd HH:mm:ss&#34;</span>)

    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>contextInitialized</span>(sce: ServletContextEvent) {
        sce.servletContext.setAttribute(<span style=color:#e6db74>&#34;users&#34;</span>, users)
    }

    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>contextDestroyed</span>(sce: ServletContextEvent) {
        sce.servletContext.removeAttribute(<span style=color:#e6db74>&#34;users&#34;</span>)
    }

    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>sessionCreated</span>(se: HttpSessionEvent) {
        <span style=color:#75715e>//Do nothing
</span><span style=color:#75715e></span>    }

    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>sessionDestroyed</span>(se: HttpSessionEvent) {
        <span style=color:#66d9ef>val</span> id = se.session.id
        users.removeAll { <span style=color:#66d9ef>it</span>.id <span style=color:#f92672>==</span> id }
    }

    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>requestInitialized</span>(sre: ServletRequestEvent) {
        <span style=color:#66d9ef>val</span> request = sre.servletRequest <span style=color:#66d9ef>as</span> HttpServletRequest
        <span style=color:#66d9ef>val</span> session = request.session
        <span style=color:#66d9ef>val</span> id = session.id
        <span style=color:#66d9ef>if</span> (!users.map { <span style=color:#66d9ef>it</span>.id }.contains(id)) {
            <span style=color:#66d9ef>val</span> ip = request.remoteAddr
            <span style=color:#66d9ef>val</span> time = sdf.format(Date(session.creationTime))
            users.add(User(id, ip, time))
        }
    }

    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>requestDestroyed</span>(sre: ServletRequestEvent) {
        <span style=color:#75715e>//Do nothing
</span><span style=color:#75715e></span>    }
}
</code></pre></div><h3 id=user-1>User</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>package</span> a

<span style=color:#66d9ef>data</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>User</span>(<span style=color:#66d9ef>val</span> id: String, <span style=color:#66d9ef>val</span> ip: String, <span style=color:#66d9ef>val</span> firstAccessTime: String)
</code></pre></div></div><div class=sharing style=text-align:center><br><p>捐赠支持</p><p>如果我的文章对你有所帮助，欢迎通过支付宝的扫一扫，轻松的向我发起捐助。</p><p>对于你的支持，我会心怀感激且倍感荣幸地接受，并继续努力。</p><img src=https://ww4.sinaimg.cn/large/a15b4afegw1fbn096ql6dj20dw0dwwe9.jpg alt title data-action=zoom width=40%><p></p><br>&copy; 2015-2020 XhstormR</div></div></div></div><div id=backtop><a href=# title>TOP</a></div><nav id=TableOfContents><ul><li><a href=#工作原理>工作原理</a><ul><li><a href=#user>User</a></li><li><a href=#mylistener>MyListener</a></li><li><a href=#webxml>web.xml</a></li></ul></li><li><a href=#在线用户案例>在线用户案例</a><ul><li><a href=#jsp>JSP</a></li><li><a href=#mylistener-1>MyListener</a></li><li><a href=#user-1>User</a></li></ul></li></ul></nav><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/languages/yaml.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/languages/kotlin.min.js></script><script>hljs.initHighlightingOnLoad()</script><script src=https://blog.xhstormr.tk/js/zoom.min.js></script><script>window.addEventListener("load",show),window.onscroll=show;function show(){document.documentElement.scrollTop+document.body.scrollTop>300?document.getElementById("backtop").style.display="block":document.getElementById("backtop").style.display="none"}</script><script type=text/javascript color=0,0,0 opacity=1 zindex=-2 count=49 src=https://cdnjs.cloudflare.com/ajax/libs/canvas-nest.js/2.0.4/canvas-nest.js></script></body></html>