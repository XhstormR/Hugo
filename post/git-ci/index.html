<!doctype html><html lang=zh-cn manifest=https://blog.xhstormr.tk/offline.appcache><head><meta charset=utf-8><meta name=renderer content="webkit"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>Git + CI &#183; XhstormR</title><link rel=alternate type=application/rss+xml title=XhstormR href><link rel=icon type=image/x-icon href=https://blog.xhstormr.tk/favicon.ico><link rel=stylesheet href=https://blog.xhstormr.tk/css/uno.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/styles/monokai-sublime.min.css><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js></script><script src=https://blog.xhstormr.tk/js/main.min.js async defer></script></head><body><div id=scriptHeader><span class="mobile btn-mobile-menu"><i class="fa fa-bars btn-mobile-menu__icon"></i>
<i class="fa fa-times btn-mobile-close__icon hidden"></i></span><header class="panel-cover panel-cover--collapsed"><div class=panel-main><div class="panel-main__inner panel-inverted"><div class=panel-main__content><h1 class="panel-cover__title panel-title"><a href=https://blog.xhstormr.tk/ title="link to homepage for XhstormR">XhstormR</a></h1><hr class=panel-cover__divider><p class=panel-cover__description>On a dark desert highway, cool wind in my hair.</p><hr class="panel-cover__divider panel-cover__divider--secondary"><div class=navigation-wrapper><nav class="cover-navigation cover-navigation--primary"><ul class=navigation><li class=navigation__item><a href=https://blog.xhstormr.tk#blog title="link to XhstormR blog" class=blog-button>Blog</a></li></ul></nav></div></div></div><div class=panel-cover--overlay></div></div></header></div><div class=bodytop><div class=content-wrapper><div class=content-wrapper__inner><div class=post><h1>Git + CI</h1><span class=post-date>2019-04-04</span><p>Updated on 2019-04-04</p><blockquote></blockquote><h2 id=linux>Linux</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo
yum makecache
yum update -y

timedatectl set-timezone Asia/Shanghai
date +%s -s @1602842120
hwclock -w
</code></pre></div><h2 id=docker>Docker</h2><ul><li><a href=https://docs.docker.com/reference/>https://docs.docker.com/reference/</a></li><li><a href=https://docs.docker.com/engine/reference/builder/>https://docs.docker.com/engine/reference/builder/</a></li><li><a href=https://docs.docker.com/engine/reference/commandline/docker/>https://docs.docker.com/engine/reference/commandline/docker/</a></li><li><a href=https://docs.docker.com/engine/reference/commandline/dockerd/>https://docs.docker.com/engine/reference/commandline/dockerd/</a></li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl -fsSL https://get.docker.com | bash -s -- docker --mirror Aliyun
mkdir -p /etc/docker
echo -e <span style=color:#e6db74>&#39;{\n&#34;userland-proxy&#34;: false,\n&#34;registry-mirrors&#34;: [&#34;https://docker.mirrors.ustc.edu.cn&#34;]\n}&#39;</span> &gt; /etc/docker/daemon.json
systemctl start docker
systemctl enable docker
systemctl status docker
usermod -aG docker leo
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker info <span style=color:#75715e>#查看系统信息</span>
docker ps -a <span style=color:#75715e>#查看容器</span>
docker images <span style=color:#75715e>#查看镜像</span>
docker network ls <span style=color:#75715e>#查看网络</span>
docker rm -fv gitlab <span style=color:#75715e>#停止并删除容器、卷</span>
docker rm <span style=color:#e6db74>`</span>docker ps -a -q<span style=color:#e6db74>`</span> <span style=color:#75715e>#删除已停止的容器</span>
docker rmi gitlab/gitlab-ce <span style=color:#75715e>#删除镜像</span>
docker image prune -f <span style=color:#75715e>#清除未使用镜像</span>
docker logs -f gitlab <span style=color:#75715e>#查看容器日志</span>
docker exec -it gitlab sh <span style=color:#75715e>#获得容器 Shell</span>
</code></pre></div><h3 id=docker-compose>Docker Compose</h3><ul><li><a href=https://docs.docker.com/compose/reference/>https://docs.docker.com/compose/reference/</a></li><li><a href=https://docs.docker.com/compose/compose-file/>https://docs.docker.com/compose/compose-file/</a></li><li><a href=https://github.com/compose-spec/compose-spec/blob/master/spec.md>https://github.com/compose-spec/compose-spec/blob/master/spec.md</a></li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo curl -Lf https://github.com/docker/compose/releases/download/1.24.0/run.sh -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker-compose version <span style=color:#75715e>#查看版本</span>
docker-compose down -v <span style=color:#75715e>#停止并删除容器、网络、卷</span>
docker-compose logs -f <span style=color:#75715e>#查看容器日志</span>
docker-compose exec gitlab sh <span style=color:#75715e>#获得容器 Shell</span>
</code></pre></div><h2 id=gitlab--traefik--portainer>GitLab + Traefik + Portainer</h2><ul><li><a href=https://docs.gitlab.com/omnibus/docker/>https://docs.gitlab.com/omnibus/docker/</a></li><li><a href=https://doc.traefik.io/traefik/routing/providers/docker/>https://doc.traefik.io/traefik/routing/providers/docker/</a></li><li><a href=https://portainer.readthedocs.io/en/stable/configuration.html>https://portainer.readthedocs.io/en/stable/configuration.html</a></li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker-compose pull
docker-compose up -d
docker-compose ps
docker-compose exec runner gitlab-runner register
</code></pre></div><h3 id=docker-composeyml>docker-compose.yml</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#39;3&#39;</span>

<span style=color:#f92672>services</span>:
  <span style=color:#f92672>gitlab</span>:
    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>gitlab/gitlab-ce:latest</span>
    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
    <span style=color:#f92672>environment</span>:
      <span style=color:#f92672>GITLAB_OMNIBUS_CONFIG</span>: |<span style=color:#e6db74>
</span><span style=color:#e6db74>        gitlab_rails[&#39;gitlab_shell_ssh_port&#39;] = 5022
</span><span style=color:#e6db74>        external_url &#39;${GITLAB_SERVER_URL}&#39;
</span><span style=color:#e6db74>        registry_external_url &#39;${GITLAB_REGISTRY_URL}&#39;
</span><span style=color:#e6db74>        registry_nginx[&#39;ssl_certificate&#39;] = &#34;/certs/domain.crt&#34;
</span><span style=color:#e6db74>        registry_nginx[&#39;ssl_certificate_key&#39;] = &#34;/certs/domain.key&#34;</span>        
    <span style=color:#f92672>ports</span>:
      - <span style=color:#e6db74>&#39;5022:22&#39;</span>
      - <span style=color:#e6db74>&#39;5100:5100&#39;</span>
    <span style=color:#f92672>volumes</span>:
      - <span style=color:#ae81ff>./certs:/certs</span>
      - <span style=color:#ae81ff>gitlab_config:/etc/gitlab</span>
      - <span style=color:#ae81ff>gitlab_logs:/var/log/gitlab</span>
      - <span style=color:#ae81ff>gitlab_data:/var/opt/gitlab</span>
    <span style=color:#f92672>labels</span>:
      - <span style=color:#ae81ff>traefik.http.services.gitlab.loadbalancer.server.port=80</span>
      - <span style=color:#ae81ff>traefik.http.routers.gitlab.rule=PathPrefix(`/git/`)</span>

  <span style=color:#f92672>runner</span>:
    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>gitlab/gitlab-runner:latest</span>
    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
    <span style=color:#f92672>environment</span>:
      <span style=color:#f92672>CI_SERVER_URL</span>: <span style=color:#ae81ff>${GITLAB_SERVER_URL}</span>
      <span style=color:#f92672>REGISTRATION_TOKEN</span>: <span style=color:#ae81ff>${RUNNER_REGISTRATION_TOKEN}</span>
      <span style=color:#f92672>REGISTER_NON_INTERACTIVE</span>: <span style=color:#e6db74>&#39;true&#39;</span>
      <span style=color:#f92672>RUNNER_EXECUTOR</span>: <span style=color:#ae81ff>docker</span>
      <span style=color:#f92672>DOCKER_IMAGE</span>: <span style=color:#ae81ff>alpine:latest</span>
    <span style=color:#f92672>volumes</span>:
      - <span style=color:#ae81ff>runner_data:/etc/gitlab-runner</span>
      - <span style=color:#ae81ff>/var/run/docker.sock:/var/run/docker.sock</span>
    <span style=color:#f92672>labels</span>:
      - <span style=color:#ae81ff>traefik.enable=false</span>
    <span style=color:#f92672>depends_on</span>:
      - <span style=color:#ae81ff>gitlab</span>

  <span style=color:#f92672>portainer</span>:
    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>portainer/portainer:latest</span>
    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
    <span style=color:#f92672>command</span>: -<span style=color:#ae81ff>H unix:///var/run/docker.sock --admin-password ${PORTAINER_ADMIN_PASSWORD}</span>
    <span style=color:#f92672>volumes</span>:
      - <span style=color:#ae81ff>portainer_data:/data</span>
      - <span style=color:#ae81ff>/var/run/docker.sock:/var/run/docker.sock</span>
    <span style=color:#f92672>labels</span>:
      - <span style=color:#ae81ff>traefik.http.services.portainer.loadbalancer.server.port=9000</span>
      - <span style=color:#ae81ff>traefik.http.routers.portainer.rule=PathPrefix(`/portainer/`)</span>
      - <span style=color:#ae81ff>traefik.http.routers.portainer.middlewares=portainer-stripprefix</span>
      - <span style=color:#ae81ff>traefik.http.middlewares.portainer-stripprefix.stripprefix.prefixes=/portainer/</span>

  <span style=color:#f92672>traefik</span>:
    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>traefik:latest</span>
    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
    <span style=color:#f92672>ports</span>:
      - <span style=color:#e6db74>&#39;80:80&#39;</span>
    <span style=color:#f92672>command</span>: --<span style=color:#ae81ff>api --providers.docker</span>
    <span style=color:#f92672>volumes</span>:
      - <span style=color:#ae81ff>/var/run/docker.sock:/var/run/docker.sock</span>
    <span style=color:#f92672>labels</span>:
      - <span style=color:#ae81ff>traefik.http.routers.traefik.service=api@internal</span>
      - <span style=color:#ae81ff>traefik.http.routers.traefik.rule=PathPrefix(`/traefik/`)</span>
      - <span style=color:#ae81ff>traefik.http.routers.traefik.middlewares=traefik-stripprefix,traefik-basicauth</span>
      - <span style=color:#ae81ff>traefik.http.middlewares.traefik-stripprefix.stripprefix.prefixes=/traefik/</span>
      - <span style=color:#ae81ff>traefik.http.middlewares.traefik-basicauth.basicauth.removeheader=true</span>
      - <span style=color:#ae81ff>traefik.http.middlewares.traefik-basicauth.basicauth.users=${TRAEFIK_BASIC_AUTH}</span>

<span style=color:#f92672>volumes</span>:
  <span style=color:#f92672>gitlab_config</span>:
  <span style=color:#f92672>gitlab_logs</span>:
  <span style=color:#f92672>gitlab_data</span>:
  <span style=color:#f92672>runner_data</span>:
  <span style=color:#f92672>portainer_data</span>:
</code></pre></div><h3 id=env>.env</h3><pre><code>GITLAB_SERVER_URL=http://192.168.8.128/git/
GITLAB_REGISTRY_URL=https://192.168.8.128:5100
RUNNER_REGISTRATION_TOKEN=123
TRAEFIK_BASIC_AUTH=123:$2y$05$80HqrqBOoNaabteix3gYJ.S0kT.HP6sw5GjOplRfGhGezth0yL78y
PORTAINER_ADMIN_PASSWORD=$2y$05$80HqrqBOoNaabteix3gYJ.S0kT.HP6sw5GjOplRfGhGezth0yL78y
</code></pre><hr><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>配置 sudoers

visudo -f /etc/sudoers.d/123
----
leo    ALL<span style=color:#f92672>=(</span>ALL<span style=color:#f92672>)</span>       ALL
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>配置 Docker Registry 证书

mkdir -p certs
openssl req <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -config /etc/pki/tls/openssl.cnf <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -addext <span style=color:#e6db74>&#39;subjectAltName=IP:192.168.8.128&#39;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -newkey rsa:4096 -nodes -sha256 -keyout certs/domain.key <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -x509 -days <span style=color:#ae81ff>365</span> -out certs/domain.crt

mkdir -p /etc/docker/certs.d/192.168.8.128:5100
cp certs/domain.crt /etc/docker/certs.d/192.168.8.128:5100/ca.crt

https://www.openssl.org/docs/manmaster/man1/req.html
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>基本身份认证

htpasswd -nbB <span style=color:#ae81ff>123</span> <span style=color:#ae81ff>123456</span>

https://httpd.apache.org/docs/current/programs/htpasswd.html
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>本地容器之间若通过 HostIP:Port 访问对方，需要防火墙放行对应端口

systemctl status firewalld
firewall-cmd --state
firewall-cmd --add-service<span style=color:#f92672>=</span>http --permanent
firewall-cmd --reload
firewall-cmd --list-all

firewall-cmd --add-port<span style=color:#f92672>=</span>80/tcp --permanent
firewall-cmd --remove-port<span style=color:#f92672>=</span>80/tcp --permanent
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>远程访问 Docker daemon

systemctl edit docker
---
<span style=color:#f92672>[</span>Service<span style=color:#f92672>]</span>
ExecStart<span style=color:#f92672>=</span>
ExecStart<span style=color:#f92672>=</span>/usr/bin/dockerd -H fd:// --containerd<span style=color:#f92672>=</span>/run/containerd/containerd.sock -H tcp://0.0.0.0
---
systemctl cat docker
systemctl restart docker

firewall-cmd --add-port<span style=color:#f92672>=</span>2375/tcp --permanent
firewall-cmd --reload
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>https://docker.mirrors.ustc.edu.cn/v2/gitlab/gitlab-ce/tags/list
https://docker.mirrors.ustc.edu.cn/v2/gitlab/gitlab-ce/manifests/latest
https://docker.mirrors.ustc.edu.cn/v2/gitlab/gitlab-ce/blobs/sha256:e04a2435a78d15beae8c317bb18cfc3bc556b8dcdb7d29b256971ad42ee06767

curl -sk https://docker.mirrors.ustc.edu.cn/v2/gitlab/gitlab-ce/manifests/latest | ^
jq -r .fsLayers<span style=color:#f92672>[]</span>.blobSum | ^
busybox xargs -i echo curl -skI https://docker.mirrors.ustc.edu.cn/v2/gitlab/gitlab-ce/blobs/<span style=color:#f92672>{}</span> | ^
busybox sh | ^
busybox grep -i content-length

https://docs.docker.com/registry/spec/api/
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>GitLab 控制台修改管理员密码

gitlab-rails console
user <span style=color:#f92672>=</span> User.where<span style=color:#f92672>(</span>id:1<span style=color:#f92672>)</span>.first
user.password <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;12345678&#39;</span>
user.save!
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>GitLab 升级

gitlab-ctl upgrade
gitlab-ctl reconfigure
gitlab-ctl restart
gitlab-ctl status
gitlab-ctl tail
</code></pre></div><h2 id=reference>Reference</h2><ul><li><a href=https://docs.docker.com/samples/>https://docs.docker.com/samples/</a></li><li><a href=https://github.com/wagoodman/dive>https://github.com/wagoodman/dive</a></li><li>Docker mirror<ul><li><a href=https://dockerhub.azk8s.cn/v2/>https://dockerhub.azk8s.cn/v2/</a></li><li><a href=https://hub-mirror.c.163.com/v2/>https://hub-mirror.c.163.com/v2/</a></li><li><a href=https://docker.mirrors.ustc.edu.cn/v2/>https://docker.mirrors.ustc.edu.cn/v2/</a></li><li><a href=https://ustc-edu-cn.mirror.aliyuncs.com/v2/>https://ustc-edu-cn.mirror.aliyuncs.com/v2/</a></li><li><a href=https://cr.console.aliyun.com/cn-shanghai/instances/mirrors>https://cr.console.aliyun.com/cn-shanghai/instances/mirrors</a></li></ul></li><li>GitLab CI<ul><li><a href=https://docs.gitlab.com/ee/ci/yaml/>https://docs.gitlab.com/ee/ci/yaml/</a></li><li><a href=https://docs.gitlab.com/ee/ci/variables/predefined_variables.html>https://docs.gitlab.com/ee/ci/variables/predefined_variables.html</a></li></ul></li></ul></div><div class=sharing style=text-align:center><br><p>捐赠支持</p><p>如果我的文章对你有所帮助，欢迎通过支付宝的扫一扫，轻松的向我发起捐助。</p><p>对于你的支持，我会心怀感激且倍感荣幸地接受，并继续努力。</p><img src=https://ww4.sinaimg.cn/large/a15b4afegw1fbn096ql6dj20dw0dwwe9.jpg alt title data-action=zoom width=40%><p></p><br>&copy; 2015-2020 XhstormR</div></div></div></div><div id=backtop><a href=# title>TOP</a></div><nav id=TableOfContents><ul><li><a href=#linux>Linux</a></li><li><a href=#docker>Docker</a><ul><li><a href=#docker-compose>Docker Compose</a></li></ul></li><li><a href=#gitlab--traefik--portainer>GitLab + Traefik + Portainer</a><ul><li><a href=#docker-composeyml>docker-compose.yml</a></li><li><a href=#env>.env</a></li></ul></li><li><a href=#reference>Reference</a></li></ul></nav><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/languages/yaml.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/languages/kotlin.min.js></script><script>hljs.initHighlightingOnLoad()</script><script src=https://blog.xhstormr.tk/js/zoom.min.js></script><script>window.addEventListener("load",show),window.onscroll=show;function show(){document.documentElement.scrollTop+document.body.scrollTop>300?document.getElementById("backtop").style.display="block":document.getElementById("backtop").style.display="none"}</script><script type=text/javascript color=0,0,0 opacity=1 zindex=-2 count=49 src=https://cdnjs.cloudflare.com/ajax/libs/canvas-nest.js/2.0.4/canvas-nest.js></script></body></html>