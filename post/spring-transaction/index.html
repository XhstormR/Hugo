<!doctype html><html lang=zh-cn manifest=https://blog.xhstormr.tk/offline.appcache><head><meta charset=utf-8><meta name=renderer content="webkit"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>Spring Transaction &#183; XhstormR</title><link rel=alternate type=application/rss+xml title=XhstormR href><link rel=icon type=image/x-icon href=https://blog.xhstormr.tk/favicon.ico><link rel=stylesheet href=https://blog.xhstormr.tk/css/uno.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/styles/monokai-sublime.min.css><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js></script><script src=https://blog.xhstormr.tk/js/main.min.js async defer></script></head><body><div id=scriptHeader><span class="mobile btn-mobile-menu"><i class="fa fa-bars btn-mobile-menu__icon"></i>
<i class="fa fa-times btn-mobile-close__icon hidden"></i></span><header class="panel-cover panel-cover--collapsed"><div class=panel-main><div class="panel-main__inner panel-inverted"><div class=panel-main__content><h1 class="panel-cover__title panel-title"><a href=https://blog.xhstormr.tk/ title="link to homepage for XhstormR">XhstormR</a></h1><hr class=panel-cover__divider><p class=panel-cover__description>On a dark desert highway, cool wind in my hair.</p><hr class="panel-cover__divider panel-cover__divider--secondary"><div class=navigation-wrapper><nav class="cover-navigation cover-navigation--primary"><ul class=navigation><li class=navigation__item><a href=https://blog.xhstormr.tk#blog title="link to XhstormR blog" class=blog-button>Blog</a></li></ul></nav></div></div></div><div class=panel-cover--overlay></div></div></header></div><div class=bodytop><div class=content-wrapper><div class=content-wrapper__inner><div class=post><h1>Spring Transaction</h1><span class=post-date>2017-06-15</span><p>Updated on 2017-06-15</p><blockquote><p style=text-align:center><img data-src=/uploads/spring.png alt title="Spring Framework" data-action=zoom width></p><script>[].forEach.call(document.querySelectorAll("img[data-src]"),function(a){a.setAttribute("src",a.getAttribute("data-src")),a.onload=function(){a.removeAttribute("data-src")}})</script><p><a href=https://github.com/brettwooldridge/HikariCP>https://github.com/brettwooldridge/HikariCP</a></p><p><a href=https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/transaction/TransactionDefinition.html>https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/transaction/TransactionDefinition.html</a></p><p><a href=https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/transaction/annotation/Transactional.html>https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/transaction/annotation/Transactional.html</a></p></blockquote><h2 id=concept>Concept</h2><ul><li>事务的传播行为：Propagation<ul><li>作用：解决业务层中方法之间互相调用而产生的事务如何传递的问题。</li><li>在 <strong>相同</strong> 事务中：REQUIRED</li><li>在 <strong>不同</strong> 事务中：REQUIRES_NEW</li><li>在 <strong>嵌套</strong> 事务中：NESTED</li></ul></li><li>事务的隔离级别：Isolation</li><li>只读事务：readOnly<ul><li>作用：禁止 <strong>增删改</strong> 操作。</li></ul></li><li>发生异常 回滚事务：-Exception</li><li>发生异常不回滚事务：+Exception</li></ul><h2 id=configuration>Configuration</h2><h3 id=buildgradlekts>build.gradle.kts</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>compile<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;org.springframework:spring-orm:+&#34;</span><span style=color:#f92672>)</span>
compile<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;org.springframework:spring-context:+&#34;</span><span style=color:#f92672>)</span>

compile<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;com.zaxxer:HikariCP:+&#34;</span><span style=color:#f92672>)</span>
compile<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;org.slf4j:slf4j-jdk14:+&#34;</span><span style=color:#f92672>)</span>
compile<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;org.postgresql:postgresql:+&#34;</span><span style=color:#f92672>)</span>

compile<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;org.hibernate:hibernate-core:+&#34;</span><span style=color:#f92672>)</span>
compile<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;org.hibernate:hibernate-hikaricp:+&#34;</span><span style=color:#f92672>)</span>
compile<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;org.hibernate:hibernate-infinispan:+&#34;</span><span style=color:#f92672>)</span>
</code></pre></div><h3 id=hibernateproperties>hibernate.properties</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>hibernate.show_sql<span style=color:#f92672>=</span>true
hibernate.format_sql<span style=color:#f92672>=</span>false
hibernate.hbm2ddl.auto<span style=color:#f92672>=</span>update
hibernate.dialect<span style=color:#f92672>=</span>org.hibernate.dialect.PostgreSQL95Dialect
hibernate.current_session_context_class<span style=color:#f92672>=</span>org.springframework.orm.hibernate5.SpringSessionContext

hibernate.connection.provider_class<span style=color:#f92672>=</span>org.hibernate.hikaricp.internal.HikariCPConnectionProvider
hibernate.hikari.dataSourceClassName<span style=color:#f92672>=</span>org.postgresql.ds.PGSimpleDataSource
hibernate.hikari.dataSource.url<span style=color:#f92672>=</span>jdbc:postgresql://127.0.0.1:5432/postgres
hibernate.hikari.username<span style=color:#f92672>=</span><span style=color:#ae81ff>123</span>
hibernate.hikari.password<span style=color:#f92672>=</span><span style=color:#ae81ff>123456</span>
<span style=color:#75715e>#hibernate.hikari.driverClassName=org.postgresql.Driver</span>
<span style=color:#75715e>#hibernate.hikari.jdbcUrl=jdbc:postgresql://127.0.0.1:5432/postgres</span>

hibernate.cache.use_query_cache<span style=color:#f92672>=</span>true
hibernate.cache.region.factory_class<span style=color:#f92672>=</span>org.hibernate.cache.infinispan.InfinispanRegionFactory
hibernate.cache.infinispan.cfg<span style=color:#f92672>=</span>org/hibernate/cache/infinispan/builder/infinispan-configs-local.xml
</code></pre></div><h3 id=hibernatecfgxml>hibernate.cfg.xml</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#75715e>&lt;?xml version=&#39;1.0&#39; encoding=&#39;utf-8&#39;?&gt;</span>
<span style=color:#75715e>&lt;!DOCTYPE hibernate-configuration PUBLIC
</span><span style=color:#75715e>        &#34;-//Hibernate/Hibernate Configuration DTD//EN&#34;
</span><span style=color:#75715e>        &#34;http://www.hibernate.org/dtd/hibernate-configuration-3.0.dtd&#34;&gt;</span>
<span style=color:#f92672>&lt;hibernate-configuration&gt;</span>
    <span style=color:#f92672>&lt;session-factory&gt;</span>
        <span style=color:#f92672>&lt;mapping</span> <span style=color:#a6e22e>class=</span><span style=color:#e6db74>&#34;entity.Account&#34;</span><span style=color:#f92672>/&gt;</span>
    <span style=color:#f92672>&lt;/session-factory&gt;</span>
<span style=color:#f92672>&lt;/hibernate-configuration&gt;</span>
</code></pre></div><h2 id=编程式事务管理>编程式事务管理</h2><h3 id=基于-transactiontemplate>基于 TransactionTemplate</h3><h4 id=entity>entity</h4><h5 id=account>Account</h5><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>package</span> entity

<span style=color:#66d9ef>import</span> org.hibernate.annotations.Cache
<span style=color:#66d9ef>import</span> org.hibernate.annotations.CacheConcurrencyStrategy
<span style=color:#66d9ef>import</span> javax.persistence.*

<span style=color:#a6e22e>@Entity</span>
<span style=color:#a6e22e>@Cache</span>(usage = CacheConcurrencyStrategy.READ_WRITE)     <span style=color:#960050;background-color:#1e0010>使用二级缓存</span>
<span style=color:#66d9ef>data</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Account</span>(
        <span style=color:#a6e22e>@Id</span>
        <span style=color:#a6e22e>@GeneratedValue</span>(strategy = GenerationType.IDENTITY)
        <span style=color:#66d9ef>val</span> id: Int? = <span style=color:#66d9ef>null</span>,
        <span style=color:#66d9ef>var</span> name: String? = <span style=color:#66d9ef>null</span>,
        <span style=color:#66d9ef>var</span> money: Int = <span style=color:#ae81ff>0</span>
)

Hibernate <span style=color:#960050;background-color:#1e0010>缓存策略：</span>
<span style=color:#960050;background-color:#1e0010>一级缓存：强制开启，以</span> Session        <span style=color:#960050;background-color:#1e0010>为单位。</span>
<span style=color:#960050;background-color:#1e0010>二级缓存：默认关闭，以</span> SessionFactory <span style=color:#960050;background-color:#1e0010>为单位。</span>
</code></pre></div><h4 id=dao>dao</h4><h5 id=accountdao>AccountDao</h5><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>package</span> dao

<span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>AccountDao</span> {
    <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>outMoney</span>(id: Int, money: Int)
    <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>inMoney</span>(id: Int, money: Int)
}
</code></pre></div><h5 id=accountdaoimpl>AccountDaoImpl</h5><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>package</span> dao

<span style=color:#66d9ef>import</span> entity.Account
<span style=color:#66d9ef>import</span> org.springframework.beans.factory.annotation.Autowired
<span style=color:#66d9ef>import</span> org.springframework.orm.hibernate5.HibernateTemplate
<span style=color:#66d9ef>import</span> org.springframework.stereotype.Component

<span style=color:#a6e22e>@Component</span>
<span style=color:#66d9ef>open</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AccountDaoImpl</span> : AccountDao {
    <span style=color:#a6e22e>@Autowired</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>lateinit</span> <span style=color:#66d9ef>var</span> hibernateTemplate: HibernateTemplate

    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>outMoney</span>(id: Int, money: Int) {
        <span style=color:#66d9ef>val</span> account = hibernateTemplate.<span style=color:#66d9ef>get</span>(Account<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>.java, id).apply { <span style=color:#66d9ef>this</span>.money <span style=color:#f92672>-=</span> money }
        hibernateTemplate.update(account)
    }

    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>inMoney</span>(id: Int, money: Int) {
        <span style=color:#66d9ef>val</span> account = hibernateTemplate.<span style=color:#66d9ef>get</span>(Account<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>.java, id).apply { <span style=color:#66d9ef>this</span>.money <span style=color:#f92672>+=</span> money }
        hibernateTemplate.update(account)
    }
}
</code></pre></div><h4 id=service>service</h4><h5 id=accountservice>AccountService</h5><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>package</span> service

<span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>AccountService</span> {
    <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>transfer</span>(<span style=color:#66d9ef>out</span>: Int, <span style=color:#a6e22e>`in</span><span style=color:#960050;background-color:#1e0010>`</span>: Int, money: Int)
}
</code></pre></div><h5 id=accountserviceimpl><strong>AccountServiceImpl</strong></h5><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>package</span> service

<span style=color:#66d9ef>import</span> dao.AccountDao
<span style=color:#66d9ef>import</span> org.springframework.beans.factory.annotation.Autowired
<span style=color:#66d9ef>import</span> org.springframework.stereotype.Component
<span style=color:#66d9ef>import</span> org.springframework.transaction.support.TransactionTemplate

<span style=color:#a6e22e>@Component</span>
<span style=color:#66d9ef>open</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AccountServiceImpl</span> : AccountService {
    <span style=color:#a6e22e>@Autowired</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>lateinit</span> <span style=color:#66d9ef>var</span> accountDao: AccountDao
    <span style=color:#a6e22e>@Autowired</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>lateinit</span> <span style=color:#66d9ef>var</span> transactionTemplate: TransactionTemplate     <span style=color:#960050;background-color:#1e0010>注入事务管理模板</span>

    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>transfer</span>(<span style=color:#66d9ef>out</span>: Int, <span style=color:#a6e22e>`in</span><span style=color:#960050;background-color:#1e0010>`</span>: Int, money: Int) {
        transactionTemplate.execute {     <span style=color:#960050;background-color:#1e0010>在同一个事务中执行</span>
            accountDao.outMoney(<span style=color:#66d9ef>out</span>, money)
            accountDao.inMoney(<span style=color:#a6e22e>`in</span><span style=color:#960050;background-color:#1e0010>`</span>, money)
        }
    }
}
</code></pre></div><h4 id=appconfig><strong>AppConfig</strong></h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>import</span> org.hibernate.SessionFactory
<span style=color:#66d9ef>import</span> org.hibernate.boot.MetadataSources
<span style=color:#66d9ef>import</span> org.hibernate.boot.registry.StandardServiceRegistryBuilder
<span style=color:#66d9ef>import</span> org.springframework.context.annotation.Bean
<span style=color:#66d9ef>import</span> org.springframework.context.annotation.ComponentScan
<span style=color:#66d9ef>import</span> org.springframework.context.annotation.Configuration
<span style=color:#66d9ef>import</span> org.springframework.orm.hibernate5.HibernateTemplate
<span style=color:#66d9ef>import</span> org.springframework.orm.hibernate5.HibernateTransactionManager
<span style=color:#66d9ef>import</span> org.springframework.transaction.support.TransactionTemplate

<span style=color:#a6e22e>@Configuration</span>
<span style=color:#a6e22e>@ComponentScan</span>(basePackages = arrayOf(<span style=color:#e6db74>&#34;dao&#34;</span>, <span style=color:#e6db74>&#34;service&#34;</span>))
<span style=color:#66d9ef>open</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AppConfig</span> {
    <span style=color:#a6e22e>@Bean</span>
    <span style=color:#66d9ef>open</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>sessionFactory</span>(): SessionFactory {
        <span style=color:#66d9ef>val</span> registry = StandardServiceRegistryBuilder().configure().build()
        <span style=color:#66d9ef>return</span> MetadataSources(registry).buildMetadata().buildSessionFactory()
    }

    <span style=color:#a6e22e>@Bean</span>
    <span style=color:#66d9ef>open</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>hibernateTemplate</span>(sessionFactory: SessionFactory): HibernateTemplate {
        <span style=color:#66d9ef>return</span> HibernateTemplate(sessionFactory)
    }

    <span style=color:#a6e22e>@Bean</span>
    <span style=color:#66d9ef>open</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>transactionManager</span>(sessionFactory: SessionFactory): HibernateTransactionManager {
        <span style=color:#66d9ef>return</span> HibernateTransactionManager(sessionFactory)
    }

    <span style=color:#f92672>----</span>

    <span style=color:#a6e22e>@Bean</span>
    <span style=color:#66d9ef>open</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>transactionTemplate</span>(transactionManager: HibernateTransactionManager): TransactionTemplate {
        <span style=color:#66d9ef>return</span> TransactionTemplate(transactionManager)     <span style=color:#960050;background-color:#1e0010>事务管理模板</span>
    }
}
</code></pre></div><h4 id=main>Main</h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>import</span> entity.Account
<span style=color:#66d9ef>import</span> org.hibernate.SessionFactory
<span style=color:#66d9ef>import</span> org.springframework.context.annotation.AnnotationConfigApplicationContext
<span style=color:#66d9ef>import</span> service.AccountService

<span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>main</span>(args: Array&lt;String&gt;) {
    System.setProperty(<span style=color:#e6db74>&#34;java.net.preferIPv4Stack&#34;</span>, <span style=color:#e6db74>&#34;true&#34;</span>)
    <span style=color:#66d9ef>val</span> context = AnnotationConfigApplicationContext(AppConfig<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>.java)

    context.getBean(SessionFactory<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>.java).openSession().use {
        <span style=color:#66d9ef>it</span>.beginTransaction()
        <span style=color:#66d9ef>it</span>.save(Account(name = <span style=color:#e6db74>&#34;张三&#34;</span>, money = <span style=color:#ae81ff>1000</span>))
        <span style=color:#66d9ef>it</span>.save(Account(name = <span style=color:#e6db74>&#34;李四&#34;</span>, money = <span style=color:#ae81ff>1000</span>))
        <span style=color:#66d9ef>it</span>.save(Account(name = <span style=color:#e6db74>&#34;王五&#34;</span>, money = <span style=color:#ae81ff>1000</span>))
        <span style=color:#66d9ef>it</span>.transaction.commit()
    }

    context.getBean(AccountService<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>.java).transfer(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>400</span>)

    context.destroy()
}
</code></pre></div><h2 id=声明式事务管理>声明式事务管理</h2><h3 id=基于-transactionproxyfactorybean>基于 TransactionProxyFactoryBean</h3><h4 id=略>略</h4><h4 id=serviceaccountserviceimpl>service.AccountServiceImpl</h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>package</span> service

<span style=color:#66d9ef>import</span> dao.AccountDao
<span style=color:#66d9ef>import</span> org.springframework.beans.factory.annotation.Autowired
<span style=color:#66d9ef>import</span> org.springframework.stereotype.Component

<span style=color:#a6e22e>@Component</span>
<span style=color:#66d9ef>open</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AccountServiceImpl</span> : AccountService {
    <span style=color:#a6e22e>@Autowired</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>lateinit</span> <span style=color:#66d9ef>var</span> accountDao: AccountDao

    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>transfer</span>(<span style=color:#66d9ef>out</span>: Int, <span style=color:#a6e22e>`in</span><span style=color:#960050;background-color:#1e0010>`</span>: Int, money: Int) {
        accountDao.outMoney(<span style=color:#66d9ef>out</span>, money)
        accountDao.inMoney(<span style=color:#a6e22e>`in</span><span style=color:#960050;background-color:#1e0010>`</span>, money)
    }
}
</code></pre></div><h4 id=appconfig-1><strong>AppConfig</strong></h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>import</span> org.hibernate.SessionFactory
<span style=color:#66d9ef>import</span> org.hibernate.boot.MetadataSources
<span style=color:#66d9ef>import</span> org.hibernate.boot.registry.StandardServiceRegistryBuilder
<span style=color:#66d9ef>import</span> org.springframework.context.annotation.Bean
<span style=color:#66d9ef>import</span> org.springframework.context.annotation.ComponentScan
<span style=color:#66d9ef>import</span> org.springframework.context.annotation.Configuration
<span style=color:#66d9ef>import</span> org.springframework.orm.hibernate5.HibernateTemplate
<span style=color:#66d9ef>import</span> org.springframework.orm.hibernate5.HibernateTransactionManager
<span style=color:#66d9ef>import</span> org.springframework.transaction.interceptor.TransactionProxyFactoryBean
<span style=color:#66d9ef>import</span> service.AccountService
<span style=color:#66d9ef>import</span> java.util.*

<span style=color:#a6e22e>@Configuration</span>
<span style=color:#a6e22e>@ComponentScan</span>(basePackages = arrayOf(<span style=color:#e6db74>&#34;dao&#34;</span>, <span style=color:#e6db74>&#34;service&#34;</span>))
<span style=color:#66d9ef>open</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AppConfig</span> {
    <span style=color:#a6e22e>@Bean</span>
    <span style=color:#66d9ef>open</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>sessionFactory</span>(): SessionFactory {
        <span style=color:#66d9ef>val</span> registry = StandardServiceRegistryBuilder().configure().build()
        <span style=color:#66d9ef>return</span> MetadataSources(registry).buildMetadata().buildSessionFactory()
    }

    <span style=color:#a6e22e>@Bean</span>
    <span style=color:#66d9ef>open</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>hibernateTemplate</span>(sessionFactory: SessionFactory): HibernateTemplate {
        <span style=color:#66d9ef>return</span> HibernateTemplate(sessionFactory)
    }

    <span style=color:#a6e22e>@Bean</span>
    <span style=color:#66d9ef>open</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>transactionManager</span>(sessionFactory: SessionFactory): HibernateTransactionManager {
        <span style=color:#66d9ef>return</span> HibernateTransactionManager(sessionFactory)
    }

    <span style=color:#f92672>----</span>

    <span style=color:#a6e22e>@Bean</span>
    <span style=color:#66d9ef>open</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>accountServiceProxy</span>(accountService: AccountService, transactionManager: HibernateTransactionManager): TransactionProxyFactoryBean {
        <span style=color:#66d9ef>return</span> TransactionProxyFactoryBean().apply {     <span style=color:#960050;background-color:#1e0010>代理对象</span>
            <span style=color:#66d9ef>this</span>.setTarget(accountService)     <span style=color:#960050;background-color:#1e0010>设置目标对象（增强对象）</span>
            <span style=color:#66d9ef>this</span>.setTransactionManager(transactionManager)     <span style=color:#960050;background-color:#1e0010>设置事务管理器</span>
            <span style=color:#66d9ef>this</span>.setTransactionAttributes(Properties().apply { <span style=color:#66d9ef>this</span>[<span style=color:#e6db74>&#34;*&#34;</span>] = <span style=color:#e6db74>&#34;PROPAGATION_REQUIRED&#34;</span> })     <span style=color:#960050;background-color:#1e0010>设置事务属性</span>
        }
    }
}
</code></pre></div><h4 id=main-1><strong>Main</strong></h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>import</span> entity.Account
<span style=color:#66d9ef>import</span> org.hibernate.SessionFactory
<span style=color:#66d9ef>import</span> org.springframework.context.annotation.AnnotationConfigApplicationContext
<span style=color:#66d9ef>import</span> service.AccountService

<span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>main</span>(args: Array&lt;String&gt;) {
    System.setProperty(<span style=color:#e6db74>&#34;java.net.preferIPv4Stack&#34;</span>, <span style=color:#e6db74>&#34;true&#34;</span>)
    <span style=color:#66d9ef>val</span> context = AnnotationConfigApplicationContext(AppConfig<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>.java)

    context.getBean(SessionFactory<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>.java).openSession().use {
        <span style=color:#66d9ef>it</span>.beginTransaction()
        <span style=color:#66d9ef>it</span>.save(Account(name = <span style=color:#e6db74>&#34;张三&#34;</span>, money = <span style=color:#ae81ff>1000</span>))
        <span style=color:#66d9ef>it</span>.save(Account(name = <span style=color:#e6db74>&#34;李四&#34;</span>, money = <span style=color:#ae81ff>1000</span>))
        <span style=color:#66d9ef>it</span>.save(Account(name = <span style=color:#e6db74>&#34;王五&#34;</span>, money = <span style=color:#ae81ff>1000</span>))
        <span style=color:#66d9ef>it</span>.transaction.commit()
    }

    context.getBean(<span style=color:#e6db74>&#34;accountServiceProxy&#34;</span>, AccountService<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>.java).transfer(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>400</span>)     <span style=color:#960050;background-color:#1e0010>使用代理对象</span>

    context.destroy()
}
</code></pre></div><h3 id=基于注解推荐>基于注解（推荐）</h3><h4 id=略-1>略</h4><h4 id=serviceaccountserviceimpl-1><strong>service.AccountServiceImpl</strong></h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>package</span> service

<span style=color:#66d9ef>import</span> dao.AccountDao
<span style=color:#66d9ef>import</span> org.springframework.beans.factory.annotation.Autowired
<span style=color:#66d9ef>import</span> org.springframework.stereotype.Component
<span style=color:#66d9ef>import</span> org.springframework.transaction.annotation.Transactional

<span style=color:#a6e22e>@Component</span>
<span style=color:#a6e22e>@Transactional</span>     <span style=color:#960050;background-color:#1e0010>使用事务</span>
<span style=color:#66d9ef>open</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AccountServiceImpl</span> : AccountService {
    <span style=color:#a6e22e>@Autowired</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>lateinit</span> <span style=color:#66d9ef>var</span> accountDao: AccountDao

    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>transfer</span>(<span style=color:#66d9ef>out</span>: Int, <span style=color:#a6e22e>`in</span><span style=color:#960050;background-color:#1e0010>`</span>: Int, money: Int) {
        accountDao.outMoney(<span style=color:#66d9ef>out</span>, money)
        accountDao.inMoney(<span style=color:#a6e22e>`in</span><span style=color:#960050;background-color:#1e0010>`</span>, money)
    }
}
</code></pre></div><h4 id=appconfig-2><strong>AppConfig</strong></h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>import</span> org.hibernate.SessionFactory
<span style=color:#66d9ef>import</span> org.hibernate.boot.MetadataSources
<span style=color:#66d9ef>import</span> org.hibernate.boot.registry.StandardServiceRegistryBuilder
<span style=color:#66d9ef>import</span> org.springframework.context.annotation.Bean
<span style=color:#66d9ef>import</span> org.springframework.context.annotation.ComponentScan
<span style=color:#66d9ef>import</span> org.springframework.context.annotation.Configuration
<span style=color:#66d9ef>import</span> org.springframework.orm.hibernate5.HibernateTemplate
<span style=color:#66d9ef>import</span> org.springframework.orm.hibernate5.HibernateTransactionManager
<span style=color:#66d9ef>import</span> org.springframework.transaction.annotation.EnableTransactionManagement

<span style=color:#a6e22e>@Configuration</span>
<span style=color:#a6e22e>@EnableTransactionManagement</span>     <span style=color:#960050;background-color:#1e0010>启用注解驱动的事务管理</span>
<span style=color:#a6e22e>@ComponentScan</span>(basePackages = arrayOf(<span style=color:#e6db74>&#34;dao&#34;</span>, <span style=color:#e6db74>&#34;service&#34;</span>))
<span style=color:#66d9ef>open</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AppConfig</span> {
    <span style=color:#a6e22e>@Bean</span>
    <span style=color:#66d9ef>open</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>sessionFactory</span>(): SessionFactory {
        <span style=color:#66d9ef>val</span> registry = StandardServiceRegistryBuilder().configure().build()
        <span style=color:#66d9ef>return</span> MetadataSources(registry).buildMetadata().buildSessionFactory()
    }

    <span style=color:#a6e22e>@Bean</span>
    <span style=color:#66d9ef>open</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>hibernateTemplate</span>(sessionFactory: SessionFactory): HibernateTemplate {
        <span style=color:#66d9ef>return</span> HibernateTemplate(sessionFactory)
    }

    <span style=color:#a6e22e>@Bean</span>
    <span style=color:#66d9ef>open</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>transactionManager</span>(sessionFactory: SessionFactory): HibernateTransactionManager {
        <span style=color:#66d9ef>return</span> HibernateTransactionManager(sessionFactory)
    }
}
</code></pre></div><h4 id=main-2>Main</h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>import</span> entity.Account
<span style=color:#66d9ef>import</span> org.hibernate.SessionFactory
<span style=color:#66d9ef>import</span> org.springframework.context.annotation.AnnotationConfigApplicationContext
<span style=color:#66d9ef>import</span> service.AccountService

<span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>main</span>(args: Array&lt;String&gt;) {
    System.setProperty(<span style=color:#e6db74>&#34;java.net.preferIPv4Stack&#34;</span>, <span style=color:#e6db74>&#34;true&#34;</span>)
    <span style=color:#66d9ef>val</span> context = AnnotationConfigApplicationContext(AppConfig<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>.java)

    context.getBean(SessionFactory<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>.java).openSession().use {
        <span style=color:#66d9ef>it</span>.beginTransaction()
        <span style=color:#66d9ef>it</span>.save(Account(name = <span style=color:#e6db74>&#34;张三&#34;</span>, money = <span style=color:#ae81ff>1000</span>))
        <span style=color:#66d9ef>it</span>.save(Account(name = <span style=color:#e6db74>&#34;李四&#34;</span>, money = <span style=color:#ae81ff>1000</span>))
        <span style=color:#66d9ef>it</span>.save(Account(name = <span style=color:#e6db74>&#34;王五&#34;</span>, money = <span style=color:#ae81ff>1000</span>))
        <span style=color:#66d9ef>it</span>.transaction.commit()
    }

    context.getBean(AccountService<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>.java).transfer(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>400</span>)

    context.destroy()
}
</code></pre></div></div><div class=sharing style=text-align:center><br><p>捐赠支持</p><p>如果我的文章对你有所帮助，欢迎通过支付宝的扫一扫，轻松的向我发起捐助。</p><p>对于你的支持，我会心怀感激且倍感荣幸地接受，并继续努力。</p><img src=https://ww4.sinaimg.cn/large/a15b4afegw1fbn096ql6dj20dw0dwwe9.jpg alt title data-action=zoom width=40%><p></p><br>&copy; 2015-2020 XhstormR</div></div></div></div><div id=backtop><a href=# title>TOP</a></div><nav id=TableOfContents><ul><li><a href=#concept>Concept</a></li><li><a href=#configuration>Configuration</a><ul><li><a href=#buildgradlekts>build.gradle.kts</a></li><li><a href=#hibernateproperties>hibernate.properties</a></li><li><a href=#hibernatecfgxml>hibernate.cfg.xml</a></li></ul></li><li><a href=#编程式事务管理>编程式事务管理</a><ul><li><a href=#基于-transactiontemplate>基于 TransactionTemplate</a></li></ul></li><li><a href=#声明式事务管理>声明式事务管理</a><ul><li><a href=#基于-transactionproxyfactorybean>基于 TransactionProxyFactoryBean</a></li><li><a href=#基于注解推荐>基于注解（推荐）</a></li></ul></li></ul></nav><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/languages/yaml.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/languages/kotlin.min.js></script><script>hljs.initHighlightingOnLoad()</script><script src=https://blog.xhstormr.tk/js/zoom.min.js></script><script>window.addEventListener("load",show),window.onscroll=show;function show(){document.documentElement.scrollTop+document.body.scrollTop>300?document.getElementById("backtop").style.display="block":document.getElementById("backtop").style.display="none"}</script><script type=text/javascript color=0,0,0 opacity=1 zindex=-2 count=49 src=https://cdnjs.cloudflare.com/ajax/libs/canvas-nest.js/2.0.4/canvas-nest.js></script></body></html>