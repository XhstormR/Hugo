<!doctype html><html lang=zh-cn manifest=https://blog.xhstormr.tk/offline.appcache><head><meta charset=utf-8><meta name=renderer content="webkit"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>Java Concurrency Lock &#183; XhstormR</title><link rel=alternate type=application/rss+xml title=XhstormR href><link rel=icon type=image/x-icon href=https://blog.xhstormr.tk/favicon.ico><link rel=stylesheet href=https://blog.xhstormr.tk/css/uno.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/styles/monokai-sublime.min.css><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js></script><script src=https://blog.xhstormr.tk/js/main.min.js async defer></script></head><body><div id=scriptHeader><span class="mobile btn-mobile-menu"><i class="fa fa-bars btn-mobile-menu__icon"></i>
<i class="fa fa-times btn-mobile-close__icon hidden"></i></span><header class="panel-cover panel-cover--collapsed"><div class=panel-main><div class="panel-main__inner panel-inverted"><div class=panel-main__content><h1 class="panel-cover__title panel-title"><a href=https://blog.xhstormr.tk/ title="link to homepage for XhstormR">XhstormR</a></h1><hr class=panel-cover__divider><p class=panel-cover__description>On a dark desert highway, cool wind in my hair.</p><hr class="panel-cover__divider panel-cover__divider--secondary"><div class=navigation-wrapper><nav class="cover-navigation cover-navigation--primary"><ul class=navigation><li class=navigation__item><a href=https://blog.xhstormr.tk#blog title="link to XhstormR blog" class=blog-button>Blog</a></li></ul></nav></div></div></div><div class=panel-cover--overlay></div></div></header></div><div class=bodytop><div class=content-wrapper><div class=content-wrapper__inner><div class=post><h1>Java Concurrency Lock</h1><span class=post-date>2017-08-01</span><p>Updated on 2017-08-05</p><blockquote><p><a href=https://docs.oracle.com/javase/10/docs/api/java/util/concurrent/locks/package-summary.html>https://docs.oracle.com/javase/10/docs/api/java/util/concurrent</a>
|
<a href=http://download.java.net/jdk/jdk-api-localizations/jdk-api-zh-cn/publish/1.6.0/html/zh_CN/api/java/util/concurrent/locks/package-summary.html>中文</a></p></blockquote><h2 id=concept>Concept</h2><ul><li>阻塞 -> Unsafe 类 -> park 操作</li></ul><h2 id=code>Code</h2><h3 id=锁>锁</h3><h4 id=locksupport>LockSupport</h4><ul><li>内部封装了 Unsafe 类的 park 操作。</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>import</span> java.util.concurrent.TimeUnit<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.locks.LockSupport<span style=color:#f92672>;</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Main</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        Thread a <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Thread<span style=color:#f92672>(()</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
            System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;a 开始阻塞 5s&#34;</span><span style=color:#f92672>);</span>
            LockSupport<span style=color:#f92672>.</span><span style=color:#a6e22e>parkUntil</span><span style=color:#f92672>(</span>System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>MILLISECONDS</span><span style=color:#f92672>.</span><span style=color:#a6e22e>convert</span><span style=color:#f92672>(</span>5<span style=color:#f92672>,</span> TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>SECONDS</span><span style=color:#f92672>));</span>     绝对时间
            或
            LockSupport<span style=color:#f92672>.</span><span style=color:#a6e22e>parkNanos</span><span style=color:#f92672>(</span>TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>NANOSECONDS</span><span style=color:#f92672>.</span><span style=color:#a6e22e>convert</span><span style=color:#f92672>(</span>5<span style=color:#f92672>,</span> TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>SECONDS</span><span style=color:#f92672>));</span>     相对时间
            System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;a 停止阻塞&#34;</span><span style=color:#f92672>);</span>
        <span style=color:#f92672>});</span>
        Thread b <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Thread<span style=color:#f92672>(()</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
            System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;b 开始阻塞 无期限&#34;</span><span style=color:#f92672>);</span>
            LockSupport<span style=color:#f92672>.</span><span style=color:#a6e22e>park</span><span style=color:#f92672>();</span>
            System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;b 停止阻塞&#34;</span><span style=color:#f92672>);</span>
        <span style=color:#f92672>});</span>
        Thread c <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Thread<span style=color:#f92672>(()</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
                TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>SECONDS</span><span style=color:#f92672>.</span><span style=color:#a6e22e>sleep</span><span style=color:#f92672>(</span>2<span style=color:#f92672>);</span>
                LockSupport<span style=color:#f92672>.</span><span style=color:#a6e22e>unpark</span><span style=color:#f92672>(</span>b<span style=color:#f92672>);</span>     线程停止阻塞
            <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InterruptedException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>});</span>

        a<span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
        b<span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
        c<span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
<span style=color:#f92672>----</span>
输出<span style=color:#960050;background-color:#1e0010>：</span>
a 开始阻塞 5s
b 开始阻塞 无期限
b 停止阻塞
a 停止阻塞
</code></pre></div><h4 id=reentrantlock>ReentrantLock</h4><ul><li>独占锁（排它锁）</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>import</span> java.util.concurrent.ExecutorService<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.Executors<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.TimeUnit<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.locks.ReentrantLock<span style=color:#f92672>;</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Main</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        ReentrantLock lock <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ReentrantLock<span style=color:#f92672>();</span>

        ExecutorService executorService <span style=color:#f92672>=</span> Executors<span style=color:#f92672>.</span><span style=color:#a6e22e>newCachedThreadPool</span><span style=color:#f92672>();</span>
        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> n <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> n <span style=color:#f92672>&lt;</span> 2<span style=color:#f92672>;</span> n<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
            executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(()</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
                System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; 争夺锁&#34;</span><span style=color:#f92672>);</span>
                lock<span style=color:#f92672>.</span><span style=color:#a6e22e>lock</span><span style=color:#f92672>();</span>     在 <span style=color:#66d9ef>try</span> 块外加锁
                <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
                    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; 获得锁&#34;</span><span style=color:#f92672>);</span>
                    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> 2<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
                        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; 运行中...&#34;</span><span style=color:#f92672>);</span>
                        TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>SECONDS</span><span style=color:#f92672>.</span><span style=color:#a6e22e>sleep</span><span style=color:#f92672>(</span>1<span style=color:#f92672>);</span>
                    <span style=color:#f92672>}</span>
                <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InterruptedException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>     处理中断异常
                    e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
                <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
                    lock<span style=color:#f92672>.</span><span style=color:#a6e22e>unlock</span><span style=color:#f92672>();</span>     在 <span style=color:#66d9ef>finally</span> 块中解锁
                    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; 释放锁&#34;</span><span style=color:#f92672>);</span>
                <span style=color:#f92672>}</span>
            <span style=color:#f92672>});</span>
        <span style=color:#f92672>}</span>
        executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>shutdown</span><span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
<span style=color:#f92672>----</span>
输出<span style=color:#960050;background-color:#1e0010>：</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>1 争夺锁
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>2 争夺锁
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>1 获得锁
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>1 运行中<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>1 运行中<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>1 释放锁
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>2 获得锁
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>2 运行中<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>2 运行中<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>2 释放锁
</code></pre></div><h4 id=reentrantreadwritelock>ReentrantReadWriteLock</h4><ul><li>读写锁<ul><li>读锁：<strong>共享锁</strong>，阻塞写锁　　　，同时只能有 <strong>多个读</strong>。</li><li>写锁：<strong>独占锁</strong>，阻塞写锁和读锁，同时只能有 <strong>一个写</strong>。</li></ul></li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>import</span> java.util.concurrent.ExecutorService<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.Executors<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.TimeUnit<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.locks.ReentrantReadWriteLock<span style=color:#f92672>;</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Main</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        ReentrantReadWriteLock lock <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ReentrantReadWriteLock<span style=color:#f92672>();</span>

        ExecutorService executorService <span style=color:#f92672>=</span> Executors<span style=color:#f92672>.</span><span style=color:#a6e22e>newCachedThreadPool</span><span style=color:#f92672>();</span>
        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> n <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> n <span style=color:#f92672>&lt;</span> 2<span style=color:#f92672>;</span> n<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
            executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(()</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
                System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; 争夺写锁&#34;</span><span style=color:#f92672>);</span>
                lock<span style=color:#f92672>.</span><span style=color:#a6e22e>writeLock</span><span style=color:#f92672>().</span><span style=color:#a6e22e>lock</span><span style=color:#f92672>();</span>
                <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
                    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; 获得写锁&#34;</span><span style=color:#f92672>);</span>
                    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> 2<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
                        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; 运行中...&#34;</span><span style=color:#f92672>);</span>
                        TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>SECONDS</span><span style=color:#f92672>.</span><span style=color:#a6e22e>sleep</span><span style=color:#f92672>(</span>1<span style=color:#f92672>);</span>
                    <span style=color:#f92672>}</span>
                <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InterruptedException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                    e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
                <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
                    lock<span style=color:#f92672>.</span><span style=color:#a6e22e>writeLock</span><span style=color:#f92672>().</span><span style=color:#a6e22e>unlock</span><span style=color:#f92672>();</span>
                    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; 释放写锁&#34;</span><span style=color:#f92672>);</span>
                <span style=color:#f92672>}</span>
            <span style=color:#f92672>});</span>
        <span style=color:#f92672>}</span>
        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> n <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> n <span style=color:#f92672>&lt;</span> 2<span style=color:#f92672>;</span> n<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
            executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(()</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
                System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; 争夺读锁&#34;</span><span style=color:#f92672>);</span>
                lock<span style=color:#f92672>.</span><span style=color:#a6e22e>readLock</span><span style=color:#f92672>().</span><span style=color:#a6e22e>lock</span><span style=color:#f92672>();</span>
                <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
                    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; 获得读锁&#34;</span><span style=color:#f92672>);</span>
                    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> 2<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
                        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; 运行中...&#34;</span><span style=color:#f92672>);</span>
                        TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>SECONDS</span><span style=color:#f92672>.</span><span style=color:#a6e22e>sleep</span><span style=color:#f92672>(</span>1<span style=color:#f92672>);</span>
                    <span style=color:#f92672>}</span>
                <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InterruptedException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                    e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
                <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
                    lock<span style=color:#f92672>.</span><span style=color:#a6e22e>readLock</span><span style=color:#f92672>().</span><span style=color:#a6e22e>unlock</span><span style=color:#f92672>();</span>
                    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; 释放读锁&#34;</span><span style=color:#f92672>);</span>
                <span style=color:#f92672>}</span>
            <span style=color:#f92672>});</span>
        <span style=color:#f92672>}</span>
        executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>shutdown</span><span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
<span style=color:#f92672>----</span>
输出<span style=color:#960050;background-color:#1e0010>：</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>1 争夺写锁
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>2 争夺写锁
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>1 获得写锁
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>1 运行中<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>3 争夺读锁
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>4 争夺读锁
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>1 运行中<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>1 释放写锁
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>2 获得写锁
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>2 运行中<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>2 运行中<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>2 释放写锁
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>3 获得读锁
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>3 运行中<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>4 获得读锁
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>4 运行中<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>3 运行中<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>4 运行中<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>3 释放读锁
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>4 释放读锁
</code></pre></div><h3 id=同步器>同步器</h3><h4 id=countdownlatch>CountDownLatch</h4><ul><li>一次性栅栏</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>import</span> java.util.concurrent.*<span style=color:#f92672>;</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Main</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>int</span> n <span style=color:#f92672>=</span> 3<span style=color:#f92672>;</span>
        CountDownLatch latch <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CountDownLatch<span style=color:#f92672>(</span>n<span style=color:#f92672>);</span>     初始阈值为 3

        ExecutorService executorService <span style=color:#f92672>=</span> Executors<span style=color:#f92672>.</span><span style=color:#a6e22e>newCachedThreadPool</span><span style=color:#f92672>();</span>
        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> 5<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
            executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(()</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
                    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; 等待中...&#34;</span><span style=color:#f92672>);</span>
                    latch<span style=color:#f92672>.</span><span style=color:#a6e22e>await</span><span style=color:#f92672>();</span>     等待阈值减为 0
                    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; 运行中...&#34;</span><span style=color:#f92672>);</span>
                <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InterruptedException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                    e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
                <span style=color:#f92672>}</span>
            <span style=color:#f92672>});</span>
        <span style=color:#f92672>}</span>
        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> n<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
            executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(()</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
                    TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>SECONDS</span><span style=color:#f92672>.</span><span style=color:#a6e22e>sleep</span><span style=color:#f92672>(</span>ThreadLocalRandom<span style=color:#f92672>.</span><span style=color:#a6e22e>current</span><span style=color:#f92672>().</span><span style=color:#a6e22e>nextInt</span><span style=color:#f92672>(</span>5<span style=color:#f92672>));</span>
                    latch<span style=color:#f92672>.</span><span style=color:#a6e22e>countDown</span><span style=color:#f92672>();</span>     阈值减 1
                    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; 运行...&#34;</span><span style=color:#f92672>);</span>
                <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InterruptedException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                    e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
                <span style=color:#f92672>}</span>
            <span style=color:#f92672>});</span>
        <span style=color:#f92672>}</span>
        executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>shutdown</span><span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
<span style=color:#f92672>----</span>
输出<span style=color:#960050;background-color:#1e0010>：</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>1 等待中<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>2 等待中<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>3 等待中<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>4 等待中<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>5 等待中<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>7 运行<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>6 运行<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>8 运行<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>1 运行中<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>5 运行中<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>4 运行中<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>2 运行中<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>3 运行中<span style=color:#f92672>...</span>
</code></pre></div><h4 id=cyclicbarrier>CyclicBarrier</h4><ul><li>循环同步栅栏</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>import</span> java.util.concurrent.*<span style=color:#f92672>;</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Main</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>int</span> n <span style=color:#f92672>=</span> 3<span style=color:#f92672>;</span>
        CyclicBarrier barrier <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CyclicBarrier<span style=color:#f92672>(</span>n<span style=color:#f92672>,</span> <span style=color:#f92672>()</span> <span style=color:#f92672>-&gt;</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;阶段性完成&#34;</span><span style=color:#f92672>));</span>     初始阈值为 3

        ExecutorService executorService <span style=color:#f92672>=</span> Executors<span style=color:#f92672>.</span><span style=color:#a6e22e>newCachedThreadPool</span><span style=color:#f92672>();</span>
        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> n<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
            executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(()</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
                    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> j <span style=color:#f92672>=</span> 1<span style=color:#f92672>;</span> j <span style=color:#f92672>&lt;=</span> 4<span style=color:#f92672>;</span> j<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
                        TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>SECONDS</span><span style=color:#f92672>.</span><span style=color:#a6e22e>sleep</span><span style=color:#f92672>(</span>ThreadLocalRandom<span style=color:#f92672>.</span><span style=color:#a6e22e>current</span><span style=color:#f92672>().</span><span style=color:#a6e22e>nextInt</span><span style=color:#f92672>(</span>5<span style=color:#f92672>));</span>
                        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; 完成任务 &#34;</span> <span style=color:#f92672>+</span> j<span style=color:#f92672>);</span>
                        barrier<span style=color:#f92672>.</span><span style=color:#a6e22e>await</span><span style=color:#f92672>();</span>     阈值减 1<span style=color:#960050;background-color:#1e0010>，</span>并等待阈值减为 0<span style=color:#960050;background-color:#1e0010>；</span>同步后<span style=color:#960050;background-color:#1e0010>，</span>重置阈值<span style=color:#960050;background-color:#1e0010>，</span>并调用回调事件
                    <span style=color:#f92672>}</span>
                <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InterruptedException <span style=color:#f92672>|</span> BrokenBarrierException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                    e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
                <span style=color:#f92672>}</span>
            <span style=color:#f92672>});</span>
        <span style=color:#f92672>}</span>
        executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>shutdown</span><span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
<span style=color:#f92672>----</span>
输出<span style=color:#960050;background-color:#1e0010>：</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>1 完成任务 1
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>3 完成任务 1
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>2 完成任务 1
阶段性完成
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>1 完成任务 2
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>3 完成任务 2
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>2 完成任务 2
阶段性完成
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>3 完成任务 3
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>2 完成任务 3
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>1 完成任务 3
阶段性完成
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>3 完成任务 4
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>1 完成任务 4
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>2 完成任务 4
阶段性完成
</code></pre></div><h4 id=semaphore>Semaphore</h4><ul><li>计数信号量</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>import</span> java.util.concurrent.ExecutorService<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.Executors<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.Semaphore<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.TimeUnit<span style=color:#f92672>;</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Main</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        Semaphore semaphore <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Semaphore<span style=color:#f92672>(</span>3<span style=color:#f92672>);</span>     信号量<span style=color:#960050;background-color:#1e0010>（</span>最大并发量<span style=color:#960050;background-color:#1e0010>）</span>为 3

        ExecutorService executorService <span style=color:#f92672>=</span> Executors<span style=color:#f92672>.</span><span style=color:#a6e22e>newCachedThreadPool</span><span style=color:#f92672>();</span>
        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> n <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> n <span style=color:#f92672>&lt;</span> 5<span style=color:#f92672>;</span> n<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
            executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(()</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
                    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; 等待信号...&#34;</span><span style=color:#f92672>);</span>
                    semaphore<span style=color:#f92672>.</span><span style=color:#a6e22e>acquire</span><span style=color:#f92672>();</span>     获得信号<span style=color:#960050;background-color:#1e0010>（</span>应该在 <span style=color:#66d9ef>try</span> 块外获得信号<span style=color:#960050;background-color:#1e0010>，</span>以防止不必要的释放信号<span style=color:#960050;background-color:#1e0010>）</span>
                    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; 获得信号...&#34;</span><span style=color:#f92672>);</span>
                    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> 2<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
                        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; 运行中...&#34;</span><span style=color:#f92672>);</span>
                        TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>SECONDS</span><span style=color:#f92672>.</span><span style=color:#a6e22e>sleep</span><span style=color:#f92672>(</span>1<span style=color:#f92672>);</span>
                    <span style=color:#f92672>}</span>
                <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InterruptedException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                    e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
                <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
                    semaphore<span style=color:#f92672>.</span><span style=color:#a6e22e>release</span><span style=color:#f92672>();</span>     释放信号
                    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; 释放信号...&#34;</span><span style=color:#f92672>);</span>
                <span style=color:#f92672>}</span>
            <span style=color:#f92672>});</span>
        <span style=color:#f92672>}</span>
        executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>shutdown</span><span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
<span style=color:#f92672>----</span>
输出<span style=color:#960050;background-color:#1e0010>：</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>1 等待信号<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>2 等待信号<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>3 等待信号<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>1 获得信号<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>2 获得信号<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>1 运行中<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>3 获得信号<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>3 运行中<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>2 运行中<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>4 等待信号<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>5 等待信号<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>1 运行中<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>2 运行中<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>3 运行中<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>2 释放信号<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>4 获得信号<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>4 运行中<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>1 释放信号<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>3 释放信号<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>5 获得信号<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>5 运行中<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>4 运行中<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>5 运行中<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>5 释放信号<span style=color:#f92672>...</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>4 释放信号<span style=color:#f92672>...</span>
</code></pre></div><h4 id=exchanger>Exchanger</h4><ul><li>用于在 <strong>成对</strong> 的线程之间 <strong>同步交换数据</strong>。</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>import</span> java.util.concurrent.*<span style=color:#f92672>;</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Main</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        Exchanger<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> exchanger <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Exchanger<span style=color:#f92672>&lt;&gt;();</span>

        ExecutorService executorService <span style=color:#f92672>=</span> Executors<span style=color:#f92672>.</span><span style=color:#a6e22e>newCachedThreadPool</span><span style=color:#f92672>();</span>
        executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(()</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
                String s <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34; A&#34;</span><span style=color:#f92672>;</span>
                System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> s<span style=color:#f92672>);</span>
                TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>SECONDS</span><span style=color:#f92672>.</span><span style=color:#a6e22e>sleep</span><span style=color:#f92672>(</span>ThreadLocalRandom<span style=color:#f92672>.</span><span style=color:#a6e22e>current</span><span style=color:#f92672>().</span><span style=color:#a6e22e>nextInt</span><span style=color:#f92672>(</span>5<span style=color:#f92672>));</span>
                s <span style=color:#f92672>=</span> exchanger<span style=color:#f92672>.</span><span style=color:#a6e22e>exchange</span><span style=color:#f92672>(</span>s<span style=color:#f92672>);</span>     等待另一个线程调用 exchange 方法<span style=color:#960050;background-color:#1e0010>，</span>同步交换数据
                System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> s<span style=color:#f92672>);</span>
            <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InterruptedException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>});</span>
        executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(()</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
                String s <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34; B&#34;</span><span style=color:#f92672>;</span>
                System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> s<span style=color:#f92672>);</span>
                TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>SECONDS</span><span style=color:#f92672>.</span><span style=color:#a6e22e>sleep</span><span style=color:#f92672>(</span>ThreadLocalRandom<span style=color:#f92672>.</span><span style=color:#a6e22e>current</span><span style=color:#f92672>().</span><span style=color:#a6e22e>nextInt</span><span style=color:#f92672>(</span>5<span style=color:#f92672>));</span>
                s <span style=color:#f92672>=</span> exchanger<span style=color:#f92672>.</span><span style=color:#a6e22e>exchange</span><span style=color:#f92672>(</span>s<span style=color:#f92672>);</span>
                System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> s<span style=color:#f92672>);</span>
            <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InterruptedException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>});</span>
        executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>shutdown</span><span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
<span style=color:#f92672>----</span>
输出<span style=color:#960050;background-color:#1e0010>：</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>1 A
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>2 B
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>1 B
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>2 A
</code></pre></div><h4 id=phaser>Phaser</h4><ul><li>把多个线程 <strong>协同</strong> 执行的任务划分为 <strong>多个</strong> 阶段。<ul><li>每个 <strong>阶段</strong> 可以为其加入 <strong>任意</strong> 数量的线程。</li><li>每个 <strong>线程</strong> 可以 <strong>随时</strong> 注册并参与某个阶段。</li></ul></li></ul><h5 id=模拟-countdownlatch>模拟 CountDownLatch</h5><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>import</span> java.util.concurrent.*<span style=color:#f92672>;</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Main</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> n <span style=color:#f92672>=</span> 3<span style=color:#f92672>;</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Phaser phaser <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Phaser<span style=color:#f92672>(</span>n<span style=color:#f92672>);</span>     线程的初始注册数为 3

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> InterruptedException <span style=color:#f92672>{</span>
        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>show<span style=color:#f92672>());</span>     <span style=color:#75715e>//3 = 0 + 3
</span><span style=color:#75715e></span>
        ExecutorService executorService <span style=color:#f92672>=</span> Executors<span style=color:#f92672>.</span><span style=color:#a6e22e>newCachedThreadPool</span><span style=color:#f92672>();</span>
        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> 5<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
            executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(()</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
                    phaser<span style=color:#f92672>.</span><span style=color:#a6e22e>register</span><span style=color:#f92672>();</span>     注册线程<span style=color:#960050;background-color:#1e0010>（</span>注册数加 1<span style=color:#960050;background-color:#1e0010>）</span>
                    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>show<span style=color:#f92672>()</span> <span style=color:#f92672>+</span> Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; 等待中...&#34;</span><span style=color:#f92672>);</span>
                    TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>SECONDS</span><span style=color:#f92672>.</span><span style=color:#a6e22e>sleep</span><span style=color:#f92672>(</span>1<span style=color:#f92672>);</span>
                    phaser<span style=color:#f92672>.</span><span style=color:#a6e22e>arriveAndAwaitAdvance</span><span style=color:#f92672>();</span>     线程到达并等待所有线程到达<span style=color:#960050;background-color:#1e0010>（</span>注册数 <span style=color:#f92672>==</span> 到达数<span style=color:#960050;background-color:#1e0010>）；</span>同步后<span style=color:#960050;background-color:#1e0010>，</span>重置为未到达状态<span style=color:#960050;background-color:#1e0010>，</span>进入下一个阶段
                    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>show<span style=color:#f92672>()</span> <span style=color:#f92672>+</span> Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; 运行中...&#34;</span><span style=color:#f92672>);</span>
                <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InterruptedException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                    e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
                <span style=color:#f92672>}</span>
            <span style=color:#f92672>});</span>
        <span style=color:#f92672>}</span>
        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> n<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
            executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(()</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
                    TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>SECONDS</span><span style=color:#f92672>.</span><span style=color:#a6e22e>sleep</span><span style=color:#f92672>(</span>ThreadLocalRandom<span style=color:#f92672>.</span><span style=color:#a6e22e>current</span><span style=color:#f92672>().</span><span style=color:#a6e22e>nextInt</span><span style=color:#f92672>(</span>3<span style=color:#f92672>,</span> 10<span style=color:#f92672>));</span>
                    phaser<span style=color:#f92672>.</span><span style=color:#a6e22e>arriveAndDeregister</span><span style=color:#f92672>();</span>     线程到达并进行注销<span style=color:#960050;background-color:#1e0010>（</span>注册数减 1<span style=color:#960050;background-color:#1e0010>）</span>
                    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>show<span style=color:#f92672>()</span> <span style=color:#f92672>+</span> Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; 运行...&#34;</span><span style=color:#f92672>);</span>
                <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InterruptedException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                    e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
                <span style=color:#f92672>}</span>
            <span style=color:#f92672>});</span>
        <span style=color:#f92672>}</span>

        TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>SECONDS</span><span style=color:#f92672>.</span><span style=color:#a6e22e>sleep</span><span style=color:#f92672>(</span>2<span style=color:#f92672>);</span>
        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>show<span style=color:#f92672>());</span>     <span style=color:#75715e>//8 = 5 + 3
</span><span style=color:#75715e></span>
        executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>shutdown</span><span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> String <span style=color:#a6e22e>show</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        注册数 <span style=color:#f92672>=</span> 到达数 <span style=color:#f92672>+</span> 未到达数
        <span style=color:#66d9ef>return</span> String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;%d = %d + %d &#34;</span><span style=color:#f92672>,</span>
                phaser<span style=color:#f92672>.</span><span style=color:#a6e22e>getRegisteredParties</span><span style=color:#f92672>(),</span>    当前  注册数
                phaser<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span>   <span style=color:#a6e22e>ArrivedParties</span><span style=color:#f92672>(),</span>    当前  到达数
                phaser<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span> <span style=color:#a6e22e>UnarrivedParties</span><span style=color:#f92672>());</span>   当前未到达数
              <span style=color:#75715e>//phaser.get            Phase()     当前阶段
</span><span style=color:#75715e></span>    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
<span style=color:#f92672>----</span>
输出<span style=color:#960050;background-color:#1e0010>：</span>
3 <span style=color:#f92672>=</span> 0 <span style=color:#f92672>+</span> 3
4 <span style=color:#f92672>=</span> 0 <span style=color:#f92672>+</span> 4 pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>1 等待中<span style=color:#f92672>...</span>
5 <span style=color:#f92672>=</span> 0 <span style=color:#f92672>+</span> 5 pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>2 等待中<span style=color:#f92672>...</span>
6 <span style=color:#f92672>=</span> 0 <span style=color:#f92672>+</span> 6 pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>3 等待中<span style=color:#f92672>...</span>
7 <span style=color:#f92672>=</span> 0 <span style=color:#f92672>+</span> 7 pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>4 等待中<span style=color:#f92672>...</span>
8 <span style=color:#f92672>=</span> 0 <span style=color:#f92672>+</span> 8 pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>5 等待中<span style=color:#f92672>...</span>
8 <span style=color:#f92672>=</span> 5 <span style=color:#f92672>+</span> 3
7 <span style=color:#f92672>=</span> 5 <span style=color:#f92672>+</span> 2 pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>8 运行<span style=color:#f92672>...</span>
6 <span style=color:#f92672>=</span> 5 <span style=color:#f92672>+</span> 1 pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>6 运行<span style=color:#f92672>...</span>
5 <span style=color:#f92672>=</span> 0 <span style=color:#f92672>+</span> 5 pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>7 运行<span style=color:#f92672>...</span>
5 <span style=color:#f92672>=</span> 0 <span style=color:#f92672>+</span> 5 pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>4 运行中<span style=color:#f92672>...</span>
5 <span style=color:#f92672>=</span> 0 <span style=color:#f92672>+</span> 5 pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>5 运行中<span style=color:#f92672>...</span>
5 <span style=color:#f92672>=</span> 0 <span style=color:#f92672>+</span> 5 pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>2 运行中<span style=color:#f92672>...</span>
5 <span style=color:#f92672>=</span> 0 <span style=color:#f92672>+</span> 5 pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>3 运行中<span style=color:#f92672>...</span>
5 <span style=color:#f92672>=</span> 0 <span style=color:#f92672>+</span> 5 pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>1 运行中<span style=color:#f92672>...</span>
</code></pre></div><h5 id=模拟-cyclicbarrier>模拟 CyclicBarrier</h5><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>import</span> java.util.concurrent.*<span style=color:#f92672>;</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Main</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>int</span> n <span style=color:#f92672>=</span> 3<span style=color:#f92672>;</span>     线程的初始注册数
        <span style=color:#66d9ef>int</span> m <span style=color:#f92672>=</span> 4<span style=color:#f92672>;</span>     阶段的数量
        Phaser phaser <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Phaser<span style=color:#f92672>(</span>n<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            <span style=color:#a6e22e>@Override</span>                 <span style=color:#75715e>//（当前阶段，当前注册数）
</span><span style=color:#75715e></span>            <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>onAdvance</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> phase<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> registeredParties<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>     重写回调事件
                System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;阶段性完成&#34;</span><span style=color:#f92672>);</span>
                <span style=color:#66d9ef>return</span> phase <span style=color:#f92672>&gt;=</span> <span style=color:#f92672>(</span>m <span style=color:#f92672>-</span> 1<span style=color:#f92672>)</span> <span style=color:#f92672>||</span> registeredParties <span style=color:#f92672>==</span> 0<span style=color:#f92672>;</span>     是否进入终止状态<span style=color:#960050;background-color:#1e0010>（</span><span style=color:#66d9ef>true</span> 终止<span style=color:#960050;background-color:#1e0010>，</span><span style=color:#66d9ef>false</span> 继续<span style=color:#960050;background-color:#1e0010>）</span>
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>};</span>

        ExecutorService executorService <span style=color:#f92672>=</span> Executors<span style=color:#f92672>.</span><span style=color:#a6e22e>newCachedThreadPool</span><span style=color:#f92672>();</span>
        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> n<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
            executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(()</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
                    <span style=color:#66d9ef>while</span> <span style=color:#f92672>(!</span>phaser<span style=color:#f92672>.</span><span style=color:#a6e22e>isTerminated</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>     是否处于终止状态
                        TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>SECONDS</span><span style=color:#f92672>.</span><span style=color:#a6e22e>sleep</span><span style=color:#f92672>(</span>ThreadLocalRandom<span style=color:#f92672>.</span><span style=color:#a6e22e>current</span><span style=color:#f92672>().</span><span style=color:#a6e22e>nextInt</span><span style=color:#f92672>(</span>5<span style=color:#f92672>));</span>
                        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; 完成任务 &#34;</span> <span style=color:#f92672>+</span> <span style=color:#f92672>(</span>phaser<span style=color:#f92672>.</span><span style=color:#a6e22e>getPhase</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> 1<span style=color:#f92672>));</span>     获得当前阶段
                        phaser<span style=color:#f92672>.</span><span style=color:#a6e22e>arriveAndAwaitAdvance</span><span style=color:#f92672>();</span>     线程到达并等待所有线程到达<span style=color:#960050;background-color:#1e0010>（</span>注册数 <span style=color:#f92672>==</span> 到达数<span style=color:#960050;background-color:#1e0010>）；</span>同步后<span style=color:#960050;background-color:#1e0010>，</span>重置为未到达状态<span style=color:#960050;background-color:#1e0010>，</span>进入下一个阶段
                    <span style=color:#f92672>}</span>
                <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InterruptedException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                    e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
                <span style=color:#f92672>}</span>
            <span style=color:#f92672>});</span>
        <span style=color:#f92672>}</span>
        executorService<span style=color:#f92672>.</span><span style=color:#a6e22e>shutdown</span><span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
<span style=color:#f92672>----</span>
输出<span style=color:#960050;background-color:#1e0010>：</span>
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>3 完成任务 1
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>2 完成任务 1
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>1 完成任务 1
阶段性完成
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>3 完成任务 2
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>1 完成任务 2
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>2 完成任务 2
阶段性完成
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>3 完成任务 3
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>2 完成任务 3
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>1 完成任务 3
阶段性完成
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>3 完成任务 4
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>2 完成任务 4
pool<span style=color:#f92672>-</span>1<span style=color:#f92672>-</span>thread<span style=color:#f92672>-</span>1 完成任务 4
阶段性完成
</code></pre></div></div><div class=sharing style=text-align:center><br><p>捐赠支持</p><p>如果我的文章对你有所帮助，欢迎通过支付宝的扫一扫，轻松的向我发起捐助。</p><p>对于你的支持，我会心怀感激且倍感荣幸地接受，并继续努力。</p><img src=https://ww4.sinaimg.cn/large/a15b4afegw1fbn096ql6dj20dw0dwwe9.jpg alt title data-action=zoom width=40%><p></p><br>&copy; 2015-2020 XhstormR</div></div></div></div><div id=backtop><a href=# title>TOP</a></div><nav id=TableOfContents><ul><li><a href=#concept>Concept</a></li><li><a href=#code>Code</a><ul><li><a href=#锁>锁</a></li><li><a href=#同步器>同步器</a></li></ul></li></ul></nav><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/languages/yaml.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/languages/kotlin.min.js></script><script>hljs.initHighlightingOnLoad()</script><script src=https://blog.xhstormr.tk/js/zoom.min.js></script><script>window.addEventListener("load",show),window.onscroll=show;function show(){document.documentElement.scrollTop+document.body.scrollTop>300?document.getElementById("backtop").style.display="block":document.getElementById("backtop").style.display="none"}</script><script type=text/javascript color=0,0,0 opacity=1 zindex=-2 count=49 src=https://cdnjs.cloudflare.com/ajax/libs/canvas-nest.js/2.0.4/canvas-nest.js></script></body></html>