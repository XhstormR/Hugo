<!doctype html><html lang=zh-cn manifest=https://blog.xhstormr.tk/offline.appcache><head><meta charset=utf-8><meta name=renderer content="webkit"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>自学 PostgreSQL &#183; XhstormR</title><link rel=alternate type=application/rss+xml title=XhstormR href><link rel=icon type=image/x-icon href=https://blog.xhstormr.tk/favicon.ico><link rel=stylesheet href=https://blog.xhstormr.tk/css/uno.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/styles/monokai-sublime.min.css><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js></script><script src=https://blog.xhstormr.tk/js/main.min.js async defer></script></head><body><div id=scriptHeader><span class="mobile btn-mobile-menu"><i class="fa fa-bars btn-mobile-menu__icon"></i>
<i class="fa fa-times btn-mobile-close__icon hidden"></i></span><header class="panel-cover panel-cover--collapsed"><div class=panel-main><div class="panel-main__inner panel-inverted"><div class=panel-main__content><h1 class="panel-cover__title panel-title"><a href=https://blog.xhstormr.tk/ title="link to homepage for XhstormR">XhstormR</a></h1><hr class=panel-cover__divider><p class=panel-cover__description>On a dark desert highway, cool wind in my hair.</p><hr class="panel-cover__divider panel-cover__divider--secondary"><div class=navigation-wrapper><nav class="cover-navigation cover-navigation--primary"><ul class=navigation><li class=navigation__item><a href=https://blog.xhstormr.tk#blog title="link to XhstormR blog" class=blog-button>Blog</a></li></ul></nav></div></div></div><div class=panel-cover--overlay></div></div></header></div><div class=bodytop><div class=content-wrapper><div class=content-wrapper__inner><div class=post><h1>自学 PostgreSQL</h1><span class=post-date>2017-02-19</span><p>Updated on 2017-02-19</p><blockquote><p style=text-align:center><img data-src=/uploads/postgresql.svg alt title=PostgreSQL data-action=zoom width=375></p><script>[].forEach.call(document.querySelectorAll("img[data-src]"),function(a){a.setAttribute("src",a.getAttribute("data-src")),a.onload=function(){a.removeAttribute("data-src")}})</script><p><a href=https://www.postgresql.org/>https://www.postgresql.org/</a></p><p><a href=https://jdbc.postgresql.org/download.html>https://jdbc.postgresql.org/download.html</a></p><p><a href=https://www.postgresql.org/docs/current/index.html>https://www.postgresql.org/docs/current/index.html</a></p><p><a href=https://github.com/pgjdbc/pgjdbc>https://github.com/pgjdbc/pgjdbc</a></p><p><a href=https://github.com/postgis/postgis>https://github.com/postgis/postgis</a></p><p><a href=https://github.com/postgres/postgres>https://github.com/postgres/postgres</a></p><p><a href=https://jcenter.bintray.com/org/postgresql/postgresql/>https://jcenter.bintray.com/org/postgresql/postgresql/</a></p><p><a href=https://yum.postgresql.org/repopackages.php>https://yum.postgresql.org/repopackages.php</a></p><p><a href=https://www.enterprisedb.com/download-postgresql-binaries>Step 1</a>
|
<a href="https://www.enterprisedb.com/thank-you?anid=1255499">Step 2</a>
|
<a href=https://get.enterprisedb.com/postgresql/postgresql-10.4-1-windows-x64-binaries.zip>Step 3</a></p></blockquote><h2 id=concept>Concept</h2><ul><li>结构化查询语言（SQL）：Structured Query Language<ul><li>数据定义语言（DDL）：Data Definition Language<ul><li>用于建立（CREATE）、修改（ALTER）、删除（DROP）数据库对象。</li></ul></li><li>数据操纵语言（DML）：Data Manipulation Language<ul><li>用于改变（INSERT、UPDATE、DELETE）数据库数据。</li></ul></li><li>数据查询语言（DQL）：Data Query Language<ul><li>用于查询（SELECT）所需要的数据。</li></ul></li><li>数据控制语言（DCL）：Data Control Language<ul><li>用于权限的授予（GRANT）和收回（REVOKE），创建用户（CREATE USER）。</li></ul></li><li>事务控制语言（TCL）：Transaction Control Language<ul><li>用于维护数据一致性的语句，包括提交（COMMIT）、回滚（ROLLBACK）、保存点（SAVEPOINT）。</li></ul></li></ul></li><li>增删改查（CRUD）： SQL；HTTP<ul><li><strong>增</strong>加（<strong>C</strong>reate）：INSERT；POST（非幂等）</li><li><strong>查</strong>询（<strong>R</strong>etrieve）：SELECT；GET</li><li>修<strong>改</strong>（<strong>U</strong>pdate）：UPDATE；PATCH（更新资源：非幂等），PUT（替换资源：幂等）</li><li><strong>删</strong>除（<strong>D</strong>elete）：DELETE；DELETE</li></ul></li><li>事务（Transaction）：逻辑上的 <strong>一组操作</strong>，这组操作只能一起成功或者一起失败。<ul><li>数据库中 <strong>保证事务可靠</strong> 的机制（ACID）。<ul><li>原子性（<strong>A</strong>tomicity）：对于数据修改，要么全都执行，要么全都不执行。</li><li>一致性（<strong>C</strong>onsistency）：所有的数据都保持一致状态。</li><li>隔离性（<strong>I</strong>solation）：与其它并发事务所作的修改隔离。</li><li>持久性（<strong>D</strong>urability）：对于系统的影响是永久性的。</li></ul></li></ul></li><li>数据访问对象（DAO）：Data Access Object<ul><li>用于封装所有对数据库的访问，使数据访问逻辑和业务逻辑分开。</li><li>数据传递对象<ul><li>值对象（Value Object）</li><li>实体对象（Entity）</li></ul></li></ul></li><li>对象关系映射（ORM）：Object Relation Mapping
* <strong>类</strong>中的<strong>对象</strong>的<strong>属性</strong>（Java）&lt;— 映射（ORM） —><strong>表</strong>中的<strong>记录</strong>的<strong>字段</strong>（Database）</li></ul><h2 id=initial>Initial</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>initdb.exe -A scram-sha-256 -E UTF8 --no-locale --lc-messages<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Chinese (Simplified)_China.936&#34;</span> -U <span style=color:#ae81ff>123</span> -W -D D:<span style=color:#ae81ff>\1</span><span style=color:#ae81ff>2345</span>
pg_ctl.exe -l D:<span style=color:#ae81ff>\l</span>og.txt -D D:<span style=color:#ae81ff>\1</span><span style=color:#ae81ff>2345</span> start
pg_ctl.exe -l D:<span style=color:#ae81ff>\l</span>og.txt -D D:<span style=color:#ae81ff>\1</span><span style=color:#ae81ff>2345</span> status
pg_ctl.exe -l D:<span style=color:#ae81ff>\l</span>og.txt -D D:<span style=color:#ae81ff>\1</span><span style=color:#ae81ff>2345</span> stop
psql.exe -e -E -h 127.0.0.1 -p <span style=color:#ae81ff>5432</span> -U <span style=color:#ae81ff>123</span> -W -d postgres

compile<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;org.postgresql:postgresql:+&#34;</span><span style=color:#f92672>)</span>

导出：pg_dump -h 127.0.0.1 -p <span style=color:#ae81ff>5432</span> -U <span style=color:#ae81ff>123</span> -W -d postgres -n erp -Fc -f data.dump
导入：pg_restore -h 127.0.0.1 -p <span style=color:#ae81ff>5432</span> -U <span style=color:#ae81ff>123</span> -W -d postgres -c data.dump
</code></pre></div><h2 id=operate>Operate</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#ae81ff>\c</span>     切换数据库
<span style=color:#ae81ff>\l</span>     列出数据库
<span style=color:#ae81ff>\d</span>     列出表、序列、视图
<span style=color:#ae81ff>\d</span>t     列出表
<span style=color:#ae81ff>\d</span>u     列出角色
<span style=color:#ae81ff>\d</span>n     列出模式
<span style=color:#ae81ff>\d</span>f     列出函数
<span style=color:#ae81ff>\d</span>x     列出扩展

<span style=color:#ae81ff>\g</span>     执行查询缓存区
<span style=color:#ae81ff>\p</span>     显示查询缓存区
<span style=color:#ae81ff>\r</span>     重置查询缓存区
<span style=color:#ae81ff>\e</span>     使用外部编辑器编辑查询缓存区
<span style=color:#ae81ff>\w</span>     将当前查询缓存区写至文件
<span style=color:#ae81ff>\o</span>     将所有查询结果写至文件
<span style=color:#ae81ff>\i</span>     将文件写至查询缓存区

<span style=color:#ae81ff>\x</span>     垂直显示查询结果（<span style=color:#ae81ff>\x\g\x</span>）
<span style=color:#ae81ff>\t</span>     只显示查询结果（无页眉和页脚）
<span style=color:#ae81ff>\H</span>     切换为 HTML 输出模式

<span style=color:#ae81ff>\q</span>     退出 psql
<span style=color:#ae81ff>\h</span>     SQL 语法说明
<span style=color:#ae81ff>\!</span>     执行外部命令
<span style=color:#ae81ff>\s</span>et PROMPT1 <span style=color:#ae81ff>123</span>     设置提示符（https://www.postgresql.org/docs/current/app-psql.html#APP-PSQL-PROMPTING）
<span style=color:#ae81ff>\p</span>set pager off     关闭分页
<span style=color:#ae81ff>\t</span>iming     计时
<span style=color:#ae81ff>\c</span>onninfo     显示连接信息
<span style=color:#ae81ff>\p</span>assword     修改密码
<span style=color:#ae81ff>\e</span>ncoding     修改客户端编码

show all;     显示所有系统信息
show config_file;     显示系统配置文件
show server_version;     显示系统版本
show server_encoding;     显示服务端编码
show client_encoding;     显示客户端编码

<span style=color:#66d9ef>select</span> version<span style=color:#f92672>()</span>;     显示系统版本
<span style=color:#66d9ef>select</span> now<span style=color:#f92672>()</span>;     显示当前日期+时间
<span style=color:#66d9ef>select</span> current_timestamp;     显示当前日期+时间
<span style=color:#66d9ef>select</span> current_date;     显示当前日期
<span style=color:#66d9ef>select</span> current_time;     显示当前时间
<span style=color:#66d9ef>select</span> current_user;     显示当前用户
<span style=color:#66d9ef>select</span> current_database<span style=color:#f92672>()</span>;     显示当前数据库
<span style=color:#66d9ef>select</span> pg_postmaster_start_time<span style=color:#f92672>()</span>;     显示系统启动日期

<span style=color:#f92672>{}</span>     必选项
<span style=color:#f92672>[]</span>     可选项
|     选择分隔符

<span style=color:#e6db74>&#39;&#39;</span>     表示字符串
<span style=color:#e6db74>&#34;&#34;</span>     表示标识符（用于区分大小写和关键字；不常用，因为一般情况下标识符都为小写，并且不会与关键字重名，空格用 <span style=color:#e6db74>&#39;_&#39;</span> 代替）
     建议双引号要么都带，要么都不带。
</code></pre></div><h2 id=table>Table</h2><h3 id=create>Create</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>TABLE</span> a;

<span style=color:#75715e>-------------------------------------------------------
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> a (
  id    INTEGER,
  name  TEXT,
  price NUMERIC
);

<span style=color:#75715e>-------------------------------------------------------
</span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>缺省值字段</span>

<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> a (
  id    SERIAL,     <span style=color:#960050;background-color:#1e0010>整形自增</span>
  name  TEXT,
  price NUMERIC <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>9</span>.<span style=color:#ae81ff>99</span>     <span style=color:#960050;background-color:#1e0010>默认值</span>
);

<span style=color:#75715e>-------------------------------------------------------
</span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>表约束和列约束的区别是声明的位置不一样。</span>

<span style=color:#960050;background-color:#1e0010>非空约束</span>
<span style=color:#960050;background-color:#1e0010>检查约束（字段需要满足某个布尔表达式）</span>

<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> a (
  id    INTEGER,
  name  TEXT <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,     <span style=color:#960050;background-color:#1e0010>非空约束</span>
  price NUMERIC,
  <span style=color:#66d9ef>CHECK</span> (price <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>),     <span style=color:#e6db74>&#34;a_price_check&#34;</span><span style=color:#960050;background-color:#1e0010>（检查约束）（表约束）（匿名）</span>
  <span style=color:#66d9ef>CONSTRAINT</span> abc <span style=color:#66d9ef>CHECK</span> (price <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>)     <span style=color:#e6db74>&#34;abc&#34;</span><span style=color:#960050;background-color:#1e0010>（检查约束）（表约束）（命名）</span>
);

<span style=color:#75715e>----
</span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>唯一性约束</span>

<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> a (
  id    INTEGER <span style=color:#66d9ef>UNIQUE</span>,     <span style=color:#e6db74>&#34;a_id_key&#34;</span><span style=color:#960050;background-color:#1e0010>（唯一性约束）（列约束）（匿名）</span>
  name  TEXT,
  price NUMERIC
);
<span style=color:#960050;background-color:#1e0010>等同于</span>
<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> a (
  id    INTEGER,
  name  TEXT,
  price NUMERIC,
  <span style=color:#66d9ef>UNIQUE</span> (id)     <span style=color:#e6db74>&#34;a_id_key&#34;</span><span style=color:#960050;background-color:#1e0010>（唯一性约束）（表约束）（匿名）</span>
);
<span style=color:#960050;background-color:#1e0010>等同于</span>
<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> a (
  id    INTEGER,
  name  TEXT,
  price NUMERIC,
  <span style=color:#66d9ef>CONSTRAINT</span> abc <span style=color:#66d9ef>UNIQUE</span> (id)     <span style=color:#e6db74>&#34;abc&#34;</span><span style=color:#960050;background-color:#1e0010>（唯一性约束）（表约束）（命名）</span>
);

<span style=color:#75715e>----
</span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>联合唯一性约束</span> <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>列组</span> <span style=color:#f92672>+</span> <span style=color:#960050;background-color:#1e0010>唯一性约束</span>

<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> a (
  id    INTEGER,
  name  TEXT,
  price NUMERIC,
  <span style=color:#66d9ef>UNIQUE</span> (id, name)     <span style=color:#e6db74>&#34;a_id_name_key&#34;</span><span style=color:#960050;background-color:#1e0010>（联合唯一性约束）（表约束）（匿名）</span>
);

<span style=color:#75715e>-------------------------------------------------------
</span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>主键</span> <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>主键约束（列或列组）</span><span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>唯一且非空</span> <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>唯一性约束</span> <span style=color:#f92672>+</span> <span style=color:#960050;background-color:#1e0010>非空约束</span> <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>记录的唯一标识符</span>
<span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>UNIQUE</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>

<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> a (
  id    INTEGER <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span>,     <span style=color:#e6db74>&#34;a_pkey&#34;</span><span style=color:#960050;background-color:#1e0010>（匿名）</span>
  name  TEXT,
  price NUMERIC
);
<span style=color:#960050;background-color:#1e0010>等同于</span>
<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> a (
  id    INTEGER <span style=color:#66d9ef>CONSTRAINT</span> abc <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span>,     <span style=color:#e6db74>&#34;abc&#34;</span><span style=color:#960050;background-color:#1e0010>（命名）</span>
  name  TEXT,
  price NUMERIC
);
<span style=color:#960050;background-color:#1e0010>等同于</span>
<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> a (
  id    INTEGER,
  name  TEXT,
  price NUMERIC,
  <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> (id)     <span style=color:#e6db74>&#34;a_pkey&#34;</span><span style=color:#960050;background-color:#1e0010>（表约束）</span>
);

<span style=color:#75715e>----
</span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>联合主键</span> <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>列组</span> <span style=color:#f92672>+</span> <span style=color:#960050;background-color:#1e0010>主键</span>

<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> a (
  id    INTEGER,
  name  TEXT,
  price NUMERIC,
  <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> (id, name)     <span style=color:#e6db74>&#34;a_pkey&#34;</span>
);

<span style=color:#75715e>-------------------------------------------------------
</span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>外键</span> <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>外键约束（列或列组）</span><span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>匹配（引用）另一张表的主键</span> <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>维持关联表之间的引用完整性（数据一致性）</span>

<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> a (     <span style=color:#960050;background-color:#1e0010>主表</span>
  id    INTEGER <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span>,     <span style=color:#960050;background-color:#1e0010>主键</span>
  name  TEXT,
  price NUMERIC
);

<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> b (     <span style=color:#960050;background-color:#1e0010>从表</span>
  id    INTEGER <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span>,     <span style=color:#960050;background-color:#1e0010>主键</span>
  a_no  INTEGER <span style=color:#66d9ef>REFERENCES</span> a (id),     <span style=color:#960050;background-color:#1e0010>外键</span>
  <span style=color:#66d9ef>count</span> INTEGER
);
<span style=color:#960050;background-color:#1e0010>等同于</span>
<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> b (
  id    INTEGER <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span>,
  a_no  INTEGER <span style=color:#66d9ef>REFERENCES</span> a,     <span style=color:#960050;background-color:#1e0010>自动将被引用表的主键作为被引用列</span>
  <span style=color:#66d9ef>count</span> INTEGER
);
<span style=color:#960050;background-color:#1e0010>等同于</span>
<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> b (
  id    INTEGER <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span>,
  a_no  INTEGER,
  <span style=color:#66d9ef>count</span> INTEGER,
  <span style=color:#66d9ef>FOREIGN</span> <span style=color:#66d9ef>KEY</span> (a_no) <span style=color:#66d9ef>REFERENCES</span> a     <span style=color:#960050;background-color:#1e0010>表约束</span>
);
<span style=color:#960050;background-color:#1e0010>等同于</span>
<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> b (     <span style=color:#960050;background-color:#1e0010>从表</span>
  id    INTEGER,
  a_no  INTEGER,
  <span style=color:#66d9ef>count</span> INTEGER,
  <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> (id),     <span style=color:#960050;background-color:#1e0010>主键（表约束）（匿名）</span>
  <span style=color:#66d9ef>FOREIGN</span> <span style=color:#66d9ef>KEY</span> (a_no) <span style=color:#66d9ef>REFERENCES</span> a     <span style=color:#960050;background-color:#1e0010>外键（表约束）（匿名）</span>
);

<span style=color:#75715e>-------------------------------------------------------
</span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>当删除或更新主表中的某条记录中的主键字段时，由于该条记录的主键字段被从表中某条记录所引用，所以操作将会失败（缺省）。</span>

<span style=color:#960050;background-color:#1e0010>操作（主表）：</span>
<span style=color:#66d9ef>ON</span> <span style=color:#66d9ef>DELETE</span>
<span style=color:#66d9ef>ON</span> <span style=color:#66d9ef>UPDATE</span>

<span style=color:#960050;background-color:#1e0010>响应（从表）：</span>
<span style=color:#66d9ef>NO</span> ACTION     <span style=color:#960050;background-color:#1e0010>不允许该操作（事务晚些时候检查）（缺省）</span>
<span style=color:#66d9ef>RESTRICT</span>     <span style=color:#960050;background-color:#1e0010>不允许该操作（事务早些时候检查）（常用）</span>
<span style=color:#66d9ef>CASCADE</span>     <span style=color:#960050;background-color:#1e0010>递归操作（删除引用行</span> <span style=color:#66d9ef>or</span> <span style=color:#960050;background-color:#1e0010>引用行字段置为更新值）（常用）</span>
<span style=color:#66d9ef>SET</span> <span style=color:#66d9ef>DEFAULT</span>     <span style=color:#960050;background-color:#1e0010>引用行字段置为默认值</span>
<span style=color:#66d9ef>SET</span> <span style=color:#66d9ef>NULL</span>     <span style=color:#960050;background-color:#1e0010>引用行字段置为</span> <span style=color:#66d9ef>NULL</span>

<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> b (     <span style=color:#960050;background-color:#1e0010>从表</span>
  id    INTEGER,
  a_no  INTEGER,
  <span style=color:#66d9ef>count</span> INTEGER,
  <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> (id),     <span style=color:#960050;background-color:#1e0010>主键</span>
  <span style=color:#66d9ef>FOREIGN</span> <span style=color:#66d9ef>KEY</span> (a_no) <span style=color:#66d9ef>REFERENCES</span> a <span style=color:#66d9ef>ON</span> <span style=color:#66d9ef>UPDATE</span> <span style=color:#66d9ef>CASCADE</span>     <span style=color:#960050;background-color:#1e0010>外键（主表中被引用的记录不允许删除，但允许更新）</span>
);
</code></pre></div><h3 id=alter>Alter</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#960050;background-color:#1e0010>添加字段（列）</span>
<span style=color:#75715e>-------------------------------------------------------
</span><span style=color:#75715e></span><span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> a
  <span style=color:#66d9ef>ADD</span> <span style=color:#66d9ef>COLUMN</span> description TEXT;     <span style=color:#960050;background-color:#1e0010>已存在的记录的新字段将自动填充</span> <span style=color:#66d9ef>NULL</span>

<span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> a
  <span style=color:#66d9ef>ADD</span> <span style=color:#66d9ef>COLUMN</span> description TEXT <span style=color:#66d9ef>DEFAULT</span> <span style=color:#e6db74>&#39;未描述&#39;</span> <span style=color:#66d9ef>CHECK</span> (description <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#39;&#39;</span>);     <span style=color:#960050;background-color:#1e0010>可以使用</span> <span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#960050;background-color:#1e0010>中对字段的描述语法</span>

<span style=color:#960050;background-color:#1e0010>删除字段（列）</span>
<span style=color:#75715e>-------------------------------------------------------
</span><span style=color:#75715e></span><span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> a <span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>COLUMN</span> description;

<span style=color:#960050;background-color:#1e0010>添加约束</span>     <span style=color:#960050;background-color:#1e0010>表中的数据需在约束被添加之前就已经符合约束，否则将添加失败</span>
<span style=color:#75715e>-------------------------------------------------------
</span><span style=color:#75715e></span><span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> a <span style=color:#66d9ef>ADD</span> <span style=color:#66d9ef>CHECK</span> (name <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#39;&#39;</span>);     <span style=color:#960050;background-color:#1e0010>检查约束</span>
<span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> a <span style=color:#66d9ef>ADD</span> <span style=color:#66d9ef>UNIQUE</span> (name);     <span style=color:#960050;background-color:#1e0010>唯一性约束</span>
<span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> a <span style=color:#66d9ef>ADD</span> <span style=color:#66d9ef>FOREIGN</span> <span style=color:#66d9ef>KEY</span> (name) <span style=color:#66d9ef>REFERENCES</span> b;     <span style=color:#960050;background-color:#1e0010>外键约束</span>
<span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> a <span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>COLUMN</span> name <span style=color:#66d9ef>SET</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>;     <span style=color:#960050;background-color:#1e0010>非空约束（没有表约束，只有列约束；并且没有名称）</span>

<span style=color:#960050;background-color:#1e0010>删除约束</span>
<span style=color:#75715e>-------------------------------------------------------
</span><span style=color:#75715e></span><span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> a <span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>CONSTRAINT</span> <span style=color:#e6db74>&#34;a_name_check&#34;</span>;     <span style=color:#960050;background-color:#1e0010>约束</span>
<span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> a <span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>COLUMN</span> name <span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>;     <span style=color:#960050;background-color:#1e0010>非空约束（没有表约束，只有列约束；并且没有名称）</span>

<span style=color:#960050;background-color:#1e0010>更改列的默认值</span>     <span style=color:#960050;background-color:#1e0010>不会影响已存在的记录</span>
<span style=color:#75715e>-------------------------------------------------------
</span><span style=color:#75715e></span><span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> a <span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>COLUMN</span> description <span style=color:#66d9ef>SET</span> <span style=color:#66d9ef>DEFAULT</span> <span style=color:#e6db74>&#39;未描述&#39;</span>;     <span style=color:#960050;background-color:#1e0010>添加</span>
<span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> a <span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>COLUMN</span> description <span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>DEFAULT</span>;     <span style=color:#960050;background-color:#1e0010>删除（默认值为</span> <span style=color:#66d9ef>NULL</span><span style=color:#960050;background-color:#1e0010>）</span>

<span style=color:#960050;background-color:#1e0010>更改列的数据类型</span>     <span style=color:#960050;background-color:#1e0010>表中的数据需通过隐式转换才能成功，否则需要使用</span> <span style=color:#66d9ef>USING</span> <span style=color:#960050;background-color:#1e0010>子句进行显式转换</span>
<span style=color:#75715e>-------------------------------------------------------
</span><span style=color:#75715e></span><span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> a <span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>COLUMN</span> description <span style=color:#66d9ef>TYPE</span> VARCHAR;

<span style=color:#960050;background-color:#1e0010>重命名字段</span>
<span style=color:#75715e>-------------------------------------------------------
</span><span style=color:#75715e></span><span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> a <span style=color:#66d9ef>RENAME</span> <span style=color:#66d9ef>COLUMN</span> description <span style=color:#66d9ef>TO</span> characterization;

<span style=color:#960050;background-color:#1e0010>重命名表</span>
<span style=color:#75715e>-------------------------------------------------------
</span><span style=color:#75715e></span><span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> a <span style=color:#66d9ef>RENAME</span> <span style=color:#66d9ef>TO</span> b;
</code></pre></div><h2 id=schema>Schema</h2><p style=text-align:center><img src=/uploads/postgresql-schema.png alt title=PostgreSQL data-action=zoom width></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#960050;background-color:#1e0010>一个数据库集簇（</span><span style=color:#66d9ef>Cluster</span><span style=color:#960050;background-color:#1e0010>）中的所有数据库只会共享</span> pg_database<span style=color:#960050;background-color:#1e0010>（数据库列表）、</span>pg_group<span style=color:#960050;background-color:#1e0010>（用户组列表）、</span>pg_shadow<span style=color:#960050;background-color:#1e0010>（有效用户列表）。</span>

<span style=color:#960050;background-color:#1e0010>一个数据库中又包含一个或多个模式（</span><span style=color:#66d9ef>Schema</span><span style=color:#960050;background-color:#1e0010>）。</span>

<span style=color:#960050;background-color:#1e0010>一个模式中又包含表、函数、操作符、数据类型等其他类型。</span>

<span style=color:#960050;background-color:#1e0010>层次：服务器</span> <span style=color:#f92672>-&gt;</span> <span style=color:#960050;background-color:#1e0010>数据库</span> <span style=color:#f92672>-&gt;</span> <span style=color:#960050;background-color:#1e0010>模式</span> <span style=color:#f92672>-&gt;</span> <span style=color:#960050;background-color:#1e0010>对象（表</span>...<span style=color:#960050;background-color:#1e0010>）</span>

<span style=color:#75715e>-------------------------------------------------------
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>SCHEMA</span> a;     <span style=color:#960050;background-color:#1e0010>创建模式</span>

<span style=color:#75715e>-------------------------------------------------------
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>SCHEMA</span> a;     <span style=color:#960050;background-color:#1e0010>删除模式（模式需清空）</span>

<span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>SCHEMA</span> a <span style=color:#66d9ef>CASCADE</span>;     <span style=color:#960050;background-color:#1e0010>递归删除模式</span>

<span style=color:#75715e>-------------------------------------------------------
</span><span style=color:#75715e></span>PostgreSQL <span style=color:#960050;background-color:#1e0010>会自动将不带限定名的访问指向</span> <span style=color:#66d9ef>public</span> <span style=color:#960050;background-color:#1e0010>模式。</span>

<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> a ();
<span style=color:#960050;background-color:#1e0010>等同于</span>
<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>public</span>.a ();

<span style=color:#75715e>-------------------------------------------------------
</span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>模式搜索路径</span>

<span style=color:#66d9ef>SHOW</span> search_path;     <span style=color:#960050;background-color:#1e0010>查看</span>

<span style=color:#66d9ef>SET</span> search_path <span style=color:#66d9ef>TO</span> a,<span style=color:#66d9ef>public</span>;     <span style=color:#960050;background-color:#1e0010>设置</span>
</code></pre></div><h2 id=inherit>Inherit</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> a (     <span style=color:#960050;background-color:#1e0010>创建父表</span>
  a_id INTEGER
);

<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> b (     <span style=color:#960050;background-color:#1e0010>创建子表</span>
  b_id INTEGER
) <span style=color:#66d9ef>INHERITS</span> (a);     <span style=color:#960050;background-color:#1e0010>继承自</span> a <span style=color:#960050;background-color:#1e0010>表（拥有</span> a <span style=color:#960050;background-color:#1e0010>表的所有字段）</span>

<span style=color:#75715e>----
</span><span style=color:#75715e></span>
postgres<span style=color:#f92672>=#</span> <span style=color:#960050;background-color:#1e0010>\</span>d<span style=color:#f92672>+</span> a     <span style=color:#960050;background-color:#1e0010>查看父表属性</span>
                 <span style=color:#960050;background-color:#1e0010>数据表</span> <span style=color:#e6db74>&#34;public.a&#34;</span>
 <span style=color:#960050;background-color:#1e0010>栏位</span> <span style=color:#f92672>|</span>  <span style=color:#960050;background-color:#1e0010>类型</span>   <span style=color:#f92672>|</span> <span style=color:#960050;background-color:#1e0010>修饰词</span> <span style=color:#f92672>|</span> <span style=color:#960050;background-color:#1e0010>存储</span>  <span style=color:#f92672>|</span> <span style=color:#960050;background-color:#1e0010>统计目标</span> <span style=color:#f92672>|</span> <span style=color:#960050;background-color:#1e0010>描述</span>
 a_id <span style=color:#f92672>|</span> integer <span style=color:#f92672>|</span>        <span style=color:#f92672>|</span> plain <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>
<span style=color:#960050;background-color:#1e0010>子表</span>: b

postgres<span style=color:#f92672>=#</span> <span style=color:#960050;background-color:#1e0010>\</span>d<span style=color:#f92672>+</span> b     <span style=color:#960050;background-color:#1e0010>查看子表属性</span>
                 <span style=color:#960050;background-color:#1e0010>数据表</span> <span style=color:#e6db74>&#34;public.b&#34;</span>
 <span style=color:#960050;background-color:#1e0010>栏位</span> <span style=color:#f92672>|</span>  <span style=color:#960050;background-color:#1e0010>类型</span>   <span style=color:#f92672>|</span> <span style=color:#960050;background-color:#1e0010>修饰词</span> <span style=color:#f92672>|</span> <span style=color:#960050;background-color:#1e0010>存储</span>  <span style=color:#f92672>|</span> <span style=color:#960050;background-color:#1e0010>统计目标</span> <span style=color:#f92672>|</span> <span style=color:#960050;background-color:#1e0010>描述</span>
 a_id <span style=color:#f92672>|</span> integer <span style=color:#f92672>|</span>        <span style=color:#f92672>|</span> plain <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>
 b_id <span style=color:#f92672>|</span> integer <span style=color:#f92672>|</span>        <span style=color:#f92672>|</span> plain <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>
<span style=color:#960050;background-color:#1e0010>继承</span>: a

<span style=color:#75715e>-------------------------------------------------------
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> a <span style=color:#66d9ef>VALUES</span> (<span style=color:#ae81ff>1</span>);     <span style=color:#960050;background-color:#1e0010>父表插入记录</span>
<span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> a <span style=color:#66d9ef>VALUES</span> (<span style=color:#ae81ff>2</span>);
<span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> a <span style=color:#66d9ef>VALUES</span> (<span style=color:#ae81ff>3</span>);
<span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> b <span style=color:#66d9ef>VALUES</span> (<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>101</span>);     <span style=color:#960050;background-color:#1e0010>子表插入记录</span>

<span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> a;     <span style=color:#960050;background-color:#1e0010>默认包括所有子表记录</span>
 a_id
<span style=color:#75715e>------
</span><span style=color:#75715e></span>    <span style=color:#ae81ff>1</span>
    <span style=color:#ae81ff>2</span>
    <span style=color:#ae81ff>3</span>
    <span style=color:#ae81ff>1</span>
<span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> <span style=color:#66d9ef>ONLY</span> a;     <span style=color:#960050;background-color:#1e0010>显式声明只查看父表记录（</span><span style=color:#66d9ef>SELECT</span><span style=color:#960050;background-color:#1e0010>、</span><span style=color:#66d9ef>UPDATE</span><span style=color:#960050;background-color:#1e0010>、</span><span style=color:#66d9ef>DELETE</span> <span style=color:#960050;background-color:#1e0010>都支持</span> <span style=color:#66d9ef>ONLY</span> <span style=color:#960050;background-color:#1e0010>关键字</span>;<span style=color:#960050;background-color:#1e0010>）</span>
 a_id
<span style=color:#75715e>------
</span><span style=color:#75715e></span>    <span style=color:#ae81ff>1</span>
    <span style=color:#ae81ff>2</span>
    <span style=color:#ae81ff>3</span>
<span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> b;     <span style=color:#960050;background-color:#1e0010>查看子表记录</span>
 a_id <span style=color:#f92672>|</span> b_id
<span style=color:#75715e>------+------
</span><span style=color:#75715e></span>    <span style=color:#ae81ff>1</span> <span style=color:#f92672>|</span>  <span style=color:#ae81ff>101</span>

<span style=color:#75715e>-------------------------------------------------------
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>TRUNCATE</span> <span style=color:#66d9ef>TABLE</span> a;     <span style=color:#960050;background-color:#1e0010>使用</span> <span style=color:#66d9ef>TRUNCATE</span> <span style=color:#960050;background-color:#1e0010>清空父表记录时，子表记录会一同被清空</span>
<span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> a;     <span style=color:#960050;background-color:#1e0010>默认包括所有子表记录</span>
 a_id
<span style=color:#75715e>------
</span><span style=color:#75715e></span>
<span style=color:#75715e>-------------------------------------------------------
</span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>确定记录来源</span>

<span style=color:#66d9ef>SELECT</span>
  a.<span style=color:#f92672>*</span>,
  a.TABLEOID     tableoid <span style=color:#960050;background-color:#1e0010>为系统隐含字段</span>
<span style=color:#66d9ef>FROM</span> a;
 a_id <span style=color:#f92672>|</span> tableoid
<span style=color:#75715e>------+----------
</span><span style=color:#75715e></span>    <span style=color:#ae81ff>1</span> <span style=color:#f92672>|</span>    <span style=color:#ae81ff>17126</span>
    <span style=color:#ae81ff>2</span> <span style=color:#f92672>|</span>    <span style=color:#ae81ff>17126</span>
    <span style=color:#ae81ff>3</span> <span style=color:#f92672>|</span>    <span style=color:#ae81ff>17126</span>
    <span style=color:#ae81ff>1</span> <span style=color:#f92672>|</span>    <span style=color:#ae81ff>17129</span>

<span style=color:#66d9ef>SELECT</span>
  a.<span style=color:#f92672>*</span>,
  p.relname
<span style=color:#66d9ef>FROM</span> a, pg_class p
<span style=color:#66d9ef>WHERE</span> a.TABLEOID <span style=color:#f92672>=</span> p.OID;     <span style=color:#960050;background-color:#1e0010>将</span> tableoid <span style=color:#960050;background-color:#1e0010>与系统表</span> pg_class <span style=color:#960050;background-color:#1e0010>进行关联以获得实际表名</span>
 a_id <span style=color:#f92672>|</span> relname
<span style=color:#75715e>------+---------
</span><span style=color:#75715e></span>    <span style=color:#ae81ff>1</span> <span style=color:#f92672>|</span> a
    <span style=color:#ae81ff>2</span> <span style=color:#f92672>|</span> a
    <span style=color:#ae81ff>3</span> <span style=color:#f92672>|</span> a
    <span style=color:#ae81ff>1</span> <span style=color:#f92672>|</span> b

<span style=color:#75715e>----
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>SELECT</span>
  a.<span style=color:#f92672>*</span>,
  a.TABLEOID :: REGCLASS
<span style=color:#66d9ef>FROM</span> a;
 a_id <span style=color:#f92672>|</span> tableoid
<span style=color:#75715e>------+----------
</span><span style=color:#75715e></span>    <span style=color:#ae81ff>1</span> <span style=color:#f92672>|</span> a
    <span style=color:#ae81ff>2</span> <span style=color:#f92672>|</span> a
    <span style=color:#ae81ff>3</span> <span style=color:#f92672>|</span> a
    <span style=color:#ae81ff>1</span> <span style=color:#f92672>|</span> b

<span style=color:#75715e>-------------------------------------------------------
</span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>多表继承：一个表可以有多个父表，此时它拥有所有父表们的字段总和。</span>
                 <span style=color:#960050;background-color:#1e0010>若出现同名字段，则必须是相同数据类型，否则将继承失败；合并后的字段拥有它所继承的字段的所有约束（检查、非空）。</span>

<span style=color:#960050;background-color:#1e0010>约束：父表上的检查约束和非空约束都会被继承，而其他类型的约束（唯一、主键、外键）则不会被继承。</span>
<span style=color:#960050;background-color:#1e0010>访问权限：表的继承并不包括访问权限；因此，访问父表的用户还必须具有访问子表的权限，或者使用</span> <span style=color:#66d9ef>ONLY</span> <span style=color:#960050;background-color:#1e0010>关键字显式声明只查看父表记录。</span>
</code></pre></div><h2 id=partition>Partition</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#960050;background-color:#1e0010>分区：通过继承来实现数据分离。</span>
<span style=color:#960050;background-color:#1e0010>范围划分</span>
<span style=color:#960050;background-color:#1e0010>列表划分</span>

<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> a (
  id     INTEGER,
  gender TEXT,
  name   TEXT
);

<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> b1 (
  <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> (id),
  <span style=color:#66d9ef>CHECK</span> (gender <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;男&#39;</span>)
)
  <span style=color:#66d9ef>INHERITS</span> (a);

<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> b2 (
  <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> (id),
  <span style=color:#66d9ef>CHECK</span> (gender <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;女&#39;</span>)
)
  <span style=color:#66d9ef>INHERITS</span> (a);
</code></pre></div><h2 id=function>Function</h2><h3 id=sql查询语言函数>SQL（查询语言函数）</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#960050;background-color:#1e0010>函数：可重载，有多态。</span>
<span style=color:#960050;background-color:#1e0010>函数体：包含在字符文本中的</span> <span style=color:#66d9ef>SQL</span> <span style=color:#960050;background-color:#1e0010>语句集合（</span><span style=color:#e6db74>&#39;&#39;</span><span style=color:#960050;background-color:#1e0010>、$$$$（推荐））。</span>
<span style=color:#960050;background-color:#1e0010>参数修饰：</span><span style=color:#66d9ef>IN</span><span style=color:#960050;background-color:#1e0010>（输入）（缺省），</span><span style=color:#66d9ef>OUT</span><span style=color:#960050;background-color:#1e0010>（输出），</span><span style=color:#66d9ef>INOUT</span><span style=color:#960050;background-color:#1e0010>（输入</span><span style=color:#f92672>+</span><span style=color:#960050;background-color:#1e0010>输出），</span>VARIADIC<span style=color:#960050;background-color:#1e0010>（可变长参数）。</span>

<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> a (     <span style=color:#960050;background-color:#1e0010>测试表</span>
  name   TEXT,
  age    INTEGER,
  salary NUMERIC
);

<span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> a <span style=color:#66d9ef>VALUES</span> (<span style=color:#e6db74>&#39;小张&#39;</span>, <span style=color:#ae81ff>25</span>, <span style=color:#ae81ff>4999</span>.<span style=color:#ae81ff>9</span>);     <span style=color:#960050;background-color:#1e0010>测试数据</span>
<span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> a <span style=color:#66d9ef>VALUES</span> (<span style=color:#e6db74>&#39;小陈&#39;</span>, <span style=color:#ae81ff>23</span>, <span style=color:#ae81ff>3999</span>.<span style=color:#ae81ff>9</span>);

<span style=color:#75715e>-------------------------------------------------------
</span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>若函数返回值不为</span> Void<span style=color:#960050;background-color:#1e0010>，则最后一条语句必须是</span> <span style=color:#66d9ef>SELECT</span><span style=color:#960050;background-color:#1e0010>、</span><span style=color:#66d9ef>INSERT</span><span style=color:#960050;background-color:#1e0010>、</span><span style=color:#66d9ef>UPDATE</span><span style=color:#960050;background-color:#1e0010>、带有</span> RETURNING <span style=color:#960050;background-color:#1e0010>子句的</span> <span style=color:#66d9ef>DELETE</span><span style=color:#960050;background-color:#1e0010>。</span>

<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>FUNCTION</span> a(<span style=color:#66d9ef>IN</span> INTEGER, <span style=color:#66d9ef>OUT</span> VOID) <span style=color:#66d9ef>AS</span> <span style=color:#960050;background-color:#1e0010>$$</span>     <span style=color:#960050;background-color:#1e0010>接收</span> INTEGER<span style=color:#960050;background-color:#1e0010>，返回</span> Void<span style=color:#960050;background-color:#1e0010>（创建）</span>
<span style=color:#960050;background-color:#1e0010>$$</span> <span style=color:#66d9ef>LANGUAGE</span> <span style=color:#66d9ef>SQL</span>;
<span style=color:#960050;background-color:#1e0010>等同于</span>
<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>FUNCTION</span> a(INTEGER) <span style=color:#66d9ef>RETURNS</span> VOID <span style=color:#66d9ef>AS</span> <span style=color:#960050;background-color:#1e0010>$$</span>     <span style=color:#66d9ef>IN</span><span style=color:#960050;background-color:#1e0010>：缺省值，可省略；</span><span style=color:#66d9ef>OUT</span><span style=color:#960050;background-color:#1e0010>：需显式声明（单个结果可在括号外声明）</span>
<span style=color:#960050;background-color:#1e0010>$$</span> <span style=color:#66d9ef>LANGUAGE</span> <span style=color:#66d9ef>SQL</span>;
<span style=color:#960050;background-color:#1e0010>等同于</span>
<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>FUNCTION</span> a(INTEGER) <span style=color:#66d9ef>RETURNS</span> VOID <span style=color:#66d9ef>AS</span> <span style=color:#e6db74>&#39;&#39;</span>     <span style=color:#960050;background-color:#1e0010>使用</span> <span style=color:#e6db74>&#39;&#39;</span> <span style=color:#960050;background-color:#1e0010>替代</span> <span style=color:#960050;background-color:#1e0010>$$$$</span> <span style=color:#960050;background-color:#1e0010>表示字符串</span>
<span style=color:#66d9ef>LANGUAGE</span> <span style=color:#66d9ef>SQL</span>;

<span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>FUNCTION</span> a( INTEGER );     <span style=color:#960050;background-color:#1e0010>（删除）</span>

<span style=color:#66d9ef>SELECT</span> a(<span style=color:#ae81ff>1</span>);     <span style=color:#960050;background-color:#1e0010>返回</span> Void<span style=color:#960050;background-color:#1e0010>（</span><span style=color:#66d9ef>NULL</span><span style=color:#960050;background-color:#1e0010>）（调用）</span>

<span style=color:#75715e>-------------------------------------------------------
</span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>基本类型</span>

<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>FUNCTION</span> a(<span style=color:#66d9ef>OUT</span> INTEGER) <span style=color:#66d9ef>AS</span> <span style=color:#960050;background-color:#1e0010>$$</span>     <span style=color:#960050;background-color:#1e0010>无参，返回</span> INTEGER
<span style=color:#66d9ef>SELECT</span> <span style=color:#ae81ff>1</span>;     <span style=color:#960050;background-color:#1e0010>返回</span> <span style=color:#ae81ff>1</span>
<span style=color:#960050;background-color:#1e0010>$$</span> <span style=color:#66d9ef>LANGUAGE</span> <span style=color:#66d9ef>SQL</span>;

<span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>FUNCTION</span> a();

<span style=color:#66d9ef>SELECT</span> a();

<span style=color:#75715e>----
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>FUNCTION</span> a(<span style=color:#66d9ef>OUT</span> VOID) <span style=color:#66d9ef>AS</span> <span style=color:#960050;background-color:#1e0010>$$</span>     <span style=color:#960050;background-color:#1e0010>无参，返回</span> <span style=color:#66d9ef>NULL</span>
<span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>TABLE</span> a <span style=color:#66d9ef>CASCADE</span>;     <span style=color:#960050;background-color:#1e0010>递归删除表</span> a
<span style=color:#960050;background-color:#1e0010>$$</span> <span style=color:#66d9ef>LANGUAGE</span> <span style=color:#66d9ef>SQL</span>;

<span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>FUNCTION</span> a();

<span style=color:#66d9ef>SELECT</span> a();

<span style=color:#75715e>----
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>FUNCTION</span> a(INTEGER, INTEGER, <span style=color:#66d9ef>OUT</span> INTEGER) <span style=color:#66d9ef>AS</span> <span style=color:#960050;background-color:#1e0010>$$</span>
<span style=color:#66d9ef>SELECT</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>+</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>2</span>;     <span style=color:#960050;background-color:#1e0010>通过</span> <span style=color:#960050;background-color:#1e0010>$</span>n <span style=color:#960050;background-color:#1e0010>调用入参</span>
<span style=color:#960050;background-color:#1e0010>$$</span> <span style=color:#66d9ef>LANGUAGE</span> <span style=color:#66d9ef>SQL</span>;

<span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>FUNCTION</span> a( INTEGER, INTEGER );

<span style=color:#66d9ef>SELECT</span> a(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>);     <span style=color:#960050;background-color:#1e0010>返回</span> <span style=color:#ae81ff>3</span>

<span style=color:#75715e>-------------------------------------------------------
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>FUNCTION</span> a(a a, <span style=color:#66d9ef>OUT</span> INTEGER) <span style=color:#66d9ef>AS</span> <span style=color:#960050;background-color:#1e0010>$$</span>
<span style=color:#66d9ef>SELECT</span> (a.salary <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>) :: INTEGER;     NUMERIC <span style=color:#960050;background-color:#1e0010>➜</span> INTEGER
<span style=color:#960050;background-color:#1e0010>$$</span> <span style=color:#66d9ef>LANGUAGE</span> <span style=color:#66d9ef>SQL</span>;

<span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>FUNCTION</span> a( a );

<span style=color:#66d9ef>SELECT</span> name, a(a) dream <span style=color:#66d9ef>FROM</span> a;
 name <span style=color:#f92672>|</span> dream
<span style=color:#75715e>------+-------
</span><span style=color:#75715e></span> <span style=color:#960050;background-color:#1e0010>小张</span> <span style=color:#f92672>|</span> <span style=color:#ae81ff>10000</span>
 <span style=color:#960050;background-color:#1e0010>小陈</span> <span style=color:#f92672>|</span>  <span style=color:#ae81ff>8000</span>
<span style=color:#66d9ef>SELECT</span> name, a(<span style=color:#66d9ef>ROW</span> (name, age, salary <span style=color:#f92672>*</span> <span style=color:#ae81ff>1</span>.<span style=color:#ae81ff>1</span>)) dream <span style=color:#66d9ef>FROM</span> a;     <span style=color:#66d9ef>ROW</span> <span style=color:#960050;background-color:#1e0010>构造函数</span>
 name <span style=color:#f92672>|</span> dream
<span style=color:#75715e>------+-------
</span><span style=color:#75715e></span> <span style=color:#960050;background-color:#1e0010>小张</span> <span style=color:#f92672>|</span> <span style=color:#ae81ff>11000</span>
 <span style=color:#960050;background-color:#1e0010>小陈</span> <span style=color:#f92672>|</span>  <span style=color:#ae81ff>8800</span>

<span style=color:#75715e>-------------------------------------------------------
</span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>返回值为复合类型（多个列（结果））</span>

<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>FUNCTION</span> a(<span style=color:#66d9ef>OUT</span> a) <span style=color:#66d9ef>AS</span> <span style=color:#960050;background-color:#1e0010>$$</span>     <span style=color:#960050;background-color:#1e0010>返回</span> a <span style=color:#960050;background-color:#1e0010>类型</span>
<span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>ROW</span> (<span style=color:#e6db74>&#39;小红&#39;</span>, <span style=color:#ae81ff>21</span>, <span style=color:#ae81ff>3499</span>.<span style=color:#ae81ff>9</span>) :: a;     Record <span style=color:#960050;background-color:#1e0010>➜</span> a
<span style=color:#960050;background-color:#1e0010>$$</span> <span style=color:#66d9ef>LANGUAGE</span> <span style=color:#66d9ef>SQL</span>;

<span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>FUNCTION</span> a();

<span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>ROW</span> (<span style=color:#e6db74>&#39;小红&#39;</span>, <span style=color:#ae81ff>21</span>, <span style=color:#ae81ff>3499</span>.<span style=color:#ae81ff>9</span>) :: a;
<span style=color:#960050;background-color:#1e0010>等同于</span>
<span style=color:#66d9ef>SELECT</span> a();
       <span style=color:#66d9ef>row</span>
<span style=color:#75715e>------------------
</span><span style=color:#75715e></span> (<span style=color:#960050;background-color:#1e0010>小红</span>,<span style=color:#ae81ff>21</span>,<span style=color:#ae81ff>3499</span>.<span style=color:#ae81ff>9</span>)

<span style=color:#66d9ef>SELECT</span> (a()).name;
 name
<span style=color:#75715e>------
</span><span style=color:#75715e></span> <span style=color:#960050;background-color:#1e0010>小红</span>
<span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> a();
 name <span style=color:#f92672>|</span> age <span style=color:#f92672>|</span> salary
<span style=color:#75715e>------+-----+--------
</span><span style=color:#75715e></span> <span style=color:#960050;background-color:#1e0010>小红</span> <span style=color:#f92672>|</span>  <span style=color:#ae81ff>21</span> <span style=color:#f92672>|</span> <span style=color:#ae81ff>3499</span>.<span style=color:#ae81ff>9</span>

<span style=color:#75715e>----
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>FUNCTION</span> a(x INTEGER, y INTEGER, <span style=color:#66d9ef>OUT</span> <span style=color:#66d9ef>sum</span> INTEGER, <span style=color:#66d9ef>OUT</span> multiply INTEGER) <span style=color:#66d9ef>AS</span> <span style=color:#960050;background-color:#1e0010>$$</span>     <span style=color:#960050;background-color:#1e0010>返回</span> Record <span style=color:#960050;background-color:#1e0010>类型</span>
<span style=color:#66d9ef>SELECT</span> x <span style=color:#f92672>+</span> y, x <span style=color:#f92672>*</span> y;     <span style=color:#960050;background-color:#1e0010>命名参数</span>
<span style=color:#960050;background-color:#1e0010>$$</span> <span style=color:#66d9ef>LANGUAGE</span> <span style=color:#66d9ef>SQL</span>;

<span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>FUNCTION</span> a( INTEGER, INTEGER );

<span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> a(<span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>10</span>);
<span style=color:#960050;background-color:#1e0010>等同于</span>
<span style=color:#66d9ef>SELECT</span> (a(<span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>10</span>)).<span style=color:#f92672>*</span>;
 <span style=color:#66d9ef>sum</span> <span style=color:#f92672>|</span> multiply
<span style=color:#75715e>-----+----------
</span><span style=color:#75715e></span>  <span style=color:#ae81ff>15</span> <span style=color:#f92672>|</span>       <span style=color:#ae81ff>50</span>

<span style=color:#75715e>-------------------------------------------------------
</span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>返回值为多条记录，此类函数多用于</span> <span style=color:#66d9ef>FROM</span> <span style=color:#960050;background-color:#1e0010>子句：</span><span style=color:#66d9ef>SETOF</span><span style=color:#960050;background-color:#1e0010>、</span><span style=color:#66d9ef>RETURNS</span> <span style=color:#66d9ef>TABLE</span>
<span style=color:#960050;background-color:#1e0010>若无以上关键字，则默认只取第一条记录。</span>

<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>FUNCTION</span> a() <span style=color:#66d9ef>RETURNS</span> <span style=color:#66d9ef>SETOF</span> a <span style=color:#66d9ef>AS</span> <span style=color:#960050;background-color:#1e0010>$$</span>     <span style=color:#960050;background-color:#1e0010>返回</span> a <span style=color:#960050;background-color:#1e0010>类型</span>
<span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> a;
<span style=color:#960050;background-color:#1e0010>$$</span> <span style=color:#66d9ef>LANGUAGE</span> <span style=color:#66d9ef>SQL</span>;

<span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>FUNCTION</span> a();

<span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> a();
 name <span style=color:#f92672>|</span> age <span style=color:#f92672>|</span> salary
<span style=color:#75715e>------+-----+--------
</span><span style=color:#75715e></span> <span style=color:#960050;background-color:#1e0010>小张</span> <span style=color:#f92672>|</span>  <span style=color:#ae81ff>25</span> <span style=color:#f92672>|</span> <span style=color:#ae81ff>4999</span>.<span style=color:#ae81ff>9</span>
 <span style=color:#960050;background-color:#1e0010>小陈</span> <span style=color:#f92672>|</span>  <span style=color:#ae81ff>23</span> <span style=color:#f92672>|</span> <span style=color:#ae81ff>3999</span>.<span style=color:#ae81ff>9</span>

<span style=color:#75715e>----
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>FUNCTION</span> a(<span style=color:#66d9ef>OUT</span> name TEXT, <span style=color:#66d9ef>OUT</span> salary NUMERIC) <span style=color:#66d9ef>RETURNS</span> <span style=color:#66d9ef>SETOF</span> RECORD <span style=color:#66d9ef>AS</span> <span style=color:#960050;background-color:#1e0010>$$</span>     <span style=color:#960050;background-color:#1e0010>返回</span> Record <span style=color:#960050;background-color:#1e0010>类型</span>
<span style=color:#66d9ef>SELECT</span> name, salary <span style=color:#66d9ef>FROM</span> a;
<span style=color:#960050;background-color:#1e0010>$$</span> <span style=color:#66d9ef>LANGUAGE</span> <span style=color:#66d9ef>SQL</span>;

<span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>FUNCTION</span> a();

<span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> a();
 name <span style=color:#f92672>|</span> salary
<span style=color:#75715e>------+--------
</span><span style=color:#75715e></span> <span style=color:#960050;background-color:#1e0010>小张</span> <span style=color:#f92672>|</span> <span style=color:#ae81ff>4999</span>.<span style=color:#ae81ff>9</span>
 <span style=color:#960050;background-color:#1e0010>小陈</span> <span style=color:#f92672>|</span> <span style=color:#ae81ff>3999</span>.<span style=color:#ae81ff>9</span>

<span style=color:#960050;background-color:#1e0010>等同于</span>

<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>FUNCTION</span> a() <span style=color:#66d9ef>RETURNS</span> <span style=color:#66d9ef>TABLE</span>(name TEXT, salary NUMERIC) <span style=color:#66d9ef>AS</span> <span style=color:#960050;background-color:#1e0010>$$</span>     <span style=color:#66d9ef>RETURNS</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#960050;background-color:#1e0010>可用于替代</span> <span style=color:#66d9ef>RETURNS</span> <span style=color:#66d9ef>SETOF</span> <span style=color:#960050;background-color:#1e0010>的</span> Record <span style=color:#960050;background-color:#1e0010>类型，语法更简洁</span>
<span style=color:#66d9ef>SELECT</span> name, salary <span style=color:#66d9ef>FROM</span> a;
<span style=color:#960050;background-color:#1e0010>$$</span> <span style=color:#66d9ef>LANGUAGE</span> <span style=color:#66d9ef>SQL</span>;

<span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>FUNCTION</span> a();

<span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> a();
 name <span style=color:#f92672>|</span> salary
<span style=color:#75715e>------+--------
</span><span style=color:#75715e></span> <span style=color:#960050;background-color:#1e0010>小张</span> <span style=color:#f92672>|</span> <span style=color:#ae81ff>4999</span>.<span style=color:#ae81ff>9</span>
 <span style=color:#960050;background-color:#1e0010>小陈</span> <span style=color:#f92672>|</span> <span style=color:#ae81ff>3999</span>.<span style=color:#ae81ff>9</span>

<span style=color:#75715e>-------------------------------------------------------
</span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>多态函数：</span>ANYELEMENT<span style=color:#960050;background-color:#1e0010>、</span>ANYARRAY<span style=color:#960050;background-color:#1e0010>、</span>ANYNONARRAY<span style=color:#960050;background-color:#1e0010>、</span>ANYENUM

<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>FUNCTION</span> a(ANYELEMENT, ANYELEMENT, <span style=color:#66d9ef>OUT</span> ANYARRAY) <span style=color:#66d9ef>AS</span> <span style=color:#960050;background-color:#1e0010>$$</span>
<span style=color:#66d9ef>SELECT</span> ARRAY [<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span>, <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>2</span>];
<span style=color:#960050;background-color:#1e0010>$$</span> <span style=color:#66d9ef>LANGUAGE</span> <span style=color:#66d9ef>SQL</span>;

<span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>FUNCTION</span> a( ANYELEMENT, ANYELEMENT );

<span style=color:#66d9ef>SELECT</span> a(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>), a(<span style=color:#e6db74>&#39;A&#39;</span> :: TEXT, <span style=color:#e6db74>&#39;B&#39;</span>);     <span style=color:#960050;background-color:#1e0010>参数类型需一致，并且显式声明其类型</span>
   a   <span style=color:#f92672>|</span>   a
<span style=color:#75715e>-------+-------
</span><span style=color:#75715e></span> <span style=color:#960050;background-color:#1e0010>{</span><span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>2</span><span style=color:#960050;background-color:#1e0010>}</span> <span style=color:#f92672>|</span> <span style=color:#960050;background-color:#1e0010>{</span>A,B<span style=color:#960050;background-color:#1e0010>}</span>

<span style=color:#75715e>----
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>FUNCTION</span> a(ANYELEMENT, ANYELEMENT, <span style=color:#66d9ef>OUT</span> BOOLEAN) <span style=color:#66d9ef>AS</span> <span style=color:#960050;background-color:#1e0010>$$</span>
<span style=color:#66d9ef>SELECT</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>&gt;</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>2</span>;
<span style=color:#960050;background-color:#1e0010>$$</span> <span style=color:#66d9ef>LANGUAGE</span> <span style=color:#66d9ef>SQL</span>;

<span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>FUNCTION</span> a( ANYELEMENT, ANYELEMENT );

<span style=color:#66d9ef>SELECT</span> a(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>1</span>), a(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>), a(<span style=color:#e6db74>&#39;A&#39;</span> :: TEXT, <span style=color:#e6db74>&#39;B&#39;</span>);
 a <span style=color:#f92672>|</span> a <span style=color:#f92672>|</span> a
<span style=color:#75715e>---+---+---
</span><span style=color:#75715e></span> t <span style=color:#f92672>|</span> f <span style=color:#f92672>|</span> f

<span style=color:#75715e>----
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>FUNCTION</span> a(i ANYELEMENT, <span style=color:#66d9ef>OUT</span> o1 ANYELEMENT, <span style=color:#66d9ef>OUT</span> o2 ANYARRAY) <span style=color:#66d9ef>AS</span> <span style=color:#960050;background-color:#1e0010>$$</span>
<span style=color:#66d9ef>SELECT</span>
  i,
  ARRAY [i, i];
<span style=color:#960050;background-color:#1e0010>$$</span> <span style=color:#66d9ef>LANGUAGE</span> <span style=color:#66d9ef>SQL</span>;

<span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>FUNCTION</span> a( ANYELEMENT );

<span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> a(<span style=color:#ae81ff>2</span>);
 o1 <span style=color:#f92672>|</span>  o2
<span style=color:#75715e>----+-------
</span><span style=color:#75715e></span>  <span style=color:#ae81ff>2</span> <span style=color:#f92672>|</span> <span style=color:#960050;background-color:#1e0010>{</span><span style=color:#ae81ff>2</span>,<span style=color:#ae81ff>2</span><span style=color:#960050;background-color:#1e0010>}</span>

<span style=color:#75715e>-------------------------------------------------------
</span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>默认参数值：</span><span style=color:#66d9ef>DEFAULT</span>

<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>FUNCTION</span> a(x INTEGER <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>1</span>, y INTEGER <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>10</span>, z INTEGER <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>100</span>, <span style=color:#66d9ef>OUT</span> INTEGER) <span style=color:#66d9ef>AS</span> <span style=color:#960050;background-color:#1e0010>$$</span>
<span style=color:#66d9ef>SELECT</span> x <span style=color:#f92672>+</span> y <span style=color:#f92672>+</span> z;
<span style=color:#960050;background-color:#1e0010>$$</span> <span style=color:#66d9ef>LANGUAGE</span> <span style=color:#66d9ef>SQL</span>;

<span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>FUNCTION</span> a( INTEGER, INTEGER, INTEGER );

<span style=color:#66d9ef>SELECT</span> a();
  a
<span style=color:#75715e>-----
</span><span style=color:#75715e></span> <span style=color:#ae81ff>111</span>
<span style=color:#66d9ef>SELECT</span> a(<span style=color:#ae81ff>0</span>);
  a
<span style=color:#75715e>-----
</span><span style=color:#75715e></span> <span style=color:#ae81ff>110</span>
<span style=color:#66d9ef>SELECT</span> a(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>);
  a
<span style=color:#75715e>-----
</span><span style=color:#75715e></span> <span style=color:#ae81ff>100</span>
<span style=color:#66d9ef>SELECT</span> a(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>);
 a
<span style=color:#75715e>---
</span><span style=color:#75715e></span> <span style=color:#ae81ff>0</span>
<span style=color:#66d9ef>SELECT</span> a(z :<span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>);     <span style=color:#960050;background-color:#1e0010>命名参数</span>
 a
<span style=color:#75715e>----
</span><span style=color:#75715e></span> <span style=color:#ae81ff>11</span>

<span style=color:#75715e>-------------------------------------------------------
</span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>可变长参数（数组）：</span>VARIADIC

<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>FUNCTION</span> a(VARIADIC TEXT [], <span style=color:#66d9ef>OUT</span> INTEGER) <span style=color:#66d9ef>AS</span> <span style=color:#960050;background-color:#1e0010>$$</span>
<span style=color:#66d9ef>SELECT</span> array_length(<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>);     <span style=color:#960050;background-color:#1e0010>返回（一维数组的）数组长度</span>
<span style=color:#960050;background-color:#1e0010>$$</span> <span style=color:#66d9ef>LANGUAGE</span> <span style=color:#66d9ef>SQL</span>;

<span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>FUNCTION</span> a( TEXT [] );

<span style=color:#66d9ef>SELECT</span> a(<span style=color:#e6db74>&#39;a&#39;</span>, <span style=color:#e6db74>&#39;b&#39;</span>, <span style=color:#e6db74>&#39;c&#39;</span>);
 a
<span style=color:#75715e>---
</span><span style=color:#75715e></span> <span style=color:#ae81ff>3</span>
<span style=color:#66d9ef>SELECT</span> a(VARIADIC ARRAY [<span style=color:#e6db74>&#39;a&#39;</span>, <span style=color:#e6db74>&#39;b&#39;</span>, <span style=color:#e6db74>&#39;c&#39;</span>]);
 a
<span style=color:#75715e>---
</span><span style=color:#75715e></span> <span style=color:#ae81ff>3</span>
<span style=color:#66d9ef>SELECT</span> a(VARIADIC ARRAY []:: TEXT []);     <span style=color:#960050;background-color:#1e0010>返回</span> <span style=color:#66d9ef>NULL</span>

<span style=color:#75715e>----
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>SELECT</span> generate_subscripts(ARRAY [<span style=color:#e6db74>&#39;a&#39;</span>, <span style=color:#e6db74>&#39;b&#39;</span>, <span style=color:#e6db74>&#39;c&#39;</span>], <span style=color:#ae81ff>1</span>);     <span style=color:#960050;background-color:#1e0010>返回（一维数组的）数组下标</span>
 generate_subscripts
<span style=color:#75715e>---------------------
</span><span style=color:#75715e></span>                   <span style=color:#ae81ff>1</span>
                   <span style=color:#ae81ff>2</span>
                   <span style=color:#ae81ff>3</span>
<span style=color:#960050;background-color:#1e0010>等同于</span>
<span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> generate_subscripts(ARRAY [<span style=color:#e6db74>&#39;a&#39;</span>, <span style=color:#e6db74>&#39;b&#39;</span>, <span style=color:#e6db74>&#39;c&#39;</span>], <span style=color:#ae81ff>1</span>) abc(def);
 def
<span style=color:#75715e>-----
</span><span style=color:#75715e></span>   <span style=color:#ae81ff>1</span>
   <span style=color:#ae81ff>2</span>
   <span style=color:#ae81ff>3</span>

<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>FUNCTION</span> a(VARIADIC ANYARRAY, <span style=color:#66d9ef>OUT</span> ANYELEMENT) <span style=color:#66d9ef>AS</span> <span style=color:#960050;background-color:#1e0010>$$</span>;
<span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>min</span>(<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span> [def]) <span style=color:#66d9ef>FROM</span> generate_subscripts(<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>) abc(def);     <span style=color:#960050;background-color:#1e0010>利用多态和可变长参数求任意数组最小值</span>
<span style=color:#960050;background-color:#1e0010>$$</span> <span style=color:#66d9ef>LANGUAGE</span> <span style=color:#66d9ef>SQL</span>;
Note<span style=color:#960050;background-color:#1e0010>：</span>
<span style=color:#66d9ef>min</span>(<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span> [def]) <span style=color:#960050;background-color:#1e0010>通过数组下标</span> def <span style=color:#960050;background-color:#1e0010>取出数组的所有元素，再通过系统函数</span> <span style=color:#66d9ef>min</span>() <span style=color:#960050;background-color:#1e0010>求出列的最小值。</span>

<span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>FUNCTION</span> a( ANYARRAY );

<span style=color:#66d9ef>SELECT</span> a(<span style=color:#ae81ff>10</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>6</span>);
 a
<span style=color:#75715e>----
</span><span style=color:#75715e></span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
<span style=color:#66d9ef>SELECT</span> a(<span style=color:#e6db74>&#39;a&#39;</span> :: TEXT, <span style=color:#e6db74>&#39;b&#39;</span>, <span style=color:#e6db74>&#39;c&#39;</span>);
 a
<span style=color:#75715e>---
</span><span style=color:#75715e></span> a
</code></pre></div><h3 id=plpgsql程序语言函数>PL/pgSQL（程序语言函数）</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#960050;background-color:#1e0010>块结构：</span>
[ <span style=color:#f92672>&lt;&lt;</span>label<span style=color:#f92672>&gt;&gt;</span> ]
[ <span style=color:#66d9ef>DECLARE</span>
    declarations ]
<span style=color:#66d9ef>BEGIN</span>
    statements
<span style=color:#66d9ef>END</span> [ label ];

<span style=color:#75715e>-------------------------------------------------------
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>FUNCTION</span> a() <span style=color:#66d9ef>RETURNS</span> INTEGER <span style=color:#66d9ef>AS</span> <span style=color:#960050;background-color:#1e0010>$$</span>
<span style=color:#66d9ef>BEGIN</span>
  RAISE NOTICE <span style=color:#e6db74>&#39;% %&#39;</span>, <span style=color:#e6db74>&#39;ABC&#39;</span>, <span style=color:#ae81ff>123</span>;
  <span style=color:#66d9ef>RETURN</span> <span style=color:#ae81ff>1</span>;
<span style=color:#66d9ef>END</span>;
<span style=color:#960050;background-color:#1e0010>$$</span> <span style=color:#66d9ef>LANGUAGE</span> PLPGSQL;

<span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>FUNCTION</span> a();

<span style=color:#66d9ef>SELECT</span> a();
<span style=color:#960050;background-color:#1e0010>注意</span>:  ABC <span style=color:#ae81ff>123</span>
 a
<span style=color:#75715e>---
</span><span style=color:#75715e></span> <span style=color:#ae81ff>1</span>

<span style=color:#75715e>-------------------------------------------------------
</span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>变量作用域</span>

<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>FUNCTION</span> a() <span style=color:#66d9ef>RETURNS</span> INTEGER <span style=color:#66d9ef>AS</span> <span style=color:#960050;background-color:#1e0010>$$</span>
  <span style=color:#f92672>&lt;&lt;</span> abc <span style=color:#f92672>&gt;&gt;</span>
  <span style=color:#66d9ef>DECLARE</span>
  a INTEGER :<span style=color:#f92672>=</span> <span style=color:#ae81ff>30</span>;
<span style=color:#66d9ef>BEGIN</span>
  RAISE NOTICE <span style=color:#e6db74>&#39;Out: a = %&#39;</span>, a;     <span style=color:#ae81ff>30</span>
  a :<span style=color:#f92672>=</span> <span style=color:#ae81ff>50</span>;

    <span style=color:#f92672>&lt;&lt;</span> def <span style=color:#f92672>&gt;&gt;</span>     <span style=color:#960050;background-color:#1e0010>子块开始</span>
    <span style=color:#66d9ef>DECLARE</span>
    a INTEGER :<span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span>;
  <span style=color:#66d9ef>BEGIN</span>
    RAISE NOTICE <span style=color:#e6db74>&#39;In: a = %&#39;</span>, a;     <span style=color:#ae81ff>100</span>
    RAISE NOTICE <span style=color:#e6db74>&#39;In: def.a = %&#39;</span>, def.a;     <span style=color:#ae81ff>100</span>
    RAISE NOTICE <span style=color:#e6db74>&#39;In: abc.a = %&#39;</span>, abc.a;     <span style=color:#ae81ff>50</span>
  <span style=color:#66d9ef>END</span>;     <span style=color:#960050;background-color:#1e0010>子块结束</span>

  RAISE NOTICE <span style=color:#e6db74>&#39;Out: a = %&#39;</span>, a;     <span style=color:#ae81ff>50</span>
  <span style=color:#66d9ef>RETURN</span> a;
<span style=color:#66d9ef>END</span>;
<span style=color:#960050;background-color:#1e0010>$$</span> <span style=color:#66d9ef>LANGUAGE</span> PLPGSQL;

<span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>FUNCTION</span> a();

<span style=color:#66d9ef>SELECT</span> a();
<span style=color:#960050;background-color:#1e0010>注意</span>:  <span style=color:#66d9ef>Out</span>: a <span style=color:#f92672>=</span> <span style=color:#ae81ff>30</span>
<span style=color:#960050;background-color:#1e0010>注意</span>:  <span style=color:#66d9ef>In</span>: a <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span>
<span style=color:#960050;background-color:#1e0010>注意</span>:  <span style=color:#66d9ef>In</span>: def.a <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span>
<span style=color:#960050;background-color:#1e0010>注意</span>:  <span style=color:#66d9ef>In</span>: abc.a <span style=color:#f92672>=</span> <span style=color:#ae81ff>50</span>
<span style=color:#960050;background-color:#1e0010>注意</span>:  <span style=color:#66d9ef>Out</span>: a <span style=color:#f92672>=</span> <span style=color:#ae81ff>50</span>
 a
<span style=color:#75715e>----
</span><span style=color:#75715e></span> <span style=color:#ae81ff>50</span>

<span style=color:#75715e>-------------------------------------------------------
</span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>变量声明：</span>PL<span style=color:#f92672>/</span>pgSQL <span style=color:#960050;background-color:#1e0010>中的变量都需在</span> <span style=color:#66d9ef>DECLARE</span> <span style=color:#960050;background-color:#1e0010>块中声明，声明格式：</span>
name [ CONSTANT ] <span style=color:#66d9ef>type</span> [ <span style=color:#66d9ef>COLLATE</span> <span style=color:#66d9ef>collation_name</span> ] [ <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> ] [ <span style=color:#960050;background-color:#1e0010>{</span> <span style=color:#66d9ef>DEFAULT</span> <span style=color:#f92672>|</span> :<span style=color:#f92672>=</span> <span style=color:#f92672>|</span> <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>}</span> expression ];

<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>FUNCTION</span> a() <span style=color:#66d9ef>RETURNS</span> VOID <span style=color:#66d9ef>AS</span> <span style=color:#960050;background-color:#1e0010>$$</span>
<span style=color:#66d9ef>DECLARE</span>
  a          INTEGER;     <span style=color:#66d9ef>NULL</span>
  b          INTEGER <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>1</span>;     <span style=color:#960050;background-color:#1e0010>初始值（每次进入该块时都将重新赋值（计算））</span>
  <span style=color:#66d9ef>c</span>          INTEGER <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;     <span style=color:#960050;background-color:#1e0010>不能赋值为</span> <span style=color:#66d9ef>NULL</span>
  d          INTEGER <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;     <span style=color:#960050;background-color:#1e0010>变量</span>
  e CONSTANT INTEGER <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>;     <span style=color:#960050;background-color:#1e0010>常量</span>
<span style=color:#66d9ef>BEGIN</span>
  RAISE NOTICE <span style=color:#e6db74>&#39;% % % % %&#39;</span>, a, b, <span style=color:#66d9ef>c</span>, d, e;
<span style=color:#66d9ef>END</span>;
<span style=color:#960050;background-color:#1e0010>$$</span> <span style=color:#66d9ef>LANGUAGE</span> PLPGSQL;

<span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>FUNCTION</span> a();

<span style=color:#66d9ef>SELECT</span> a();
<span style=color:#960050;background-color:#1e0010>注意</span>:  <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>NULL</span><span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>4</span>
 a
<span style=color:#75715e>---
</span><span style=color:#75715e></span>
<span style=color:#75715e>----
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>FUNCTION</span> a() <span style=color:#66d9ef>RETURNS</span> TEXT <span style=color:#66d9ef>AS</span> <span style=color:#960050;background-color:#1e0010>$$</span>
<span style=color:#66d9ef>DECLARE</span>
  a <span style=color:#66d9ef>TIMESTAMP</span> <span style=color:#66d9ef>DEFAULT</span> now();     <span style=color:#960050;background-color:#1e0010>每次调用初始值都不一样</span>
<span style=color:#66d9ef>BEGIN</span>
  <span style=color:#66d9ef>RETURN</span> a;
<span style=color:#66d9ef>END</span>;
<span style=color:#960050;background-color:#1e0010>$$</span> <span style=color:#66d9ef>LANGUAGE</span> PLPGSQL;

<span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>FUNCTION</span> a();

<span style=color:#66d9ef>SELECT</span> a();
             a
<span style=color:#75715e>----------------------------
</span><span style=color:#75715e></span> <span style=color:#ae81ff>2017</span><span style=color:#f92672>-</span><span style=color:#ae81ff>03</span><span style=color:#f92672>-</span><span style=color:#ae81ff>02</span> <span style=color:#ae81ff>15</span>:<span style=color:#ae81ff>15</span>:<span style=color:#ae81ff>27</span>.<span style=color:#ae81ff>452181</span>

<span style=color:#75715e>-------------------------------------------------------
</span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>返回值</span>

<span style=color:#960050;background-color:#1e0010>单条复合类型：</span>
<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>FUNCTION</span> a(INTEGER, INTEGER, <span style=color:#66d9ef>OUT</span> <span style=color:#66d9ef>sum</span> INTEGER, <span style=color:#66d9ef>OUT</span> multiply INTEGER) <span style=color:#66d9ef>AS</span> <span style=color:#960050;background-color:#1e0010>$$</span>
<span style=color:#66d9ef>BEGIN</span>
  <span style=color:#66d9ef>sum</span> <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>+</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>2</span>;
  multiply <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>*</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>2</span>;
<span style=color:#66d9ef>END</span>;
<span style=color:#960050;background-color:#1e0010>$$</span> <span style=color:#66d9ef>LANGUAGE</span> PLPGSQL;

<span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>FUNCTION</span> a( INTEGER, INTEGER );

<span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> a(<span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>10</span>);
<span style=color:#960050;background-color:#1e0010>等同于</span>
<span style=color:#66d9ef>SELECT</span> (a(<span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>10</span>)).<span style=color:#f92672>*</span>;
 <span style=color:#66d9ef>sum</span> <span style=color:#f92672>|</span> multiply
<span style=color:#75715e>-----+----------
</span><span style=color:#75715e></span>  <span style=color:#ae81ff>15</span> <span style=color:#f92672>|</span>       <span style=color:#ae81ff>50</span>

<span style=color:#960050;background-color:#1e0010>多条复合类型：</span>
<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>FUNCTION</span> a() <span style=color:#66d9ef>RETURNS</span> <span style=color:#66d9ef>TABLE</span>(name TEXT, salary NUMERIC) <span style=color:#66d9ef>AS</span> <span style=color:#960050;background-color:#1e0010>$$</span>
<span style=color:#66d9ef>BEGIN</span>
  <span style=color:#66d9ef>RETURN</span> QUERY <span style=color:#66d9ef>SELECT</span> abc.name, abc.salary <span style=color:#66d9ef>FROM</span> a abc;     <span style=color:#960050;background-color:#1e0010>设置别名避免与函数名冲突</span>
<span style=color:#66d9ef>END</span>;
<span style=color:#960050;background-color:#1e0010>$$</span> <span style=color:#66d9ef>LANGUAGE</span> PLPGSQL;

<span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>FUNCTION</span> a();

<span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> a();
 name <span style=color:#f92672>|</span> salary
<span style=color:#75715e>------+--------
</span><span style=color:#75715e></span> <span style=color:#960050;background-color:#1e0010>小张</span> <span style=color:#f92672>|</span> <span style=color:#ae81ff>4999</span>.<span style=color:#ae81ff>9</span>
 <span style=color:#960050;background-color:#1e0010>小陈</span> <span style=color:#f92672>|</span> <span style=color:#ae81ff>3999</span>.<span style=color:#ae81ff>9</span>

<span style=color:#960050;background-color:#1e0010>多态类型：</span>
<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>FUNCTION</span> a(ANYELEMENT, ANYELEMENT, ANYELEMENT, <span style=color:#66d9ef>OUT</span> o ANYELEMENT) <span style=color:#66d9ef>AS</span> <span style=color:#960050;background-color:#1e0010>$$</span>
<span style=color:#66d9ef>BEGIN</span>
  o <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>+</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>2</span> <span style=color:#f92672>+</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>3</span>;
<span style=color:#66d9ef>END</span>;
<span style=color:#960050;background-color:#1e0010>$$</span> <span style=color:#66d9ef>LANGUAGE</span> PLPGSQL;

<span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>FUNCTION</span> a( ANYELEMENT, ANYELEMENT, ANYELEMENT );

<span style=color:#66d9ef>SELECT</span> a(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>);
 a
<span style=color:#75715e>---
</span><span style=color:#75715e></span> <span style=color:#ae81ff>6</span>

<span style=color:#75715e>-------------------------------------------------------
</span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>复制类型：</span><span style=color:#f92672>%</span><span style=color:#66d9ef>TYPE</span><span style=color:#960050;background-color:#1e0010>（基本类型），</span><span style=color:#f92672>%</span>ROWTYPE<span style=color:#960050;background-color:#1e0010>（复合类型）</span>

<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>FUNCTION</span> a(a.age<span style=color:#f92672>%</span><span style=color:#66d9ef>TYPE</span>, <span style=color:#66d9ef>OUT</span> s TEXT) <span style=color:#66d9ef>AS</span> <span style=color:#960050;background-color:#1e0010>$$</span>
<span style=color:#66d9ef>DECLARE</span>
  o a<span style=color:#f92672>%</span>ROWTYPE;
<span style=color:#66d9ef>BEGIN</span>
  <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>INTO</span> o <span style=color:#66d9ef>FROM</span> a <span style=color:#66d9ef>WHERE</span> age <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span>;     <span style=color:#960050;background-color:#1e0010>装入</span> o <span style=color:#960050;background-color:#1e0010>中</span>
  s <span style=color:#f92672>=</span> o.name <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39; &#39;</span> <span style=color:#f92672>||</span> o.age <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39; &#39;</span> <span style=color:#f92672>||</span> o.salary;
<span style=color:#66d9ef>END</span>;
<span style=color:#960050;background-color:#1e0010>$$</span> <span style=color:#66d9ef>LANGUAGE</span> PLPGSQL;

<span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>FUNCTION</span> a( INTEGER );

<span style=color:#66d9ef>SELECT</span> a(<span style=color:#ae81ff>25</span>);
       a
<span style=color:#75715e>----------------
</span><span style=color:#75715e></span> <span style=color:#960050;background-color:#1e0010>小张</span> <span style=color:#ae81ff>25</span> <span style=color:#ae81ff>4999</span>.<span style=color:#ae81ff>9</span>

<span style=color:#960050;background-color:#1e0010>记录类型：</span>
name RECORD;

<span style=color:#75715e>-------------------------------------------------------
</span><span style=color:#75715e></span>PL<span style=color:#f92672>/</span>pgSQL <span style=color:#960050;background-color:#1e0010>语句</span> <span style=color:#e6db74>&#39;IF expression THEN ...&#39;</span> <span style=color:#960050;background-color:#1e0010>执行时，将给主</span> <span style=color:#66d9ef>SQL</span> <span style=color:#960050;background-color:#1e0010>引擎</span>
<span style=color:#960050;background-color:#1e0010>发送一个查询</span> <span style=color:#e6db74>&#39;SELECT expression&#39;&#39; 来计算表达式的返回值。
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>赋值：variable { := | = } expression;
</span><span style=color:#e6db74>若数据类型不匹配，将强制转换；若转换失败，将以文本方式转换，否则发生异常。
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>a = b * 0.06;
</span><span style=color:#e6db74>my_record.user_id = 20;
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>-------------------------------------------------------
</span><span style=color:#e6db74>没有返回值的命令：PERFORM query;
</span><span style=color:#e6db74>执行命令并忽略其返回值，与 SELECT 写法一致，只是将 SELECT 替换为 PERFORM。
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>PERFORM create_mv(&#39;</span>cs_session_page_requests_mv<span style=color:#e6db74>&#39;, my_query);
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>-------------------------------------------------------
</span><span style=color:#e6db74>返回一行结果的命令：INTO target
</span><span style=color:#e6db74>除了 INTO 子句，SQL 语句的其他部分的语法不变。
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>SELECT select_expressions INTO [STRICT] target FROM ...;
</span><span style=color:#e6db74>INSERT ... RETURNING expressions INTO [STRICT] target;
</span><span style=color:#e6db74>UPDATE ... RETURNING expressions INTO [STRICT] target;
</span><span style=color:#e6db74>DELETE ... RETURNING expressions INTO [STRICT] target;
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>无 STRICT：target 为该查询返回的第一个行，无结果则为 NULL。
</span><span style=color:#e6db74>----
</span><span style=color:#e6db74>SELECT * INTO myrec FROM emp WHERE empname = myname;
</span><span style=color:#e6db74>IF NOT FOUND THEN     没有行（try-catch）
</span><span style=color:#e6db74>    RAISE EXCEPTION &#39;</span>employee <span style=color:#f92672>%</span> <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>found</span><span style=color:#e6db74>&#39;, myname;
</span><span style=color:#e6db74>END IF;
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>有 STRICT：该查询必须刚好返回一个行，否则发生异常；成功执行带 STRICT 的命令总是会将 FOUND 置为真。
</span><span style=color:#e6db74>----
</span><span style=color:#e6db74>BEGIN
</span><span style=color:#e6db74>    SELECT * INTO STRICT myrec FROM emp WHERE empname = myname;
</span><span style=color:#e6db74>    EXCEPTION
</span><span style=color:#e6db74>        WHEN NO_DATA_FOUND THEN     没有行（try-catch）
</span><span style=color:#e6db74>            RAISE EXCEPTION &#39;</span>employee <span style=color:#f92672>%</span> <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>found</span><span style=color:#e6db74>&#39;, myname;
</span><span style=color:#e6db74>        WHEN TOO_MANY_ROWS THEN     多于一行（try-catch）
</span><span style=color:#e6db74>            RAISE EXCEPTION &#39;</span>employee <span style=color:#f92672>%</span> <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>unique</span><span style=color:#e6db74>&#39;, myname;
</span><span style=color:#e6db74>END;
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>CREATE OR REPLACE FUNCTION a(INTEGER, OUT r a) AS $$
</span><span style=color:#e6db74>BEGIN
</span><span style=color:#e6db74>  SELECT * INTO STRICT r FROM a WHERE age = $1;
</span><span style=color:#e6db74>  EXCEPTION
</span><span style=color:#e6db74>  WHEN NO_DATA_FOUND
</span><span style=color:#e6db74>    THEN
</span><span style=color:#e6db74>      RAISE EXCEPTION &#39;</span>age <span style=color:#f92672>%</span> <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>found</span><span style=color:#e6db74>&#39;, $1;
</span><span style=color:#e6db74>  WHEN TOO_MANY_ROWS
</span><span style=color:#e6db74>    THEN
</span><span style=color:#e6db74>      RAISE EXCEPTION &#39;</span>age <span style=color:#f92672>%</span> <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>unique</span><span style=color:#e6db74>&#39;, $1;
</span><span style=color:#e6db74>END
</span><span style=color:#e6db74>$$ LANGUAGE PLPGSQL;
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>DROP FUNCTION a( INTEGER );
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>SELECT * FROM a(25);
</span><span style=color:#e6db74> name | age | salary
</span><span style=color:#e6db74>------+-----+--------
</span><span style=color:#e6db74> 小张 |  25 | 4999.9
</span><span style=color:#e6db74>SELECT * FROM a(99);
</span><span style=color:#e6db74>错误:  age 99 not found
</span><span style=color:#e6db74>背景:  在RAISE的第10行的PL/pgSQL函数a(integer)
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>-------------------------------------------------------
</span><span style=color:#e6db74>占位语句（什么也不做）：NULL;
</span><span style=color:#e6db74>能够指示 if/then/else 链中故意留出的空分支。
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>CREATE OR REPLACE FUNCTION a() RETURNS VOID AS $$
</span><span style=color:#e6db74>DECLARE
</span><span style=color:#e6db74>  x INTEGER = 1;
</span><span style=color:#e6db74>  y INTEGER;
</span><span style=color:#e6db74>BEGIN
</span><span style=color:#e6db74>  y = x / 0;
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>  EXCEPTION
</span><span style=color:#e6db74>  WHEN division_by_zero
</span><span style=color:#e6db74>    THEN     忽略异常
</span><span style=color:#e6db74>  等同于
</span><span style=color:#e6db74>  EXCEPTION
</span><span style=color:#e6db74>  WHEN division_by_zero
</span><span style=color:#e6db74>    THEN
</span><span style=color:#e6db74>      NULL;     忽略异常（更直观）
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>END;
</span><span style=color:#e6db74>$$ LANGUAGE PLPGSQL;
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>DROP FUNCTION a();
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>SELECT a();
</span></code></pre></div><hr><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>EXPLAIN</span> <span style=color:#66d9ef>ANALYZE</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> customer; <span style=color:#75715e>--显示语句的执行计划
</span></code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> account DISABLE <span style=color:#66d9ef>TRIGGER</span> <span style=color:#66d9ef>ALL</span>; <span style=color:#75715e>--禁用外键约束
</span><span style=color:#75715e></span><span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> account ENABLE  <span style=color:#66d9ef>TRIGGER</span> <span style=color:#66d9ef>ALL</span>; <span style=color:#75715e>--启用外键约束
</span></code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> pg_available_extension_versions; <span style=color:#75715e>--查询可加载插件
</span><span style=color:#75715e></span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> pg_extension; <span style=color:#75715e>--查询已加载插件
</span></code></pre></div><h2 id=tool>Tool</h2><ul><li><a href=https://www.postgresql.org/ftp/pgadmin/pgadmin4/>https://www.postgresql.org/ftp/pgadmin/pgadmin4/</a></li><li><a href=https://github.com/sosedoff/pgweb/releases/latest>https://github.com/sosedoff/pgweb/releases/latest</a></li><li><a href=https://github.com/dbcli/pgcli>https://github.com/dbcli/pgcli</a></li><li><a href=https://www.heidisql.com/download.php>https://www.heidisql.com/download.php</a></li><li><a href=https://www.jetbrains.com/datagrip/>https://www.jetbrains.com/datagrip/</a></li></ul></div><div class=sharing style=text-align:center><br><p>捐赠支持</p><p>如果我的文章对你有所帮助，欢迎通过支付宝的扫一扫，轻松的向我发起捐助。</p><p>对于你的支持，我会心怀感激且倍感荣幸地接受，并继续努力。</p><img src=https://ww4.sinaimg.cn/large/a15b4afegw1fbn096ql6dj20dw0dwwe9.jpg alt title data-action=zoom width=40%><p></p><br>&copy; 2015-2020 XhstormR</div></div></div></div><div id=backtop><a href=# title>TOP</a></div><nav id=TableOfContents><ul><li><a href=#concept>Concept</a></li><li><a href=#initial>Initial</a></li><li><a href=#operate>Operate</a></li><li><a href=#table>Table</a><ul><li><a href=#create>Create</a></li><li><a href=#alter>Alter</a></li></ul></li><li><a href=#schema>Schema</a></li><li><a href=#inherit>Inherit</a></li><li><a href=#partition>Partition</a></li><li><a href=#function>Function</a><ul><li><a href=#sql查询语言函数>SQL（查询语言函数）</a></li><li><a href=#plpgsql程序语言函数>PL/pgSQL（程序语言函数）</a></li></ul></li><li><a href=#tool>Tool</a></li></ul></nav><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/languages/yaml.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/languages/kotlin.min.js></script><script>hljs.initHighlightingOnLoad()</script><script src=https://blog.xhstormr.tk/js/zoom.min.js></script><script>window.addEventListener("load",show),window.onscroll=show;function show(){document.documentElement.scrollTop+document.body.scrollTop>300?document.getElementById("backtop").style.display="block":document.getElementById("backtop").style.display="none"}</script><script type=text/javascript color=0,0,0 opacity=1 zindex=-2 count=49 src=https://cdnjs.cloudflare.com/ajax/libs/canvas-nest.js/2.0.4/canvas-nest.js></script></body></html>